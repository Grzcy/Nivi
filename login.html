<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nuvia - Login</title>
    
    <!-- Google Fonts: Poppins for headings, Inter for body text -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Global CSS Variables matching the attached hero image (pink & yellow) */
        :root {
            --pink: #ff2e63; /* vivid magenta pink from image */
            --blue: #ffd400; /* repurposed as accent yellow */
            --glass-black: rgba(10, 10, 10, .12);
            --glass-blue: rgba(255, 212, 0, .08);
            --radius: 22px;
            --transition: .28s ease;
            --white: #ffffff;
            --text-light: rgba(255, 255, 255, .85);
            --background-main: rgba(255, 46, 99, .06);
            --background-gradient-1: var(--pink);
            --background-gradient-2: var(--blue);
            --card-background: linear-gradient(180deg, #0f172a 0%, #0a0f1a 100%);
            --header-background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.0));
            --border-light: rgba(255, 212, 0, .18);
            --input-background: #111827;
            --button-background: linear-gradient(90deg, var(--pink), #ff8a00);
            --button-shadow: 0 18px 30px rgba(255,46,99,0.22), 0 10px 24px rgba(255,138,0,0.14);

            /* Additional variables for consistency */
            --background-color-primary: #0d1b2a;
            --background-color-secondary: #000000;
            --text-color-primary: #e5f0ff; /* light text */
            --text-color-secondary: #9fb3c8;
        }

        body {
            font-family: 'Poppins', 'Inter', 'Segoe UI', sans-serif;
            /* strong pink -> yellow diagonal gradient with subtle grid overlay like the screenshot */
            background:
                radial-gradient(circle at top, rgba(255,255,255,0.03), transparent 120px),
                repeating-linear-gradient(0deg, rgba(255,255,255,0.03) 0px, rgba(255,255,255,0.03) 2px, transparent 2px, transparent 28px),
                linear-gradient(180deg, var(--background-color-primary) 0%, var(--background-color-secondary) 100%);
            background-attachment: fixed;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: var(--text-color-primary);
            overflow-x: hidden;
        }

        .login-container {
            background: linear-gradient(180deg, #0f172a 0%, #0a0f1a 100%); /* dark blue outer frame */
            border-radius: 28px;
            padding: 18px; /* create outer padded frame */
            box-shadow: 0 18px 40px rgba(255,46,99,0.12);
            overflow: visible;
            width: 100%;
            max-width: 560px;
            position: relative;
            transition: all var(--transition);
        }
        .login-container .login-form {
            background: #0b1220;
            border-radius: 18px;
            padding: 28px 22px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.06);
        }

        .login-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--card-background);
            z-index: -1;
        }

        .login-container:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 
                0 4px 25px var(--blue), 
                0 4px 25px var(--pink),
                0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .login-header {
            background: var(--header-background);
            color: var(--white);
            text-align: center;
            padding: 40px 20px 30px;
            position: relative;
            overflow: hidden;
        }

        .login-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 46, 146, 0.1), transparent);
            animation: headerShimmer 3s ease-in-out infinite;
        }

        @keyframes headerShimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .jchat-title {
            font-family: 'Poppins', sans-serif;
            font-size: 56px;
            line-height: 0.95;
            font-weight: 900;
            margin-bottom: 10px;
            background: linear-gradient(90deg, var(--pink) 10%, #ff874d 50%, var(--blue) 90%);
            background-size: 200% 100%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 0.6px;
            position: relative;
            z-index: 2;
            text-align: center;
            filter: drop-shadow(0 12px 18px rgba(255,46,99,0.35));
            text-shadow: 0 6px 12px rgba(255,138,0,0.08);
        }

        @keyframes geminiTitleShimmer {
            0%, 100% { 
                background-position: 0% 50%;
                filter: drop-shadow(0 4px 8px rgba(255, 46, 146, 0.3)) 
                        drop-shadow(0 0 20px rgba(0, 213, 255, 0.4));
            }
            50% { 
                background-position: 100% 50%;
                filter: drop-shadow(0 6px 12px rgba(0, 213, 255, 0.5)) 
                        drop-shadow(0 0 30px rgba(255, 46, 146, 0.6));
            }
        }

        .login-header h1 {
            font-size: 24px;
            font-weight: 300;
            margin-bottom: 10px;
            position: relative;
            z-index: 2;
        }

        .login-header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .login-form {
            padding: 40px 36px;
        }

        .form-group {
            margin-bottom: 25px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            background: linear-gradient(90deg, var(--blue), var(--pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 600;
            font-size: 14px;
            font-family: 'Poppins', sans-serif;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .form-group input {
            width: 100%;
            padding: 18px 56px 18px 20px; /* room for password toggle */
            border: 1px solid var(--border-light);
            border-radius: var(--radius);
            font-size: 18px;
            font-family: 'Inter', sans-serif;
            transition: all var(--transition);
            background: var(--input-background);
            backdrop-filter: blur(10px);
            color: var(--white);
            position: relative;
        }

        /* Ensure password toggle sits above the input and is easily tappable */
        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            font-size: 16px;
            padding: 8px;
            z-index: 6;
            pointer-events: auto;
            touch-action: manipulation;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }

        .password-toggle svg.inline-icon { display:block; width:1em; height:1em; }

        .form-group input:focus {
            outline: none;
            border-color: var(--pink);
            background: rgba(255, 255, 255, 0.1);
            box-shadow: var(--button-shadow);
            transform: translateY(-2px);
        }

        .form-group input:hover {
            border-color: var(--blue);
            background: rgba(255, 255, 255, 0.08);
        }

        .form-group input::placeholder {
            color: var(--text-light);
        }

        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            font-size: 14px;
            margin-top: 16px;
        }

        .remember-forgot {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .remember-me {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .remember-me input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .forgot-password {
            color: #667eea;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .forgot-password:hover {
            color: #764ba2;
        }

        .login-btn {
            width: 100%;
            background: linear-gradient(90deg, var(--pink) 0%, #ff874d 60%, var(--blue) 100%);
            color: #fff;
            border: 4px solid rgba(255,255,255,0.85);
            padding: 20px 32px;
            border-radius: 40px;
            font-size: 18px;
            font-weight: 700;
            font-family: 'Poppins', sans-serif;
            cursor: pointer;
            transition: all var(--transition);
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            text-transform: none;
            letter-spacing: 0.6px;
            box-shadow: 0 18px 40px rgba(255,46,99,0.18), 0 8px 30px rgba(255,212,0,0.12);
            text-align: center;
        }

        .login-btn::before {
            content: '';
            position: absolute;
            top: -6px;
            left: 0;
            right: 0;
            height: 6px;
            background: rgba(255,255,255,0.25);
            opacity: 0.6;
        }

        .login-btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 26px 50px rgba(255,46,99,0.22), 0 12px 36px rgba(255,212,0,0.14);
            filter: brightness(1.02);
        }

        .login-btn:active {
            transform: translateY(-2px);
            filter: brightness(0.98);
        }

        .divider {
            text-align: center;
            margin: 30px 0;
            position: relative;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-light);
        }

        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--border-light), transparent);
            z-index: 1;
        }

        .divider span {
            background: var(--background-main);
            padding: 8px 20px;
            position: relative;
            z-index: 2;
            border-radius: var(--radius);
            background: linear-gradient(90deg, var(--blue), var(--pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 600;
            font-family: 'Poppins', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        
        
        
        


        @keyframes loadingPulse {
            0%, 100% { 
                box-shadow: 
                    0 0 25px var(--pink),
                    0 0 50px var(--blue);
            }
            50% { 
                box-shadow: 
                    0 0 35px var(--pink),
                    0 0 70px var(--blue);
            }
        }





        .signup-link {
            text-align: center;
            color: var(--text-light);
            font-size: 14px;
            font-weight: 500;
            font-family: 'Inter', sans-serif;
        }

        .signup-link a {
            background: linear-gradient(90deg, var(--blue), var(--pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-decoration: none;
            font-weight: 700;
            position: relative;
            transition: all var(--transition);
        }

        .signup-link a:hover {
            background: linear-gradient(90deg, var(--pink), var(--blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            transform: scale(1.05);
        }

        .remember-me {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            color: var(--text-light);
            font-family: 'Inter', sans-serif;
        }

        .forgot-password {
            background: linear-gradient(90deg, var(--blue), var(--pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-decoration: none;
            font-weight: 600;
            transition: all var(--transition);
            font-family: 'Inter', sans-serif;
        }

        .forgot-password:hover {
            background: linear-gradient(90deg, var(--pink), var(--blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            transform: scale(1.05);
        }
        .password-strength { margin-top: 8px; }
        .strength-bar { height: 6px; border-radius: 6px; background: rgba(255,255,255,0.12); position: relative; overflow: hidden; }
        .strength-bar::after { content: ''; position: absolute; left: 0; top: 0; height: 100%; width: 0%; background: linear-gradient(90deg, var(--pink), var(--blue)); transition: width var(--transition); }
        .strength-bar.level-1::after { width: 25%; }
        .strength-bar.level-2::after { width: 50%; }
        .strength-bar.level-3::after { width: 75%; }
        .strength-bar.level-4::after { width: 100%; }
        .strength-text { margin-top: 6px; font-size: 12px; color: var(--text-light); }

        .error-message {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(249, 115, 22, 0.1) 100%);
            border: 2px solid rgba(239, 68, 68, 0.3);
            color: #dc2626;
            padding: 14px 18px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 14px;
            font-weight: 500;
            display: none;
            backdrop-filter: blur(10px);
            position: relative;
        }

        .error-message::before {
            content: '⚠';
            margin-right: 8px;
            font-size: 16px;
        }

        /* Signup mode styles */
        .login-container.signup-mode .login-header {
            background: var(--header-background);
            animation: none;
        }

        @keyframes geminiSignupGradient {
            0% { background-position: 0% 50%; }
            33% { background-position: 100% 0%; }
            66% { background-position: 0% 100%; }
            100% { background-position: 0% 50%; }
        }

        .login-container.signup-mode .login-btn {
            background: linear-gradient(135deg, #06b6d4 0%, #8b5cf6 50%, #ec4899 100%);
            background-size: 200% 200%;
            animation: geminiSignupButtonGradient 6s ease infinite;
        }

        @keyframes geminiSignupButtonGradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .login-container.signup-mode .login-btn:hover {
            box-shadow: 
                0 15px 35px rgba(6, 182, 212, 0.3),
                0 5px 15px rgba(139, 92, 246, 0.2),
                0 0 30px rgba(236, 72, 153, 0.2);
        }

        /* Loading state */
        .login-btn:disabled {
            cursor: not-allowed;
            transform: none !important;
        }

        /* Success message styling */
        .error-message.success {
            background: linear-gradient(135deg, #10b981 0%, #06b6d4 100%);
            color: white;
            border: none;
        }

        /* Smart Loader Styles matching your pages */
        .smart-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(10, 10, 10, 0.95), rgba(20, 20, 30, 0.95));
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loader-content {
            background: var(--card-background);
            border: 1px solid var(--border-light);
            border-radius: var(--radius);
            padding: 40px;
            text-align: center;
            position: relative;
            backdrop-filter: blur(20px);
        }

        .gemini-spinner {
            width: 80px;
            height: 80px;
            border: 4px solid transparent;
            border-radius: 50%;
            position: relative;
            margin: 0 auto 20px;
            animation: spin 2s linear infinite;
        }

        .gemini-spinner::before {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            border: 4px solid transparent;
            border-top: 4px solid var(--pink);
            border-right: 4px solid var(--blue);
            border-radius: 50%;
            animation: spin 1.5s linear infinite reverse;
            filter: drop-shadow(0 0 20px var(--pink)) drop-shadow(0 0 20px var(--blue));
        }

        .gemini-spinner::after {
            content: '';
            position: absolute;
            top: 8px;
            left: 8px;
            right: 8px;
            bottom: 8px;
            border: 3px solid transparent;
            border-bottom: 3px solid var(--pink);
            border-left: 3px solid var(--blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            filter: drop-shadow(0 0 15px var(--pink)) drop-shadow(0 0 15px var(--blue));
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loader-text {
            color: var(--white);
            font-size: 18px;
            font-weight: 600;
            font-family: 'Poppins', sans-serif;
            margin-bottom: 10px;
            background: linear-gradient(90deg, var(--pink), var(--blue), var(--pink));
            background-size: 200% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shimmerText 2s ease-in-out infinite;
        }

        @keyframes shimmerText {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .loader-subtext {
            color: var(--text-light);
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            opacity: 0.7;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }

        /* Custom Modal Styles */
        .custom-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            position: relative;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-50px) scale(0.9); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }

        .modal-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .modal-icon.success {
            background: linear-gradient(135deg, #10b981 0%, #06b6d4 100%);
            color: white;
        }

        .modal-icon.error {
            background: linear-gradient(135deg, #ef4444 0%, #f97316 100%);
            color: white;
        }

        .modal-icon.info {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            color: white;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #ec4899 0%, #4f46e5 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .modal-message {
            color: #6b7280;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-btn.primary {
            background: linear-gradient(135deg, #ec4899 0%, #4f46e5 100%);
            color: white;
        }

        .modal-btn.secondary {
            background: #f3f4f6;
            color: #6b7280;
        }

        .modal-btn:hover {
            transform: translateY(-1px);
        }

        /* Signup form enhancements */
        .signup-only {
            transition: all 0.3s ease;
        }

        .username-feedback {
            font-size: 12px;
            margin-top: 5px;
            padding: 5px 10px;
            border-radius: 5px;
            display: none;
        }

        .username-feedback.available {
            background: linear-gradient(135deg, #10b981 0%, #06b6d4 100%);
            color: white;
            display: block;
        }

        .username-feedback.taken {
            background: linear-gradient(135deg, #ef4444 0%, #f97316 100%);
            color: white;
            display: block;
        }

        .username-feedback.checking {
            background: linear-gradient(135deg, #f59e0b 0%, #eab308 100%);
            color: white;
            display: block;
        }

        /* Enhanced textarea styling */
        textarea:focus {
            outline: none !important;
            border-color: #ec4899 !important;
            background: rgba(255, 255, 255, 0.95) !important;
            box-shadow: 
                0 0 0 4px rgba(236, 72, 153, 0.1) !important,
                0 8px 25px rgba(79, 70, 229, 0.15) !important;
            transform: translateY(-2px) !important;
        }

        /* Floating particles */
        .floating-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            opacity: 0.6;
            animation: float 8s linear infinite;
        }

        .particle.pink {
            background: var(--pink);
            box-shadow: 0 0 15px var(--pink);
        }

        .particle.blue {
            background: var(--blue);
            box-shadow: 0 0 15px var(--blue);
        }

        .particle.cyan {
            background: var(--blue);
            box-shadow: 0 0 15px var(--blue);
        }

        @keyframes float {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 0.6;
            }
            90% {
                opacity: 0.6;
            }
            100% {
                transform: translateY(-10vh) rotate(360deg);
                opacity: 0;
            }
        }

        /* Gemini-style input focus glow */
        .form-group input:focus,
        textarea:focus {
            position: relative;
        }

        .form-group input:focus::after,
        textarea:focus::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(135deg, #ec4899, #4f46e5, #06b6d4);
            border-radius: 14px;
            z-index: -1;
            opacity: 0.3;
            animation: inputGlow 2s ease infinite;
        }

        @keyframes inputGlow {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.6; }
        }

        /* Smart validation states */
        .form-group.valid input {
            border-color: var(--blue);
            box-shadow: 0 0 0 2px rgba(0, 213, 255, 0.2);
        }

        .form-group.invalid input {
            border-color: #ef4444;
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2);
        }

        .form-group.valid::after {
            content: '✓';
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--blue);
            font-weight: bold;
            font-size: 16px;
            margin-top: 16px;
        }

        /* Performance optimizations */
        * {
            will-change: auto;
        }

        .login-container,
        .login-btn,
        .form-group input {
            will-change: transform, box-shadow;
        }

        /* Smooth animations with hardware acceleration */
        .login-container,
        .login-btn,
        .form-group {
            transform: translateZ(0);
            backface-visibility: hidden;
        }

        @media (max-width: 480px) {
            .login-container {
                margin: 10px;
            }
            
            .login-form {
                padding: 30px 20px;
            }
            
            .login-header {
                padding: 30px 20px 25px;
            }
        }
            /* OAuth section modern styles */
        .oauth-section { display: flex; gap: 12px; margin-top: 10px; }
        .oauth-btn { flex: 1; display: inline-flex; align-items: center; justify-content: center; gap: 10px; padding: 12px 16px; border-radius: var(--radius); border: 1px solid var(--border-light); background: var(--input-background); color: var(--white); cursor: pointer; transition: all var(--transition); }
        .oauth-btn:hover { transform: translateY(-2px); box-shadow: var(--button-shadow); }
        .oauth-btn .oauth-icon { width: 18px; height: 18px; display: inline-flex; align-items: center; justify-content: center; font-weight: 700; }
        .oauth-btn.google { background: #ffffff; color: #1f2937; border: 1px solid rgba(0,0,0,0.08); }
        .oauth-btn.google:hover { box-shadow: 0 8px 24px rgba(0,0,0,0.12); }
.remember-actions { display: flex; gap: 12px; align-items: center; }
        .caps-warning { display: none; color: #ef4444; font-size: 12px; margin-top: 6px; }
        </style>
    <style>
        /* Readability fixes: inputs should be warm cream with dark text and visible caret */
        .form-group input,
        textarea,
        .modal-field {
            background: linear-gradient(180deg,#0e1624 0%, #0a0f1a 100%);
            color: #e5f0ff; /* light text */
            border: 1px solid rgba(59,130,246,0.25);
            caret-color: #60a5fa;
        }

        .form-group input::placeholder,
        textarea::placeholder,
        .modal-field::placeholder {
            color: rgba(159,179,200,0.75);
        }

        /* Make header tone warm and soft on the eyes */
        .login-header {
            color: #e5f0ff !important;
            background: linear-gradient(180deg, rgba(0,0,0,0.0), rgba(0,0,0,0.0));
        }

        /* Slightly reduce harsh white highlights around inputs */
        .form-group input:focus,
        textarea:focus,
        .modal-field:focus {
            box-shadow: 0 0 0 6px rgba(59,130,246,0.20);
            border-color: #60a5fa;
        }
    </style>
    <style id="accessibility-overrides">
        :focus { outline: none; }
        .jchat-title { background: linear-gradient(90deg, var(--pink), #ffd400); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        input:focus-visible, textarea:focus-visible, button:focus-visible, a:focus-visible { outline: 3px solid rgba(255, 46, 146, 0.25); outline-offset: 3px; border-radius: 8px; }
        .password-toggle { display: inline-flex; align-items:center; justify-content:center; }
        /* Reduce heavy animations on small screens */
        @media (max-width: 720px) { .jchat-title, .login-header::before, .gemini-spinner, .login-container { animation: none !important; transform: none !important; } }
        @media (prefers-reduced-motion: reduce) { * { animation: none !important; transition: none !important; } }
    </style>
<style>
/* Signup layout enhancements */
.login-container.signup-mode { max-width: 640px; }
@media (min-width: 768px) {
  .login-container.signup-mode { max-width: 720px; }
  .login-form .signup-only { display: inline-block; width: calc(50% - 10px); vertical-align: top; }
  .login-form .signup-only:nth-child(odd) { margin-right: 10px; }
  .optional-details .signup-only { display: block; width: 100%; margin-right: 0; }
}
.optional-details { border: 1px solid var(--border-light); border-radius: var(--radius); background: var(--card-background); padding: 8px 12px; margin: 10px 0 0; }
.optional-summary { cursor: pointer; font-weight: 600; color: var(--white); list-style: none; }
.optional-summary::-webkit-details-marker { display: none; }
.optional-details-content { margin-top: 10px; }
</style>
<style>
/* Create Account button color (black & gold) only in signup mode */
.login-container.signup-mode .login-btn {
  background: linear-gradient(90deg, #000000, #d4af37);
  color: #ffffff;
  border-color: rgba(255,255,255,0.85);
}
.login-container.signup-mode .login-btn:hover { filter: brightness(1.02); }
</style>
<style>
/* Attempts/lockout responsive banner */
.attempts-banner { display:none; border:1px solid var(--border-light); border-radius: var(--radius); background: var(--card-background); padding: 12px 14px; margin: 10px 0; color: var(--white); }
.attempts-banner.show { display:block; }
.attempts-banner .title { font-weight: 800; margin: 0 0 6px 0; }
.attempts-banner .desc { font-size: 0.92rem; color: var(--text-light); }
.attempts-banner.error { border-color: rgba(239,68,68,0.35); }
.attempts-banner.warn { border-color: rgba(234,179,8,0.35); }
</style>
</head>
<body>
    <!-- Floating Particles -->
    <div class="floating-particles" id="floatingParticles"></div>

    <style>
      /* Auth layout wrapper and spacing improvements */
      .auth-hero{max-width:1200px;margin:18px auto;padding:0 14px;}
      @media(min-width:900px){
        .auth-hero{display:grid;grid-template-columns:560px 1fr;gap:28px;align-items:start;}
        .login-container{max-width:560px;}
      }
      /* Larger form controls for better touch and visual weight */
      .login-form{padding:40px 36px;}
      .form-group input{padding:18px 56px 18px 20px;font-size:18px}
      .login-btn{padding:20px 32px;border-radius:48px;font-size:20px}
    </style>
    <div class="auth-hero">
    <div class="login-container">
        <div class="login-header">
            <div class="jchat-title">Nuvia</div>
            <h1 id="loginHeading">Welcome to Nuvia</h1>
            <p>Join a vibrant community — share your best moments, chat with friends, and earn rewards. Sign in or create an account to get started.</p>
            <style>
              .hero-highlights{display:flex;gap:12px;justify-content:center;margin-top:14px;flex-wrap:wrap}
              .hero-chip{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:999px;font-weight:600;color:var(--text-light);font-size:13px}
            </style>
            <div class="hero-highlights" aria-hidden="false">
              <div class="hero-chip">Trending posts & highlights</div>
              <div class="hero-chip">Secure chat & low-latency calls</div>
              <div class="hero-chip">Earn JCoins & level up</div>
            </div>
        </div>
        
        <form class="login-form" id="loginForm" role="form" aria-labelledby="loginHeading" aria-describedby="errorMessage">
            <div id="attemptsBanner" class="attempts-banner" role="status" aria-live="polite" aria-atomic="true" style="display:none">
                <div class="title">Sign-in protection</div>
                <div class="desc" id="attemptsBannerText">Please try again.</div>
            </div>
            <div class="error-message" id="errorMessage" role="alert" aria-live="assertive" aria-atomic="true" aria-hidden="true" tabindex="-1">
                Something went wrong. Please check your email and password, or reset your password if you've forgotten it.
            </div>

            <!-- Signup-only fields -->
            <div class="form-group signup-only" style="display: none;">
                <label for="fullName">Full Name</label>
                <input 
                    type="text" 
                    id="fullName" 
                    name="fullName" 
                    placeholder="Enter your full name"
                >
            </div>

            <div class="form-group signup-only" style="display: none;">
                <label for="username">Username</label>
                <input 
                    type="text" 
                    id="username" 
                    name="username" 
                    placeholder="Choose a unique username"
                >
                <div class="username-feedback" id="usernameFeedback" role="status" aria-live="polite" aria-atomic="true"></div>
            </div>

            <div class="form-group">
                <label for="email">Email Address</label>
                <input 
                    type="email" 
                    id="email" 
                    name="email" 
                    placeholder="Enter your email"
                    required
                >
            </div>
            
            <div class="form-group">
                <label for="password">Password</label>
                <input 
                    type="password" 
                    id="password" 
                    name="password" 
                    placeholder="Enter your password"
                    required
                >
                <button type="button" class="password-toggle" id="passwordToggle" aria-pressed="false" aria-label="Show password" aria-controls="password" onclick="togglePassword()">
                    <i id="passwordToggleIcon" class="fas fa-eye" aria-hidden="true"></i>
                </button>
                <div id="capsWarning" class="caps-warning">Caps Lock is ON</div>
            </div>

            <!-- Signup-only fields continued -->
            <div class="form-group signup-only" style="display: none;">
                <label for="confirmPassword">Confirm Password</label>
                <input 
                    type="password" 
                    id="confirmPassword" 
                    name="confirmPassword" 
                    placeholder="Confirm your password"
                >
            </div>

        <details class="optional-details signup-only" style="display: none;">
          <summary class="optional-summary" aria-controls="optionalDetailsContent" aria-expanded="false">Optional details</summary>
          <div id="optionalDetailsContent" class="optional-details-content">


            <!-- Referral (Optional) -->
            <div class="form-group signup-only" style="display: none;">
                <label for="referralLinkInput">Referral link or ID (Optional)</label>
                <input
                    type="text"
                    id="referralLinkInput"
                    name="referralLinkInput"
                    placeholder="Paste your friend's referral link or ID"
                >
            </div>
          </div>
        </details>

            <div class="remember-forgot">
                <div class="remember-actions">
                    <a href="#" class="forgot-password" onclick="showResetPasswordModal()">Forgot password?</a>
                </div>
            </div>

            <button type="submit" class="login-btn">
                Sign In
            </button>


            <div class="signup-link">
                <span id="signup-link-text">New here? <a href="#" onclick="goToSignup()">Create a free account</a> — it only takes a minute.</span>
                <div id="admin-only-notice" style="display: none; font-size: 0.9rem; color: var(--text-light); margin-top: 0.5rem;">
                    📧 Account creation may be invite-only. Contact an administrator for access.
                </div>
            </div>

            <!-- APK Download (styled pink → yellow gradient) -->
            <style>
                .apk-download-link {
                    background: linear-gradient(90deg, var(--pink, #ff2e92), #ffd400);
                    -webkit-background-clip: text;
                    background-clip: text;
                    -webkit-text-fill-color: transparent;
                    color: transparent;
                    font-weight: 800;
                    text-decoration: none;
                    display: inline-block;
                    padding: 8px 14px;
                    border-radius: 999px;
                    border: 1px solid rgba(255,255,255,0.06);
                    box-shadow: 0 8px 24px rgba(0,0,0,0.18);
                    transition: transform 0.18s ease, filter 0.18s ease;
                }
                .apk-download-link:hover { transform: translateY(-2px); filter: brightness(1.04); }
                .apk-download-container { text-align: center; margin-top: 12px; }
                .apk-panel { padding-top: 28px; }
                .apk-progress { height: 6px; background: #f3f4f6; border-radius: 999px; overflow: hidden; margin: 12px 0 20px; }
                .apk-progress-bar { display: block; height: 100%; width: 40%; background: linear-gradient(135deg, #ec4899 0%, #4f46e5 100%); animation: apkBar 1.2s linear infinite; border-radius: inherit; }
                @keyframes apkBar { 0% { transform: translateX(-100%);} 100% { transform: translateX(250%);} }
            </style>

            <div class="apk-download-container">
                <a id="downloadApkBtn" href="https://cdn.builder.io/o/assets%2Fe31045e1ed6a4b62bf8c3bdf9b813be8%2F35437802d15d4c2a943abac97dff31a5?alt=media&token=bd75c002-3803-41c3-aaaf-2cd460179a8d&apiKey=e31045e1ed6a4b62bf8c3bdf9b813be8" class="apk-download-link" target="_blank" rel="noopener noreferrer" aria-label="Download Nuvia APK">Download Nuvia APK</a>
            </div>

        </form>
    </div>

    <!-- Platform Info Section -->
    <section class="info-section" aria-label="About Nuvia">
      <style>
        .info-section{max-width:1100px;margin:28px auto 64px;padding:18px 22px;background:linear-gradient(180deg,rgba(11,18,32,0.85),rgba(10,12,20,0.92));border:1px solid rgba(255,255,255,0.03);border-radius:20px;color:var(--text-light);max-height:calc(72vh);overflow:auto;-webkit-overflow-scrolling:touch}
        .info-grid{display:grid;grid-template-columns:1fr;gap:18px;align-items:start}
        @media(min-width:900px){.info-grid{grid-template-columns:360px 1fr}}
        .info-card{background:var(--card-background);border-radius:14px;padding:16px;border:1px solid var(--border-light);box-shadow:0 6px 18px rgba(0,0,0,0.25);max-height:calc(72vh - 80px);overflow:auto}
        .info-card h3{margin:0 0 8px;font-family:'Poppins',sans-serif;font-size:18px;color:var(--white)}
        .info-card p{margin:0;color:var(--text-light);line-height:1.45}
        .info-accordion details{background:transparent;border-radius:12px;padding:10px;margin-bottom:8px;border:1px solid rgba(255,255,255,0.03)}
        .info-accordion summary{cursor:pointer;font-weight:700;color:var(--white);font-family:'Poppins',sans-serif;padding:4px}
        .info-accordion summary::-webkit-details-marker{display:none}
        .info-accordion .detail-body{margin-top:8px;color:var(--text-light)}
        .info-links{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
        .info-link{padding:8px 12px;border-radius:999px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);color:var(--text-light);text-decoration:none;font-weight:600}
        .info-cta{display:flex;gap:10px;align-items:center;margin-top:12px}
        .info-cta .btn{padding:10px 16px;border-radius:12px;border:0;cursor:pointer;font-weight:700}
        .btn-primary{background:linear-gradient(90deg,var(--pink),var(--blue));color:#fff;box-shadow:var(--button-shadow)}
        .btn-secondary{background:transparent;border:1px solid var(--border-light;color:var(--text-light);color:var(--text-light)}
        /* Custom scrollbar for the info-section */
        .info-section::-webkit-scrollbar, .info-card::-webkit-scrollbar{height:10px;width:10px}
        .info-section::-webkit-scrollbar-thumb, .info-card::-webkit-scrollbar-thumb{background:linear-gradient(90deg,var(--pink),var(--blue));border-radius:999px}
        .info-section::-webkit-scrollbar-track, .info-card::-webkit-scrollbar-track{background:transparent}
      </style>

      <div class="info-grid">
        <aside class="info-card">
          <h3>Create, Connect, Be Rewarded</h3>
          <p>Jump into a friendly, creative community built for real conversations and meaningful moments. On Nuvia you can share posts, meet new people, and earn rewards for activity — all in a secure space designed to help your voice grow.</p>

          <div style="margin-top:12px">
            <div style="font-weight:700;color:var(--white);margin-bottom:6px">Why people join</div>
            <ul style="margin:0 0 0 18px;color:var(--text-light);line-height:1.6">
              <li>Create content that others discover and save — build your highlights.</li>
              <li>Private and group conversations with voice notes and low-latency calls.</li>
              <li>Earn JCoins and level up for extra perks and visibility.</li>
              <li>Safe, moderated community with clear guidelines and helpful tools.</li>
            </ul>
          </div>

          <div class="info-links">
            <a class="info-link" href="/explore.html">Explore trending posts</a>
            <a class="info-link" href="/chat.html">Preview chat</a>
            <a class="info-link" href="/profile.html">See profiles & rewards</a>
            <a class="info-link" href="/community_guidelines.html">Community Guidelines</a>
          </div>
        </aside>

        <div>
          <div class="info-card">
            <h3>Why Nuvia works</h3>
            <div class="info-accordion" id="infoAccordion">
              <details open>
                <summary>Get noticed — create content people love</summary>
                <div class="detail-body">
                  <p>Publish posts that reach the Explore feed, save your favorites, and pin Highlights to your profile. Active contributors rise through levels and gain visibility.</p>
                </div>
              </details>

              <details>
                <summary>Conversations that feel real</summary>
                <div class="detail-body">
                  <p>From quick voice notes to low-latency calls, Nuvia keeps conversations natural. Presence and typing indicators help you stay in sync with friends.</p>
                </div>
              </details>

              <details>
                <summary>Rewards & progression</summary>
                <div class="detail-body">
                  <p>Earn JCoins for engagement and milestones. Levels unlock badges, perks, and special features — it pays to participate.</p>
                </div>
              </details>

              <details>
                <summary>Built with safety in mind</summary>
                <div class="detail-body">
                  <p>Moderation tools, clear community guidelines, and session protections help keep the space safe and welcoming for everyone.</p>
                </div>
              </details>

              <details>
                <summary>Quick FAQ</summary>
                <div class="detail-body">
                  <p><strong>Can I try before joining?</strong> Yes — browse public posts and Explore as a guest. <br/><strong>Need an invite?</strong> Some features may be invite-only; contact support or an administrator for access.</p>
                </div>
              </details>
            </div>

            <div class="info-cta">
              <button class="btn btn-primary" onclick="document.getElementById('email').focus();">Create your free account</button>
              <a class="info-link" href="/index.html">Browse public posts</a>
            </div>
          </div>

          <div class="info-card" style="margin-top:14px">
            <h3>Get started in seconds</h3>
            <p>New here? Start by exploring trending posts or preview the chat experience. Signing up takes less than a minute and unlocks posting, messaging and wallet features.</p>
            <div style="margin-top:12px" class="info-cta">
              <button class="btn btn-primary" onclick="goToSignup()">Create Account</button>
              <a class="info-link" href="/explore.html">See trending now</a>
            </div>
          </div>
        </div>
      </div>

    </section>
    </div>

    <!-- Smart Loader -->
    <style>
      .smart-progress{height:8px;background:rgba(255,255,255,0.12);border-radius:999px;overflow:hidden;margin:14px 0 6px;}
      .smart-progress-bar{display:block;height:100%;width:0;background:linear-gradient(90deg, var(--pink), var(--blue));transition:width 300ms ease;border-radius:inherit;}
      .smart-percent{font-family:'Inter',sans-serif;font-size:12px;color:var(--text-light);opacity:.85;}
      .smart-loader-logo{width:80px;height:80px;object-fit:contain;display:block;margin:0 auto 14px;filter:drop-shadow(0 0 12px var(--pink)) drop-shadow(0 0 12px var(--blue));border-radius:12px;}
      @media (max-width:600px){.smart-loader-logo{width:64px;height:64px;margin-bottom:12px;}}
    </style>
    <div class="smart-loader" id="smartLoader" aria-hidden="true">
        <div class="loader-content" role="dialog" aria-label="Loading">
            <img class="smart-loader-logo" src="https://cdn.builder.io/api/v1/image/assets%2F7ddc96086aa641d6b4ecb6f09d6fc11e%2Fe6f0e17448b846b9bf70db2e0b4fd230?format=webp&width=800" alt="Nuvia logo" loading="eager" decoding="async">
            <div class="gemini-spinner" aria-hidden="true"></div>
            <div class="loader-text" id="loaderText">Processing...</div>
            <div class="loader-subtext" id="loaderSubtext">Please wait while we authenticate you</div>
            <div class="smart-progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"><span class="smart-progress-bar" id="smartProgressBar"></span></div>
            <div class="smart-percent" id="smartPercent">0%</div>
        </div>
    </div>

    <!-- Custom Modal -->
    <div class="custom-modal" id="customModal">
        <div class="modal-content">
            <div class="modal-icon" id="modalIcon">
                ✓
            </div>
            <div class="modal-title" id="modalTitle">Success</div>
            <div class="modal-message" id="modalMessage">Your action was completed successfully.</div>
            <div class="modal-buttons">
                <button class="modal-btn primary" id="modalPrimaryBtn" onclick="closeModal()">OK</button>
            </div>
        </div>
    </div>

    <!-- Welcome Modal for new users -->
    <div class="custom-modal" id="welcomeModal" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-icon success" aria-hidden="true">🎉</div>
            <div class="modal-title">Congratulations!</div>
            <div class="modal-message">Welcome to Nuvia — your adventure starts now. Create, connect, and earn rewards as you join our friendly community. We're excited to have you here!</div>
            <div class="modal-buttons">
                <button class="modal-btn primary welcome-ok" id="welcomeOkBtn" type="button">OK, let's go!</button>
            </div>
        </div>
    </div>

    <!-- Reset Password Modal -->
    <div class="custom-modal" id="resetPasswordModal">
        <div class="modal-content">
            <div class="modal-icon info">
                <svg width="36" height="36" viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20zm1 14h-2v-6h2v6zm0-8h-2V6h2v2z" fill="currentColor"/></svg>
            </div>
            <div class="modal-title">Reset Password</div>
            <div class="modal-message">Enter your email address and we'll send you a link to reset your password.</div>
            <div style="margin: 20px 0;">
                <input type="email" id="resetEmail" placeholder="Enter your email" class="modal-field">
            </div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeResetModal()">Cancel</button>
                <button class="modal-btn primary" onclick="sendResetEmail()">Send Reset Link</button>
            </div>
        </div>
    </div>

    <!-- APK Download Modal -->
    <div class="custom-modal" id="apkDownloadModal">
        <div class="modal-content apk-panel">
            <div class="modal-icon info">⬇</div>
            <div class="modal-title">Downloading Nuvia</div>
            <div class="modal-message" id="apkModalMessage">Your download will start automatically. If it doesn't, click "Download now".</div>
            <div class="apk-progress" aria-hidden="true"><span class="apk-progress-bar"></span></div>
            <div class="modal-buttons">
                <button class="modal-btn primary" id="apkDownloadNowBtn" type="button">Download now</button>
                <button class="modal-btn secondary" id="apkCloseBtn" type="button">Close</button>
            </div>
        </div>
    </div>

    <!-- Fallback globals to prevent inline onclick errors if module fails to load -->
    <script>
        // Provide minimal fallback for goToSignup so clicking the signup link doesn't throw when module fails
        if (!window.goToSignup) {
            window.goToSignup = function() {
                try { if (typeof showErrorModal === 'function') { showErrorModal('Signup is temporarily unavailable. Please try again later.'); return; } } catch(_){}
                try { alert('Signup is temporarily unavailable. Please try again later.'); } catch(_){}
            };
        }
    </script>

    <!-- Inline SVG icon sprite + runtime replacer (fallback if external icon fonts break) -->
    <script>
    (function(){
      // SVG sprite containing small, accessible icons used on this page
      const sprite = '\n<svg id="__inline_svg_icons" xmlns="http://www.w3.org/2000/svg" style="position:absolute;width:0;height:0;overflow:hidden" aria-hidden="true" focusable="false">\n  <symbol id="icon-envelope-open-text" viewBox="0 0 24 24">\n    <path d="M2 7.5V18a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V7.5l-10 6-10-6z" fill="currentColor"/>\n    <path d="M22 6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v.5l10 6 10-6V6z" fill="currentColor"/>\n  </symbol>\n  <symbol id="icon-paper-plane" viewBox="0 0 24 24">\n    <path d="M2 21l20-9L2 3v7l15 2-15 2v6z" fill="currentColor"/>\n  </symbol>\n  <symbol id="icon-check" viewBox="0 0 24 24">\n    <path d="M20.285 6.708l-11.39 11.39L3.715 13.918l1.414-1.414 3.766 3.766 9.976-9.976z" fill="currentColor"/>\n  </symbol>\n  <symbol id="icon-eye" viewBox="0 0 24 24">\n    <path d="M12 5c-7 0-11 6.5-11 7s4 7 11 7 11-6.5 11-7-4-7-11-7zm0 11a4 4 0 1 1 0-8 4 4 0 0 1 0 8z" fill="currentColor"/>\n  </symbol>\n  <symbol id="icon-eye-slash" viewBox="0 0 24 24">\n    <path d="M2 2l20 20-1.5 1.5L17 17.5C15.7 18.1 14.4 18.5 13 18.5 6 18.5 2 12 2 12c.9-1.4 2.4-3.1 4.3-4.6L.5 3.5 2 2z" fill="currentColor"/>\n  </symbol>\n</svg>\n';

      const classToSymbol = {
        'fa-envelope-open-text': '#icon-envelope-open-text',
        'fa-paper-plane': '#icon-paper-plane',
        'fa-check': '#icon-check',
        'fa-eye': '#icon-eye',
        'fa-eye-slash': '#icon-eye-slash'
      };

      function insertSprite(){
        if (!document.getElementById('__inline_svg_icons')){
          try{ document.body.insertAdjacentHTML('afterbegin', sprite); }catch(e){
            const d = document.createElement('div'); d.innerHTML = sprite; document.body.insertBefore(d, document.body.firstChild);
          }
        }
      }

      function replaceIcons(){
        try{
          document.querySelectorAll('i.fas').forEach(i=>{
            const classes = Array.from(i.classList || []);
            const fa = classes.find(c=>c.startsWith('fa-') && c !== 'fas');
            if(!fa) return;
            const symbol = classToSymbol[fa];
            if(!symbol) return;
            const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
            svg.setAttribute('class', 'inline-icon '+fa.replace('fa-','icon-'));
            svg.setAttribute('aria-hidden','true');
            svg.setAttribute('focusable','false');
            svg.setAttribute('width','1em'); svg.setAttribute('height','1em');
            svg.setAttribute('viewBox','0 0 24 24');
            // Preserve id if present (used by password toggle)
            if(i.id) svg.id = i.id;
            // Create use element (both href and xlink:href for broad compatibility)
            const use = document.createElementNS('http://www.w3.org/2000/svg','use');
            use.setAttribute('href', symbol);
            use.setAttributeNS('http://www.w3.org/1999/xlink','xlink:href', symbol);
            svg.appendChild(use);
            i.replaceWith(svg);
          });
        }catch(e){ console.warn('Icon replacement failed', e); }
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function(){ insertSprite(); replaceIcons(); });
      } else { insertSprite(); replaceIcons(); }
    })();
    </script>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp, deleteApp } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail, updateProfile, setPersistence, browserLocalPersistence, browserSessionPersistence, signOut, fetchSignInMethodsForEmail, GoogleAuthProvider, GithubAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult, getAdditionalUserInfo, signInWithCredential } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-auth.js";
        import { initializeFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp, collection, query, where, getDocs, runTransaction, increment, addDoc } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-firestore.js";

        // Firebase configuration (using your existing config)
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyDz-8N0totzvMCvonF9pKj9RsoH3J8xL0w",
            authDomain: "jchat-1.firebaseapp.com",
            databaseURL: "https://jchat-1-default-rtdb.firebaseio.com",
            projectId: "jchat-1",
            storageBucket: "jchat-1.firebasestorage.app",
            messagingSenderId: "328479683167",
            appId: "1:328479683167:web:276c0b7e8ea44dd2d6a1ea",
            measurementId: "G-S6Z9GG0R9P"
        };

        // Initialize Firebase (allow runtime domain switch)
        const firestoreOptions = { useFetchStreams: false, experimentalAutoDetectLongPolling: true };
        let app = initializeApp(firebaseConfig);
        let auth = getAuth(app);
        let db = initializeFirestore(app, firestoreOptions);
        window.__auth_domain = firebaseConfig.authDomain;
        async function switchAuthDomain(newDomain) {
            try { await deleteApp(app); } catch (e) {}
            const cfg = { ...firebaseConfig, authDomain: newDomain };
            app = initializeApp(cfg);
            auth = getAuth(app);
            db = initializeFirestore(app, firestoreOptions);
            window.__auth_domain = newDomain;
        }

        // Application ID (consistent with other pages)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // Referral support: read inviter from URL (?ref= or ?referrer= or ?refer=)
        function getQueryParam(name){ try{ const u=new URL(window.location.href); return u.searchParams.get(name) || null; }catch(_){ return null; } }
        const referrerIdFromUrl = (getQueryParam('ref') || getQueryParam('referrer') || getQueryParam('refer'))?.trim() || null;

        // Parse manual referrer from optional input; accepts full URL or raw ID
        function parseReferrerFromInput(){
            try{
                const el = document.getElementById('referralLinkInput');
                if(!el) return null;
                const raw = (el.value || '').trim();
                if(!raw) return null;
                try{
                    const u = new URL(raw);
                    const code = u.searchParams.get('ref') || u.searchParams.get('referrer') || u.searchParams.get('refer');
                    return (code || '').trim() || raw;
                }catch(_){
                    return raw; // treat as raw ID if not a URL
                }
            }catch(_){ return null; }
        }
        document.addEventListener('DOMContentLoaded', ()=>{ try{ const el = document.getElementById('referralLinkInput'); if(el && referrerIdFromUrl){ el.value = referrerIdFromUrl; } }catch(_){} });

        // System settings reference used across the app
        const SYSTEM_SETTINGS_DOC_REF = doc(db, "artifacts", appId, "public", "data", "settings", "system_settings");
        // Public signup flag (default true). Also mirrored to a global used elsewhere in this file
        let publicSignupEnabled = true;
        window.__public_signup_enabled = true;
        

        // Load system settings to determine if public signup is enabled
        (async function loadSystemSettings() {
            try {
                const snap = await getDoc(SYSTEM_SETTINGS_DOC_REF);
                if (snap.exists()) {
                    const settings = snap.data();
                    publicSignupEnabled = settings.enableUserRegistration !== false; // default true if missing
                    window.__public_signup_enabled = publicSignupEnabled;


                    if (!publicSignupEnabled) {
                        // Ensure UI reflects invite-only mode
                        const container = document.querySelector('.login-container');
                        if (container && container.classList.contains('signup-mode')) {
                            container.classList.remove('signup-mode');
                        }
                        showAdminOnlyNotice();
                    }
                }
            } catch (e) {
                console.warn('JCHAT_WARN: Failed to load system settings; assuming signup enabled.', e);
                publicSignupEnabled = true;
                window.__public_signup_enabled = true;
            }
        })();




        // Make functions globally available
        window.togglePassword = function() {
            const passwordInput = document.getElementById('password');
            const toggleBtn = document.getElementById('passwordToggle') || document.querySelector('.password-toggle');
            const icon = document.getElementById('passwordToggleIcon') || (toggleBtn ? toggleBtn.querySelector('i') : null);
            try {
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    if (icon) { icon.classList.remove('fa-eye'); icon.classList.add('fa-eye-slash'); }
                    if (toggleBtn) { toggleBtn.setAttribute('aria-pressed','true'); toggleBtn.setAttribute('aria-label','Hide password'); }
                } else {
                    passwordInput.type = 'password';
                    if (icon) { icon.classList.remove('fa-eye-slash'); icon.classList.add('fa-eye'); }
                    if (toggleBtn) { toggleBtn.setAttribute('aria-pressed','false'); toggleBtn.setAttribute('aria-label','Show password'); }
                }
            } catch(e) { console.warn('togglePassword error', e); }
        };

        // Press-and-hold to peek password without toggling state
        (function(){
            const btn = document.getElementById('passwordToggle');
            const input = document.getElementById('password');
            if (!btn || !input) return;
            let holdActive = false;
            function setIconState(){
                try{ if (typeof window.updatePasswordToggleSvg === 'function') window.updatePasswordToggleSvg(); }catch(_){}
            }
            function pressDown(){
                if (input.type === 'password') {
                    input.type = 'text';
                    holdActive = true;
                    setIconState();
                }
            }
            function pressUp(){
                if (holdActive && btn.getAttribute('aria-pressed') !== 'true') {
                    input.type = 'password';
                    setIconState();
                }
                holdActive = false;
            }
            btn.addEventListener('mousedown', pressDown);
            btn.addEventListener('touchstart', pressDown, { passive: true });
            ['mouseup','mouseleave','touchend','touchcancel','blur'].forEach(ev => btn.addEventListener(ev, pressUp));
        })();

        // Global helper used by SVG replacer to ensure eye icon reflects current visibility state
        window.updatePasswordToggleSvg = function(){
            try{
                const icon = document.getElementById('passwordToggleIcon');
                const input = document.getElementById('password');
                if(!icon || !input) return;
                // if icon is an SVG with a <use>, update the href; otherwise leave classes as-is
                if(icon.tagName && icon.tagName.toLowerCase() === 'svg'){
                    const use = icon.querySelector('use');
                    if(!use) return;
                    const target = input.type === 'password' ? '#icon-eye' : '#icon-eye-slash';
                    use.setAttribute('href', target);
                    use.setAttributeNS('http://www.w3.org/1999/xlink','xlink:href', target);
                } else {
                    // Fallback: toggle classes for font-icons
                    try{
                        if (input.type === 'password') { icon.classList.remove('fa-eye-slash'); icon.classList.add('fa-eye'); } else { icon.classList.remove('fa-eye'); icon.classList.add('fa-eye-slash'); }
                    }catch(e){}
                }
            }catch(e){}
        };







        window.goToSignup = function() {
            // Optional guard: allow an environment flag to disable public signup
            if (typeof __public_signup_enabled !== 'undefined' && __public_signup_enabled === false) {
                showErrorModal('Account creation is currently invite-only. Please sign in with an existing account or contact an administrator.');
                showAdminOnlyNotice();
                return;
            }
            // Toggle to signup mode
            toggleSignupMode();
        };

        function showAdminOnlyNotice() {
            const signupLinkText = document.getElementById('signup-link-text');
            const adminNotice = document.getElementById('admin-only-notice');
            if (signupLinkText && adminNotice) {
                signupLinkText.style.display = 'none';
                adminNotice.style.display = 'block';
            }
        }




        // Save user data to Firestore (use public artifacts path to match other modules; handle permission errors)
        async function saveUserData(user, provider, additionalData = {}) {
            try {
                if (!user || !user.uid) return;

                // Ensure auth has settled and currentUser matches the target uid when possible
                if (typeof auth !== 'undefined' && auth.currentUser && auth.currentUser.uid !== user.uid) {
                    // give auth a short moment to settle (useful when saveUserData is called immediately after sign-in)
                    await new Promise(res => setTimeout(res, 300));
                }

                // Use the same 'artifacts' public users collection used across the app to avoid mismatched security rules
                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid);
                const userDoc = await getDoc(userRef);

                const now = serverTimestamp();
                const userData = {
                    uid: user.uid,
                    email: user.email || null,
                    displayName: user.displayName || null,
                    photoURL: user.photoURL || null,
                    provider: provider || null,
                    lastLogin: now,
                    ...additionalData
                };

                if (!userDoc.exists()) {
                    // New user
                    userData.createdAt = now;
                    userData.isNewUser = true;
                    await setDoc(userRef, userData);
                } else {
                    // Existing user - only update allowed fields
                    await updateDoc(userRef, {
                        lastLogin: now,
                        provider: provider || null
                    });
                }

            } catch (error) {
                console.error('Error saving user data:', error);

                // Specific guidance and a safe fallback when this is a Firestore permission issue
                if (error && error.code === 'permission-denied') {
                    console.warn('Permission denied while writing user profile. Likely causes: Firestore rules restrict writes to this path or the user is not authenticated yet.');

                    try {
                        // Attempt a minimal public profile write to a permissive summary collection as a best-effort fallback
                        const fallbackRef = doc(db, 'artifacts', appId, 'public', 'data', 'user_profiles', user.uid);
                        await setDoc(fallbackRef, {
                            uid: user.uid,
                            displayName: user.displayName || null,
                            photoURL: user.photoURL || null,
                            updatedAt: serverTimestamp()
                        }, { merge: true });
                        console.info('Fallback public profile written to artifacts/.../user_profiles as minimal record.');
                    } catch (fbErr) {
                        console.warn('Fallback write also failed:', fbErr);
                    }
                }
            }
        }


        // Handle form submission
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const isSignupMode = document.querySelector('.login-container').classList.contains('signup-mode');

            // Throttle check (tiered attempts with increasing cooldowns)
            const throttle = getThrottleState();
            if (throttle.lockUntil && Date.now() < throttle.lockUntil) {
                const ms = throttle.lockUntil - Date.now();
                showAttemptsStatus('warn', `Locked due to failed attempts. Try again in ${formatDuration(ms)}. Attempts when unlocked: ${throttle.remaining}.`);
                return;
            } else if (throttle.remaining < getBaseAttempts(throttle.stage)) {
                showAttemptsStatus('info', `${throttle.remaining} attempt${throttle.remaining===1?'':'s'} left in this window.`);
            }

            // Basic validation
            if (!email || !password) {
                showError('Please fill in all fields.');
                return;
            }

            if (!isValidEmail(email)) {
                showError('Please enter a valid email address.');
                return;
            }

            if (password.length < 6) {
                showError('Password must be at least 6 characters long.');
                return;
            }

            hideError();

            try {
                if (isSignupMode) {
                    await signUpUser(email, password);
                } else {
                    await loginUser(email, password);
                }
            } catch (error) {
                console.error('Authentication error:', error);
                showError(error.message || 'Authentication failed. Please try again.');
            }
        });




        // Sign up user
        async function signUpUser(email, password) {
            // Awards: inviter + new user once per account creation
            async function processReferralReward(newUserId){
                try{
                    // Resolve inviter from input/url; support full URLs and usernames
                    let rawRef = (parseReferrerFromInput() || referrerIdFromUrl || '').trim();
                    if (!rawRef || rawRef === newUserId) return;
                    try { const u = new URL(rawRef); rawRef = (u.searchParams.get('ref') || u.searchParams.get('referrer') || u.searchParams.get('refer') || '').trim() || rawRef; } catch(_){ }

                    let inviterId = rawRef;
                    if (!/^[A-Za-z0-9]{20,}/.test(inviterId)) {
                        // Try resolve by username -> uid from public profiles
                        try {
                            const qRef = query(collection(db, 'artifacts', appId, 'public', 'data', 'users'), where('username','==', inviterId.toLowerCase()));
                            const qs = await getDocs(qRef);
                            if (!qs.empty) inviterId = (qs.docs[0].data().userId || qs.docs[0].id);
                        } catch(_){ /* ignore */ }
                    }
                    if (!inviterId || inviterId === newUserId) return;

                    const newUserPrivateRef = doc(db, 'artifacts', appId, 'users', newUserId, 'profiles', 'user_profile');
                    const inviterPrivateRef = doc(db, 'artifacts', appId, 'users', inviterId, 'profiles', 'user_profile');

                    // STEP 1: Immediately credit NEW USER only (always allowed)
                    let didCreditNew = false;
                    await runTransaction(db, async (tx)=>{
                        const nuSnap = await tx.get(newUserPrivateRef);
                        if (!nuSnap.exists()) return;
                        const nu = nuSnap.data() || {};
                        if (nu.referral?.rewarded === true) return; // already credited
                        tx.update(newUserPrivateRef, {
                            gas: increment(20),
                            totalGasEarned: increment(20),
                            jCoins: increment(10),
                            referral: { referrerId: inviterId, rewarded: true, rewardedAt: serverTimestamp() },
                            updatedAt: serverTimestamp()
                        });
                        didCreditNew = true;
                    });

                    if (didCreditNew) {
                        try {
                            const newUserTxCol = collection(db, 'artifacts', appId, 'users', newUserId, 'transactions');
                            await addDoc(newUserTxCol, {
                                type: 'referral_new_user_bonus',
                                jCoins: 10,
                                gas: 20,
                                timestamp: serverTimestamp(),
                                description: `Referral bonus for joining via ${inviterId}`
                            });
                            const newUserNotifCol = collection(db, 'artifacts', appId, 'users', newUserId, 'notifications');
                            await addDoc(newUserNotifCol, {
                                type: 'system',
                                subtype: 'referral_reward',
                                message: 'You earned 10 JCoins and 20 Gas for joining with a referral!',
                                read: false,
                                timestamp: serverTimestamp(),
                                targetUrl: '/Wallet.html'
                            });
                        } catch(_) { /* ignore */ }
                    }

                    // Reflect NEW USER in public summary (best-effort)
                    try { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', newUserId), { jCoins: increment(10), totalGasEarned: increment(20), updatedAt: serverTimestamp() }); } catch(_){ }

                    // STEP 2: Try to credit INVITER directly; on failure, create pending reward for auto-approve/admin
                    let inviterCredited = false;
                    try{
                        await runTransaction(db, async (tx)=>{
                            const invSnap = await tx.get(inviterPrivateRef);
                            if (!invSnap.exists()) return; // inviter must exist
                            tx.update(inviterPrivateRef, {
                                gas: increment(20),
                                totalGasEarned: increment(20),
                                jCoins: increment(5),
                                successfulReferrals: increment(1),
                                updatedAt: serverTimestamp()
                            });
                        });
                        inviterCredited = true;
                    }catch(err){
                        // Permission denied or other failure -> queue pending reward
                        try {
                            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'pending_activity_rewards'), {
                                userId: inviterId,
                                username: null,
                                activityType: 'referral_inviter',
                                suggestedJCoinAmount: 5,
                                suggestedXpAmount: 0,
                                suggestedGasAmount: 20,
                                status: 'pending',
                                timestamp: serverTimestamp(),
                                relatedEntityId: newUserId,
                                notes: `Referral from ${newUserId}. Auto-approve to credit inviter.`
                            });
                            try {
                                await addDoc(collection(db, 'artifacts', appId, 'users', inviterId, 'notifications'), {
                                    type: 'system',
                                    subtype: 'referral_reward_pending',
                                    message: 'Your referral bonus is pending approval. You will receive 5 JCoins and 20 Gas once approved.',
                                    read: false,
                                    timestamp: serverTimestamp(),
                                    targetUrl: '/notifications.html'
                                });
                            } catch(_) { /* ignore */ }
                        } catch(_){ /* ignore */ }
                    }

                    // Reflect INVITER in public summary if directly credited
                    if (inviterCredited) {
                        try { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', inviterId), { jCoins: increment(5), totalGasEarned: increment(20), updatedAt: serverTimestamp() }); } catch(_){ }
                        try {
                            const invTxCol = collection(db, 'artifacts', appId, 'users', inviterId, 'transactions');
                            await addDoc(invTxCol, {
                                type: 'referral_inviter_bonus',
                                jCoins: 5,
                                gas: 20,
                                timestamp: serverTimestamp(),
                                description: `Referral bonus from ${newUserId}`
                            });
                            const invNotifCol = collection(db, 'artifacts', appId, 'users', inviterId, 'notifications');
                            await addDoc(invNotifCol, {
                                type: 'system',
                                subtype: 'referral_reward',
                                message: 'Your referral joined. You earned 5 JCoins and 20 Gas.',
                                read: false,
                                timestamp: serverTimestamp(),
                                targetUrl: '/Wallet.html'
                            });
                        } catch(_) { /* ignore */ }
                    }

                }catch(e){ console.warn('Referral reward failed or skipped:', e?.message || e); }
            }
            // Get additional signup fields
            const fullName = document.getElementById('fullName').value.trim();
            const username = document.getElementById('username').value.trim();
            const confirmPassword = document.getElementById('confirmPassword').value;
            // Enhanced validation for signup
            if (!fullName) {
                showErrorModal('Please enter your full name.');
                return;
            }
            
            if (!username) {
                showErrorModal('Please choose a username.');
                return;
            }
            
            if (username.length < 3) {
                showErrorModal('Username must be at least 3 characters long.');
                return;
            }
            
            if (password !== confirmPassword) {
                showErrorModal('Passwords do not match. Please check and try again.');
                return;
            }

            // Strong password policy: min 8, at least 1 letter and 1 number
            const strongPwd = /^(?=.*[A-Za-z])(?=.*\d).{8,}$/;
            if (!strongPwd.test(password)) {
                showErrorModal('Password must be at least 8 characters and include at least one letter and one number.');
                return;
            }
            
            // Check username availability
            if (!(await checkUsernameAvailability(username))) {
                showErrorModal('This username is already taken. Please choose a different one.');
                return;
            }
            
            showSmartLoader('Creating Account', 'Setting up your JCHAT profile...');
            
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // Update Firebase Auth profile with display name
                await updateProfile(user, {
                    displayName: fullName
                });
                
                // Save comprehensive user data to Firestore
                const userData = {
                    uid: user.uid,
                    email: user.email,
                    displayName: fullName,
                    username: username.toLowerCase(),
                    fullName: fullName,
                    provider: 'email',
                    createdAt: serverTimestamp(),
                    lastLogin: serverTimestamp(),
                    isNewUser: true,
                    profileCompletion: calculateInitialCompletion(fullName, username),
                    visibility: {
                        email: false,
                        fullName: true
                    }
                };
                
                await saveUserData(user, 'email', userData);

                // Create public and private profile documents so username checks and profile lookups work consistently
                try {
                    const publicProfileRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid);
                    const privateProfileRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profiles', 'user_profile');
                    const publicPayload = {
                        userId: user.uid,
                        username: username.toLowerCase(),
                        profilePicId: null,
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    };
                    const privatePayload = {
                        uid: user.uid,
                        username: username.toLowerCase(),
                        displayName: fullName,
                        profilePicId: null,
                        referralId: user.uid,
                        successfulReferrals: 0,
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    };
                    await Promise.all([
                        setDoc(publicProfileRef, publicPayload, { merge: true }),
                        setDoc(privateProfileRef, privatePayload, { merge: true })
                    ]);
                } catch (profileErr) {
                    console.warn('JCHAT_WARN: Failed to create public/private profile docs on signup', profileErr);
                }

                // Referral rewards (inviter: +20 gas/+5 JCoin, new user: +20 gas/+10 JCoin)
                await processReferralReward(user.uid);

                hideSmartLoader();
                try { localStorage.setItem('nuvia_auth_user', JSON.stringify({ uid: user.uid, email: user.email || email, displayName: user.displayName || null, ts: Date.now() })); localStorage.setItem('nuvia_auth_status', 'authenticated'); } catch(_) {}
                // Show an upbeat welcome panel for newly registered account and redirect when dismissed
                showWelcomeModal(user.uid);

            } catch (error) {
                hideSmartLoader();
                let errorMessage = 'Failed to create account. Please try again.';

                const code = error && error.code ? String(error.code) : '';
                const messageText = error && error.message ? String(error.message) : '';

                switch (code) {
                    case 'auth/email-already-in-use':
                        errorMessage = 'An account with this email already exists. Switching to sign in.';
                        try {
                            const emailInput = document.getElementById('email');
                            if (emailInput) emailInput.value = email;
                            const container = document.querySelector('.login-container');
                            if (container && container.classList.contains('signup-mode')) {
                                toggleSignupMode();
                            }
                        } catch (_) {}
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'Password is too weak. Please choose a stronger password with at least 6 characters.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Please enter a valid email address.';
                        break;
                    case 'auth/operation-not-allowed':
                    case 'auth/admin-restricted-operation':
                        errorMessage = 'Sign up is restricted to administrators. Please sign in with an existing account or contact support.';
                        break;
                }

                // Fallback for Identity Toolkit REST error text
                if (/ADMIN_ONLY_OPERATION/i.test(messageText)) {
                    errorMessage = 'Account creation is currently invite-only. Please sign in with an existing account or contact an administrator for access.';
                    showAdminOnlyNotice();
                }

                showErrorModal(errorMessage);
            }
        }

        // Login user
        async function loginUser(email, password) {
            showSmartLoader('Signing In', 'Authenticating your credentials...');
            
            try {
                await setPersistence(auth, browserLocalPersistence);
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // Update last login
                await saveUserData(user, 'email');
                try { deleteCookie('login_failed_attempts'); deleteCookie('login_cooldown_until'); deleteCookie('login_throttle_state'); } catch(_) {}

                hideSmartLoader();
                try {
                    localStorage.setItem('nuvia_auth_user', JSON.stringify({ uid: user.uid, email: user.email || null, displayName: user.displayName || null, ts: Date.now() }));
                    localStorage.setItem('nuvia_auth_status', 'authenticated');
                } catch (_) {}
                await showSavePasswordPrompt(email, password, () => { try{ sessionStorage.setItem('nuvia_last_auth','1'); }catch(_){} window.location.href = 'index.html'; });

            } catch (error) {
                hideSmartLoader();
                let errorMessage = "Wrong password, please you can't sign in to Nuvia with incorrect password, please check your password and try again.";
                const code = (error && error.code) || '';
                const rawMsg = (error && (error.message || '')).toString();
                const textBlob = [
                    code || '',
                    rawMsg || '',
                    (error && error.name) || '',
                    (error && error.stack) || '',
                    (()=>{ try{ return JSON.stringify(error || {}); }catch(_){ return ''; } })(),
                    (() => { try { return JSON.stringify((error && error.customData) || {}); } catch(_) { return ''; } })()
                ].join(' ');
                const isWrong = /auth\/wrong-password|INVALID_PASSWORD|INVALID_LOGIN_CREDENTIALS|invalid[_\s-]*credential|wrong\s*password/i.test(textBlob);
                const isNotFound = code === 'auth/user-not-found' || /EMAIL_NOT_FOUND/i.test(rawMsg);
                if (isWrong) {
                    try { applyThrottleFailure(); } catch(_) {}
                    const state = getThrottleState();
                    if (state && state.lockUntil && Date.now() < state.lockUntil) {
                        showWrongPasswordModal(true);
                    } else {
                        showWrongPasswordModal(false);
                    }
                    return;
                }
                // Only do network diagnostics if not a known auth error
                try {
                    if (rawMsg.includes('Failed to fetch') || (error && error.name === 'TypeError')) {
                        const controller = new AbortController();
                        const timeout = setTimeout(() => controller.abort(), 3000);
                        await fetch('https://www.gstatic.com/generate_204', { method: 'GET', mode: 'no-cors', signal: controller.signal }).catch(()=>{});
                        clearTimeout(timeout);
                    }
                } catch (netErr) {
                    console.warn('Network check failed:', netErr);
                    errorMessage = "Wrong password, please you can't sign in to Nuvia with incorrect password, please check your password and try again.";
                    showErrorModal(errorMessage);
                    return;
                }
                // Map common REST messages when error.code is missing (non-network cases)
                try {
                    if (isNotFound) {
                        errorMessage = 'No account found with this email.';
                    } else if (/USER_DISABLED/i.test(rawMsg)) {
                        errorMessage = 'This account has been disabled. Please contact support.';
                    }
                } catch(_) {}

                // If firebase provided an error code, map to friendly messages
                if (error && error.code) {
                    switch (error.code) {
                        case 'auth/user-not-found':
                            errorMessage = 'No account found with this email.';
                            try {
                                if (typeof __public_signup_enabled === 'undefined' || __public_signup_enabled !== false) {
                                    const currentEmail = document.getElementById('email')?.value.trim();
                                    showCustomModal('info', 'Create Account?', 'We can create a new account with this email. Continue?', () => {
                                        const emailInput = document.getElementById('email');
                                        if (emailInput && currentEmail) emailInput.value = currentEmail;
                                        const container = document.querySelector('.login-container');
                                        if (container && !container.classList.contains('signup-mode')) {
                                            toggleSignupMode();
                                        }
                                    });
                                }
                            } catch (_) {}
                            break;
                        case 'auth/wrong-password':
                            errorMessage = "Wrong password, please you can't sign in to Nuvia with incorrect password, please check your password and try again.";
                            break;
                        case 'auth/invalid-email':
                            errorMessage = 'Please enter a valid email address.';
                            break;
                        case 'auth/invalid-credential':
                            errorMessage = 'Invalid login credentials. Please check your email and password.';
                            break;
                        case 'auth/user-disabled':
                            errorMessage = 'This account has been disabled. Please contact support for assistance.';
                            break;
                        case 'auth/too-many-requests':
                            errorMessage = 'Too many failed attempts. Please try again later, or reset your password.';
                            break;
                        case 'auth/network-request-failed':
                            errorMessage = "Wrong password, please you can't sign in to Nuvia with incorrect password, please check your password and try again.";
                            break;
                        default:
                            // Keep generic message
                            break;
                    }
                }

                // Apply tiered throttle only for wrong-credential errors
                const msg = (error && error.message) || '';
                const blob = [code||'', msg||'', (()=>{ try{ return JSON.stringify(error||{});}catch(_){ return ''; } })()].join(' ');
                const wrong = /auth\/wrong-password|INVALID_PASSWORD|INVALID_LOGIN_CREDENTIALS|invalid[_\s-]*credential|wrong\s*password/i.test(blob);
                if (wrong) {
                    try { applyThrottleFailure(); } catch(_) {}
                    const st = getThrottleState();
                    if (st && st.lockUntil && Date.now() < st.lockUntil) {
                        showWrongPasswordModal(true);
                    } else {
                        showWrongPasswordModal(false);
                    }
                    return;
                }
                showErrorModal(errorMessage);
            }
        }

        // Tiered throttle state helpers
        function setCookie(name, value, days){ try{ let expires = ''; if (typeof days === 'number'){ const d = new Date(); d.setTime(d.getTime() + (days*24*60*60*1000)); expires = '; expires=' + d.toUTCString(); } document.cookie = name + '=' + encodeURIComponent(value) + expires + '; path=/'; }catch(_){ } }
        function getCookie(name){ try{ const m = document.cookie.split('; ').find(r => r.indexOf(name + '=') === 0); if(!m) return null; return decodeURIComponent(m.split('=')[1] || ''); }catch(_){ return null; } }
        function deleteCookie(name){ try{ document.cookie = name + '=; Max-Age=0; path=/'; }catch(_){ } }

        function getThrottleState(){
            try{ const raw = getCookie('login_throttle_state'); if(raw){ const s = JSON.parse(raw); return { stage: Math.max(0, s.stage|0), remaining: Math.max(0, s.remaining|0), lockUntil: s.lockUntil|0 }; } }catch(_){ }
            return { stage: 0, remaining: 6, lockUntil: 0 };
        }
        function saveThrottleState(s){ try{ setCookie('login_throttle_state', JSON.stringify(s), 7); }catch(_){ } }
        function getBaseAttempts(stage){ return Math.max(1, 6 - Math.min(5, stage|0)); }
        function formatDuration(ms){
            const sec = Math.max(0, Math.ceil(ms/1000));
            if (sec < 60) return sec + 's';
            const m = Math.floor(sec/60); const s = sec%60;
            if (m < 60) return m + 'm' + (s?(' ' + s + 's'):'');
            const h = Math.floor(m/60); const rm = m%60;
            return h + 'h' + (rm?(' ' + rm + 'm'):'');
        }
        function showAttemptsStatus(kind, text){
            try{
                const b = document.getElementById('attemptsBanner'); const t = document.getElementById('attemptsBannerText');
                if (!b || !t) return;
                b.classList.remove('error','warn','info'); b.classList.add(kind||'info');
                t.textContent = text;
                b.style.display = 'block'; b.classList.add('show');
            }catch(_){ }
        }
        function hideAttemptsStatus(){ try{ const b = document.getElementById('attemptsBanner'); if(b){ b.style.display='none'; b.classList.remove('show'); } }catch(_){ }
        }
        function scheduleCountdown(){
            try{
                const st = getThrottleState(); if (!st.lockUntil || Date.now()>=st.lockUntil) return;
                const id = setInterval(()=>{
                    const s = getThrottleState();
                    if (!s.lockUntil || Date.now()>=s.lockUntil){ clearInterval(id); hideAttemptsStatus(); return; }
                    const ms = s.lockUntil - Date.now();
                    showAttemptsStatus('warn', `Locked due to failed attempts. Try again in ${formatDuration(ms)}. Attempts when unlocked: ${s.remaining}.`);
                }, 1000);
            }catch(_){ }
        }
        function applyThrottleFailure(){
            const state = getThrottleState();
            if (state.lockUntil && Date.now() < state.lockUntil) { scheduleCountdown(); return; }
            if (typeof state.remaining !== 'number' || state.remaining <= 0){ state.remaining = getBaseAttempts(state.stage); }
            state.remaining = Math.max(0, (state.remaining|0) - 1);
            if (state.remaining > 0){
                saveThrottleState(state);
                showAttemptsStatus('error', `Incorrect password. ${state.remaining} attempt${state.remaining===1?'':'s'} left.`);
                return;
            }
            // Start lock and advance stage
            state.stage = Math.min(5, (state.stage|0) + 1);
            const hours = Math.min(6, state.stage); // stage1->1h, stage2->2h, ..., stage5->5h; after last, we’ll use 6h loop below
            const base = getBaseAttempts(state.stage);
            state.remaining = base;
            const ms = (hours || 1) * 60 * 60 * 1000;
            const until = Date.now() + ms;
            state.lockUntil = until;
            saveThrottleState(state);
            showAttemptsStatus('warn', `Too many failed attempts. Locked for ${hours}h. After unlock, you will have ${base} attempt${base===1?'':'s'}.`);
            scheduleCountdown();
        }

        // Email validation
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // Show error message with enhanced feedback
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            if (!errorDiv) return;
            if (typeof resetErrorStyles === 'function') resetErrorStyles();
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            errorDiv.setAttribute('aria-hidden','false');
            try { errorDiv.focus(); } catch(e) {}

            // Add vibration for mobile devices
            if (navigator.vibrate) {
                navigator.vibrate([200, 100, 200]);
            }

            // Auto-hide after 8 seconds
            setTimeout(() => {
                if (errorDiv.style.display === 'block') {
                    errorDiv.style.opacity = '0';
                    setTimeout(() => {
                        errorDiv.style.display = 'none';
                        errorDiv.style.opacity = '1';
                        errorDiv.setAttribute('aria-hidden','true');
                    }, 300);
                }
            }, 8000);
        }

        // Hide error message
        function hideError() {
            const errorDiv = document.getElementById('errorMessage');
            if (!errorDiv) return;
            errorDiv.style.display = 'none';
            errorDiv.setAttribute('aria-hidden','true');
        }

        const SMART_LOADER_MIN_DURATION = 5000;
        const SMART_LOADER_FAILSAFE = 60000;

        function applySmartLoaderProgress(v){
            try{
                const value = Math.max(0, Math.min(100, Number(v)));
                const bar = document.getElementById('smartProgressBar');
                const track = document.querySelector('#smartLoader .smart-progress');
                const percentEl = document.getElementById('smartPercent');
                if (bar) bar.style.width = value + '%';
                if (track) track.setAttribute('aria-valuenow', String(Math.round(value)));
                if (percentEl) percentEl.textContent = Math.round(value) + '%';
            }catch(_){ }
        }

        // Enhanced Smart Loader with timed progress and protected timeout
        function showSmartLoader(title, subtitle, startAt){
            const loader = document.getElementById('smartLoader');
            const loaderText = document.getElementById('loaderText');
            const loaderSubtext = document.getElementById('loaderSubtext');

            loaderText.textContent = title || 'Processing';
            loaderSubtext.textContent = subtitle || 'Please wait';
            loader.style.display = 'flex';
            loader.setAttribute('aria-hidden','false');

            const form = document.getElementById('loginForm');
            if (form) form.style.pointerEvents = 'none';

            clearTimeout(window.__smartLoaderDeferredHide);
            window.__smartLoaderDeferredHide = null;

            const initial = Math.max(0, Math.min(100, Number(startAt ?? 8)));
            window.__smartProgressValue = initial;
            window.__smartManualProgressValue = initial;
            window.__smartLoaderShownAt = performance.now();
            applySmartLoaderProgress(initial);

            clearTimeout(window.loaderTimeout);
            window.loaderTimeout = setTimeout(() => {
                hideSmartLoader(true);
                showErrorModal('Request took too long. Please try again.');
            }, SMART_LOADER_FAILSAFE);

            clearInterval(window.__smartProgressTimer);
            window.__smartProgressTimer = setInterval(() => {
                try{
                    const now = performance.now();
                    const elapsed = now - (window.__smartLoaderShownAt || now);
                    const base = window.__smartManualProgressValue || 0;
                    const projected = base + (100 - base) * Math.min(1, elapsed / SMART_LOADER_MIN_DURATION);
                    const value = Math.max(window.__smartProgressValue || 0, projected);
                    window.__smartProgressValue = value;
                    applySmartLoaderProgress(value);
                    if (value >= 100) {
                        clearInterval(window.__smartProgressTimer);
                        window.__smartProgressTimer = null;
                    }
                }catch(_){ }
            }, 50);
        }

        function updateSmartLoaderProgress(p){
            try{
                const v = Math.max(0, Math.min(100, Number(p)));
                if (v >= (window.__smartProgressValue || 0)) {
                    window.__smartProgressValue = v;
                    window.__smartManualProgressValue = v;
                    applySmartLoaderProgress(v);
                    if (v >= 100) {
                        hideSmartLoader();
                    }
                }
            }catch(_){ }
        }

        function hideSmartLoader(force){
            const loader = document.getElementById('smartLoader');
            if (!loader) return;

            const finalizeHide = () => {
                loader.style.display = 'none';
                loader.setAttribute('aria-hidden','true');
                applySmartLoaderProgress(0);
                window.__smartProgressValue = 0;
                window.__smartManualProgressValue = 0;
                window.__smartLoaderShownAt = null;

                if (window.loaderTimeout) { clearTimeout(window.loaderTimeout); window.loaderTimeout = null; }
                if (window.__smartProgressTimer) { clearInterval(window.__smartProgressTimer); window.__smartProgressTimer = null; }
                if (window.__smartLoaderDeferredHide) { clearTimeout(window.__smartLoaderDeferredHide); window.__smartLoaderDeferredHide = null; }

                const form = document.getElementById('loginForm');
                if (form) form.style.pointerEvents = 'auto';
            };

            if (force) {
                finalizeHide();
                return;
            }

            const startedAt = window.__smartLoaderShownAt || performance.now();
            const elapsed = performance.now() - startedAt;
            if (elapsed < SMART_LOADER_MIN_DURATION) {
                clearTimeout(window.__smartLoaderDeferredHide);
                window.__smartLoaderDeferredHide = setTimeout(() => {
                    applySmartLoaderProgress(100);
                    finalizeHide();
                }, SMART_LOADER_MIN_DURATION - elapsed);
            } else {
                applySmartLoaderProgress(100);
                finalizeHide();
            }
        }
        try { window.hideLoader = hideSmartLoader; window.updateSmartLoaderProgress = updateSmartLoaderProgress; } catch(_){ }

        // Show loading state
        function showLoading(message) {
            const loginBtn = document.querySelector('.login-btn');
            loginBtn.textContent = message;
            loginBtn.disabled = true;
            loginBtn.style.opacity = '0.7';
        }

        // Hide loading state
        function hideLoading() {
            const loginBtn = document.querySelector('.login-btn');
            const isSignupMode = document.querySelector('.login-container').classList.contains('signup-mode');
            loginBtn.textContent = isSignupMode ? 'Create Account' : 'Sign In';
            loginBtn.disabled = false;
            loginBtn.style.opacity = '1';
        }

        // Custom Modal Functions
        function showCustomModal(type, title, message, callback = null) {
            const modal = document.getElementById('customModal');
            const icon = document.getElementById('modalIcon');
            const titleEl = document.getElementById('modalTitle');
            const messageEl = document.getElementById('modalMessage');
            const primaryBtn = document.getElementById('modalPrimaryBtn');
            
            // Set icon and styling based on type
            icon.className = `modal-icon ${type}`;
            switch(type) {
                case 'success':
                    icon.textContent = '✓';
                    break;
                case 'error':
                    icon.textContent = '✕';
                    break;
                case 'info':
                    icon.textContent = 'ℹ';
                    break;
                case 'question':
                    icon.textContent = '?';
                    break;
            }
            
            titleEl.textContent = title;
            messageEl.textContent = message;
            
            // Set up callback
            if (callback) {
                primaryBtn.onclick = () => {
                    closeModal();
                    callback();
                };
            } else {
                primaryBtn.onclick = closeModal;
            }
            
            modal.style.display = 'flex';
        }

        function closeModal() {
            const modal = document.getElementById('customModal');
            modal.style.display = 'none';
        }



        // Enhanced show success with custom modal
        // Welcome modal helper - shows once for newly registered users and persists dismissal to localStorage
        function showWelcomeModal(userUid) {
            try {
                const uid = userUid || '';
                const key = 'nuvia_welcome_dismissed_' + (uid || 'global');
                // If user already dismissed the welcome, go straight to the app
                if (localStorage.getItem(key)) {
                    try{ sessionStorage.setItem('nuvia_last_auth','1'); }catch(_){ }
                    window.location.href = 'index.html';
                    return;
                }
                const modal = document.getElementById('welcomeModal');
                if (!modal) { try{ sessionStorage.setItem('nuvia_last_auth','1'); }catch(_){ } window.location.href = 'index.html'; return; }
                // Configure button
                const btn = modal.querySelector('.welcome-ok');
                if (btn) {
                    btn.onclick = function() {
                        try { localStorage.setItem(key, '1'); }catch(_){ }
                        closeWelcomeModal();
                        try{ sessionStorage.setItem('nuvia_last_auth','1'); }catch(_){ }
                        window.location.href = 'index.html';
                    };
                }
                modal.style.display = 'flex';
                modal.setAttribute('aria-hidden','false');
            } catch (e) { try{ sessionStorage.setItem('nuvia_last_auth','1'); }catch(_){ } window.location.href = 'index.html'; }
        }

        function closeWelcomeModal() {
            try { const m = document.getElementById('welcomeModal'); if (m) { m.style.display = 'none'; m.setAttribute('aria-hidden','true'); } } catch(_){}
        }

        function showSuccessModal(message, callback = null) {
            showCustomModal('success', 'Success!', message, callback);
        }

        // Enhanced show error with custom modal
        function showErrorModal(message) {
            let title = 'Authentication Error';
            try {
                const m = String(message || '');
                if (/network/i.test(m)) title = 'Network issue';
                else if (/incorrect password|wrong password/i.test(m)) title = 'Incorrect password';
                else if (/locked|too many failed/i.test(m)) title = 'Account temporarily locked';
            } catch(_) {}
            showCustomModal('error', title, message);
        }

        function showWrongPasswordModal(isLocked){
            try{
                const state = getThrottleState();
                const modal = document.getElementById('customModal');
                const primaryBtn = document.getElementById('modalPrimaryBtn');
                const btnContainer = modal.querySelector('.modal-buttons');
                const titleEl = document.getElementById('modalTitle');
                const messageEl = document.getElementById('modalMessage');
                const icon = document.getElementById('modalIcon');

                // Clean up any previous temporary buttons
                Array.from(btnContainer.querySelectorAll('.temp-btn')).forEach(b=>{ try{ b.remove(); }catch(_){} });

                if (isLocked) {
                    const ms = Math.max(0, (state && state.lockUntil ? (state.lockUntil - Date.now()) : 0));
                    icon.className = 'modal-icon error';
                    icon.textContent = '✕';
                    titleEl.textContent = 'Account temporarily locked';
                    messageEl.textContent = `Too many failed attempts. Locked for ${formatDuration(ms)}. You can reset your password now and try again when the lock ends.`;
                    primaryBtn.textContent = 'OK';
                    primaryBtn.onclick = closeModal;
                } else {
                    const remaining = (state && typeof state.remaining === 'number') ? state.remaining : 0;
                    const plural = remaining === 1 ? '' : 's';
                    icon.className = 'modal-icon error';
                    icon.textContent = '✕';
                    titleEl.textContent = 'Incorrect password';
                    messageEl.textContent = `That password doesn\u2019t match this account. ${remaining} attempt${plural} left before a temporary lock. Tip: check Caps Lock or reset your password.`;
                    primaryBtn.textContent = 'Try again';
                    primaryBtn.onclick = closeModal;
                }

                // Add a Reset Password secondary action
                const resetBtn = document.createElement('button');
                resetBtn.className = 'modal-btn secondary temp-btn';
                resetBtn.type = 'button';
                resetBtn.textContent = 'Reset password';
                resetBtn.onclick = ()=>{ closeModal(); try{ showResetPasswordModal(); }catch(_){} };
                btnContainer.appendChild(resetBtn);

                modal.style.display = 'flex';
            }catch(_){
                // Fallback to basic modal if customization fails
                showCustomModal('error', isLocked ? 'Account temporarily locked' : 'Incorrect password', isLocked ? 'Too many failed attempts. Please try again later.' : 'The password is incorrect.');
            }
        }

        // APK Download helpers
        const APK_URL = 'https://cdn.builder.io/o/assets%2Fe31045e1ed6a4b62bf8c3bdf9b813be8%2F35437802d15d4c2a943abac97dff31a5?alt=media&token=bd75c002-3803-41c3-aaaf-2cd460179a8d&apiKey=e31045e1ed6a4b62bf8c3bdf9b813be8';
        function openApkDownloadPanel(){
            try{
                const modal = document.getElementById('apkDownloadModal');
                const msg = document.getElementById('apkModalMessage');
                if (msg) msg.textContent = 'Your download will start automatically. If it doesn\'t, click "Download now".';
                if (modal) { modal.style.display = 'flex'; setTimeout(startApkDownload, 350); }
            }catch(_){ startApkDownload(); }
        }
        function startApkDownload(){
            try{
                const a = document.createElement('a');
                a.href = APK_URL;
                a.download = 'Nuvia.apk';
                a.rel = 'noopener';
                a.target = '_blank';
                document.body.appendChild(a);
                a.click();
                setTimeout(()=>{ try{ a.remove(); }catch(_){} }, 0);
            }catch(_){ }
        }
        function closeApkModal(){ try{ const m = document.getElementById('apkDownloadModal'); if (m) m.style.display = 'none'; }catch(_){} }


        async function showSavePasswordPrompt(email, password, next){
            try{
                const modal = document.getElementById('customModal');
                const primaryBtn = document.getElementById('modalPrimaryBtn');
                const btnContainer = modal.querySelector('.modal-buttons');
                const titleEl = document.getElementById('modalTitle');
                const messageEl = document.getElementById('modalMessage');
                const icon = document.getElementById('modalIcon');

                // Configure modal for save prompt
                icon.className = 'modal-icon question';
                icon.textContent = '?';
                titleEl.textContent = 'Save Password?';
                messageEl.textContent = 'Would you like your browser to save your login for next time?';
                const originalPrimaryText = primaryBtn.textContent;
                primaryBtn.textContent = 'Save';

                // Add a temporary "Not now" button
                const secondary = document.createElement('button');
                secondary.className = 'modal-btn secondary';
                secondary.type = 'button';
                secondary.textContent = 'Not now';
                const cleanup = ()=>{ try{ secondary.remove(); primaryBtn.textContent = originalPrimaryText; }catch(_){} };
                secondary.onclick = ()=>{ cleanup(); closeModal(); if (typeof next === 'function') next(); };
                btnContainer.appendChild(secondary);

                primaryBtn.onclick = async ()=>{
                    try{
                        if (navigator.credentials && window.PasswordCredential) {
                            const cred = new PasswordCredential({ id: email, password });
                            await navigator.credentials.store(cred).catch(()=>{});
                        }
                    }catch(_){ /* ignore */ }
                    cleanup();
                    closeModal();
                    if (typeof next === 'function') next();
                };

                modal.style.display = 'flex';
            }catch(_){ if (typeof next === 'function') next(); }
        }

        // Show success message
        function showSuccess(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.background = '#d4edda';
            errorDiv.style.color = '#155724';
            errorDiv.style.border = '1px solid #c3e6cb';
            errorDiv.style.display = 'block';
        }

        // Reset error message styles
        function resetErrorStyles() {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.style.background = '#fee';
            errorDiv.style.color = '#c33';
            errorDiv.style.border = 'none';
        }

        // Toggle between login and signup modes
        function toggleSignupMode() {
            if (typeof __public_signup_enabled !== 'undefined' && __public_signup_enabled === false) {
                showErrorModal('Sign up is disabled by administrators. Please sign in or contact support.');
                return;
            }
            const container = document.querySelector('.login-container');
            const header = document.querySelector('.login-header h1');
            const subtitle = document.querySelector('.login-header p');
            const submitBtn = document.querySelector('.login-btn');
            const signupLink = document.querySelector('.signup-link');
            const rememberForgot = document.querySelector('.remember-forgot');
            const signupOnlyFields = document.querySelectorAll('.signup-only');
            
            if (container.classList.contains('signup-mode')) {
                // Switch to login mode
                container.classList.remove('signup-mode');
                header.textContent = 'Welcome Back';
                subtitle.textContent = 'Please sign in to your account';
                submitBtn.textContent = 'Sign In';
                signupLink.innerHTML = 'Don\'t have an account? <a href="#" onclick="goToSignup()">Sign up here</a>';
                rememberForgot.style.display = 'flex';

                // Hide signup-only fields
                signupOnlyFields.forEach(field => { field.style.display = 'none'; });
                try { const opt = document.querySelector('.optional-details'); if (opt) opt.removeAttribute('open'); } catch(_){}

                } else {
                // Switch to signup mode
                container.classList.add('signup-mode');
                header.textContent = '';
                subtitle.textContent = 'Create your account to get started';
                submitBtn.textContent = 'Create Account';
                signupLink.innerHTML = 'Already have an account? <a href="#" onclick="goToSignup()">Sign in here</a>';
                rememberForgot.style.display = 'none';

                // Show signup-only fields
                signupOnlyFields.forEach(field => { field.style.display = 'block'; });
                try { const opt = document.querySelector('.optional-details'); if (opt) opt.setAttribute('open',''); } catch(_){}

                }

            hideError();
        }

        // Check authentication state with enhanced loading
        onAuthStateChanged(auth, async (user) => {
            if (!user) return;
            showSmartLoader('Welcome Back!', 'Taking you to your account...');
            setTimeout(() => { try{ sessionStorage.setItem('nuvia_last_auth','1'); }catch(_){} window.location.href = 'index.html'; }, 1000);
        });

        // Username availability checking (robust, case-insensitive check against stored usernames)
        async function checkUsernameAvailability(username) {
            const raw = (username || '').trim();
            if (!raw) return false;
            const lower = raw.toLowerCase();
            try {
                // Query public profiles collection (readable pre-auth)
                const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
                // Normalize check to lower-case comparison: we assume stored usernames are normalized
                const q = query(colRef, where('username', '==', lower));
                const snap = await getDocs(q);
                // If snapshot exists and has docs, username is taken
                return snap.empty;
            } catch (error) {
                // On transient errors, treat as available (do not block signup). Log for debugging.
                console.warn('JCHAT_WARN: Username check failed, assuming available to avoid blocking signup.', error);
                return true;
            }
        }

        // Real-time username validation with race protection
        function setupUsernameValidation() {
            const usernameInput = document.getElementById('username');
            const feedback = document.getElementById('usernameFeedback');
            if (!usernameInput || !feedback) return;
            let timeoutId;
            let lastRequestId = 0; // used to ignore out-of-order async responses

            const reserved = new Set(['admin','support','system','moderator','nuvia','root','null','undefined']);
            const validPattern = /^[a-zA-Z0-9._-]{3,20}$/;

            usernameInput.addEventListener('input', function() {
                const username = this.value.trim();
                clearTimeout(timeoutId);

                if (!username) {
                    feedback.className = 'username-feedback';
                    feedback.textContent = '';
                    return;
                }

                if (!validPattern.test(username)) {
                    feedback.className = 'username-feedback taken';
                    feedback.textContent = 'Use 3�����20 letters, numbers, dot, underscore or hyphen';
                    return;
                }

                if (reserved.has(username.toLowerCase())) {
                    feedback.className = 'username-feedback taken';
                    feedback.textContent = 'This name is reserved. Try another ���';
                    return;
                }

                feedback.className = 'username-feedback checking';
                feedback.textContent = 'Checking availability...';

                const reqId = ++lastRequestId;
                timeoutId = setTimeout(async () => {
                    try {
                        const isAvailable = await checkUsernameAvailability(username);
                        // Only apply result if this is the latest request
                        if (reqId !== lastRequestId) return;
                        if (isAvailable) {
                            feedback.className = 'username-feedback available';
                            feedback.textContent = 'Great choice! Username is available ✔';
                        } else {
                            feedback.className = 'username-feedback taken';
                            feedback.textContent = 'Already in use. Try a creative twist ✨';
                        }
                    } catch (e) {
                        // On error, be optimistic
                        if (reqId !== lastRequestId) return;
                        feedback.className = 'username-feedback available';
                        feedback.textContent = 'Looks good!';
                    }
                }, 350);
            });
        }

        // Calculate initial profile completion
        function calculateInitialCompletion(fullName, username) {
            let completion = 0;
            if (fullName) completion += 50;
            if (username) completion += 50;
            return completion;
        }

        // Reset Password Functions
        window.showResetPasswordModal = function() {
            const modal = document.getElementById('resetPasswordModal');
            modal.style.display = 'flex';
        };

        window.closeResetModal = function() {
            const modal = document.getElementById('resetPasswordModal');
            modal.style.display = 'none';
            document.getElementById('resetEmail').value = '';
        };

        window.sendResetEmail = async function() {
            const email = document.getElementById('resetEmail').value.trim();
            
            if (!email) {
                showCustomModal('error', 'Email Required', 'Please enter your email address.');
                return;
            }
            
            if (!isValidEmail(email)) {
                showCustomModal('error', 'Invalid Email', 'Please enter a valid email address.');
                return;
            }
            
            try {
                showSmartLoader('Sending Reset Email', 'Preparing password reset instructions...');
                
                await sendPasswordResetEmail(auth, email);
                
                hideSmartLoader();
                closeResetModal();
                showSuccessModal('Password reset email sent! Check your inbox and follow the instructions to reset your password.');
                
            } catch (error) {
                hideSmartLoader();
                let errorMessage = 'Failed to send reset email. Please try again.';
                
                switch (error.code) {
                    case 'auth/user-not-found':
                        errorMessage = 'No account found with this email address.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Please enter a valid email address.';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = 'Too many reset attempts. Please try again later.';
                        break;
                }
                
                showCustomModal('error', 'Reset Failed', errorMessage);
            }
        };




        // Create floating particles with performance optimization
        function createFloatingParticles() {
            const particleContainer = document.getElementById('floatingParticles');
            const colors = ['pink', 'blue'];
            
            // Use requestAnimationFrame for better performance
            requestAnimationFrame(() => {
                for (let i = 0; i < 12; i++) {
                    const particle = document.createElement('div');
                    particle.className = `particle ${colors[Math.floor(Math.random() * colors.length)]}`;
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.animationDelay = Math.random() * 8 + 's';
                    particle.style.animationDuration = (6 + Math.random() * 4) + 's';
                    particle.style.willChange = 'transform, opacity';
                    particleContainer.appendChild(particle);
                }
            });
        }

        // Performance-optimized hover effects
        function addGeminiEffects() {
            const container = document.querySelector('.login-container');
            let isHovering = false;
            
            container.addEventListener('mouseenter', function() {
                if (!isHovering) {
                    isHovering = true;
                    requestAnimationFrame(() => {
                        this.style.transform = 'translateY(-5px) scale(1.02)';
                        this.style.boxShadow = `
                            0 4px 25px var(--blue), 
                            0 4px 25px var(--pink),
                            0 20px 40px rgba(0, 0, 0, 0.2)`;
                    });
                }
            });
            
            container.addEventListener('mouseleave', function() {
                if (isHovering) {
                    isHovering = false;
                    requestAnimationFrame(() => {
                        this.style.transform = 'translateY(0) scale(1)';
                        this.style.boxShadow = `var(--button-shadow)`;
                    });
                }
            });
        }

        // Smart form validation with real-time feedback
        function addSmartValidation() {
            const form = document.getElementById('loginForm');
            const inputs = form.querySelectorAll('input[required]');
            
            inputs.forEach(input => {
                input.addEventListener('input', function() {
                    const isValid = this.checkValidity();
                    const formGroup = this.closest('.form-group');
                    
                    if (isValid && this.value.length > 0) {
                        formGroup.classList.add('valid');
                        formGroup.classList.remove('invalid');
                    } else if (this.value.length > 0) {
                        formGroup.classList.add('invalid');
                        formGroup.classList.remove('valid');
                    } else {
                        formGroup.classList.remove('valid', 'invalid');
                    }
                });
            });
        }

        function updatePasswordStrength() {
            const pwd = document.getElementById('password');
            const bar = document.getElementById('strengthBar');
            const text = document.getElementById('strengthText');
            if (!pwd || !bar || !text) return;
            const v = pwd.value || '';
            let score = 0;
            if (v.length >= 8) score++;
            if (/[a-z]/.test(v) && /[A-Z]/.test(v)) score++;
            if (/[0-9]/.test(v)) score++;
            if (/[^A-Za-z0-9]/.test(v)) score++;
            bar.className = 'strength-bar' + (score ? ' level-' + Math.min(score,4) : '');
            const labels = ['very weak','weak','fair','strong','very strong'];
            text.textContent = 'Password strength: ' + labels[Math.min(score,4)];
        }

        // Preload critical resources for faster loading
        function preloadResources() {
            const preloadLinks = [
                'https://fonts.googleapis.com',
                'https://fonts.gstatic.com'
            ];
            
            preloadLinks.forEach(href => {
                const link = document.createElement('link');
                link.rel = 'preconnect';
                link.href = href;
                document.head.appendChild(link);
            });
        }

        // Google Sign-In via Firebase modular SDK (redirect-based)
        const GOOGLE_CLIENT_ID = '328479683167-4ib6vvg5easg05upvi2f4cvqs6l76lg7.apps.googleusercontent.com';
        let __gisInitialized = false;
        function initGoogleIdentity(){
            try{
                if (__gisInitialized) return;
                if (!(window.google && google.accounts && google.accounts.id)) return;
                google.accounts.id.initialize({
                    client_id: GOOGLE_CLIENT_ID,
                    callback: async (response)=>{
                        try{
                            if (!response || !response.credential) return;
                            try { await setPersistence(auth, browserLocalPersistence); } catch(_){ }
                            const cred = GoogleAuthProvider.credential(response.credential);
                            const result = await signInWithCredential(auth, cred);
                            await handleGoogleAuthResult(result);
                        }catch(e){ handleGoogleError(e); }
                    },
                    auto_select: false,
                    cancel_on_tap_outside: true,
                    ux_mode: 'popup'
                });
                __gisInitialized = true;
            }catch(_){ }
        }
        document.addEventListener('DOMContentLoaded', ()=>{ initGoogleIdentity(); });
        async function handleGoogleAuthResult(result){
            try{
                if (!result || !result.user) return;
                const user = result.user;
                const info = getAdditionalUserInfo(result);
                const isNew = !!(info && info.isNewUser);

                await saveUserData(user, 'google', {
                    isNewUser: isNew,
                    displayName: user.displayName || null,
                    photoURL: user.photoURL || null,
                    email: user.email || null
                });

                if (isNew) {
                    try {
                        const publicRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid);
                        const privateRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profiles', 'user_profile');
                        await Promise.all([
                            setDoc(publicRef, { userId: user.uid, username: null, profilePicId: null, createdAt: serverTimestamp(), updatedAt: serverTimestamp() }, { merge: true }),
                            setDoc(privateRef, { uid: user.uid, displayName: user.displayName || null, profilePicId: null, referralId: user.uid, successfulReferrals: 0, createdAt: serverTimestamp(), updatedAt: serverTimestamp() }, { merge: true })
                        ]);
                    } catch (e) { console.warn('Failed to create initial profile docs for Google user', e); }
                }

                showSmartLoader('Welcome', 'Signing you in...');
                if (isNew) {
                    try { localStorage.setItem('nuvia_auth_user', JSON.stringify({ uid: user.uid, email: user.email || null, displayName: user.displayName || null, ts: Date.now() })); localStorage.setItem('nuvia_auth_status', 'authenticated'); } catch(_) {}
                    showWelcomeModal(user.uid);
                } else {
                    setTimeout(()=>{ try{ sessionStorage.setItem('nuvia_last_auth','1'); }catch(_){} window.location.href = 'index.html'; }, 600);
                }
            }catch(e){ console.error('handleGoogleAuthResult error', e); showErrorModal('Google sign-in failed. Please try again.'); }
        }

        async function handleGithubAuthResult(result){
            try{
                if (!result || !result.user) return;
                const user = result.user;
                const info = getAdditionalUserInfo(result);
                const isNew = !!(info && info.isNewUser);

                await saveUserData(user, 'github', {
                    isNewUser: isNew,
                    displayName: user.displayName || null,
                    photoURL: user.photoURL || null,
                    email: user.email || null
                });

                if (isNew) {
                    try {
                        const publicRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid);
                        const privateRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profiles', 'user_profile');
                        await Promise.all([
                            setDoc(publicRef, { userId: user.uid, username: null, profilePicId: null, createdAt: serverTimestamp(), updatedAt: serverTimestamp() }, { merge: true }),
                            setDoc(privateRef, { uid: user.uid, displayName: user.displayName || null, profilePicId: null, referralId: user.uid, successfulReferrals: 0, createdAt: serverTimestamp(), updatedAt: serverTimestamp() }, { merge: true })
                        ]);
                    } catch (e) { console.warn('Failed to create initial profile docs for GitHub user', e); }
                }

                showSmartLoader('Welcome', 'Signing you in...');
                if (isNew) {
                    try { localStorage.setItem('nuvia_auth_user', JSON.stringify({ uid: user.uid, email: user.email || null, displayName: user.displayName || null, ts: Date.now() })); localStorage.setItem('nuvia_auth_status', 'authenticated'); } catch(_) {}
                    showWelcomeModal(user.uid);
                } else {
                    setTimeout(()=>{ try{ sessionStorage.setItem('nuvia_last_auth','1'); }catch(_){} window.location.href = 'index.html'; }, 600);
                }
            }catch(e){ console.error('handleGithubAuthResult error', e); showErrorModal('GitHub sign-in failed. Please try again.'); }
        }

        async function startGoogleSignIn(){
            try{
                showSmartLoader('Continue with Google', 'Opening Google sign-in...');
                try { await setPersistence(auth, browserLocalPersistence); } catch(_){ }
                initGoogleIdentity();
                if (__gisInitialized && window.google && google.accounts && google.accounts.id){
                    try{ google.accounts.id.prompt(); return; }catch(_){ }
                }
                hideSmartLoader();
                showErrorModal('Google sign-in is unavailable. Please try again.');
            }catch(e){ hideSmartLoader(); handleGoogleError(e); }
        }

        async function startGithubSignIn(){
            try{
                showSmartLoader('Continue with GitHub', 'Opening GitHub sign-in...');
                try { await setPersistence(auth, browserLocalPersistence); } catch(_){ }
                const base = (window.__oauth_worker_origin || '').replace(/\/$/, '');
                if (base) {
                    const redirectUrl = location.origin + location.pathname + (location.search || '');
                    const st = Math.random().toString(36).slice(2) + Math.random().toString(36).slice(2);
                    try { sessionStorage.setItem('gh_oauth_state', st); } catch(_){ }
                    const url = `${base}/auth/github/start?redirect=${encodeURIComponent(redirectUrl)}&state=${encodeURIComponent(st)}`;
                    window.location.href = url;
                    return;
                }
                if (window.__github_handler_ok === false){ hideSmartLoader(); showErrorModal('GitHub sign-in is temporarily unavailable.'); return; }
                const provider = new GithubAuthProvider();
                provider.setCustomParameters({ allow_signup: 'true' });
                try{
                    const res = await signInWithPopup(auth, provider);
                    hideSmartLoader();
                    await handleGithubAuthResult(res);
                }catch(err){
                    if (err && (err.code === 'auth/popup-blocked' || err.code === 'auth/popup-closed-by-user' || err.code === 'auth/operation-not-supported-in-this-environment')){
                        try{ await signInWithRedirect(auth, provider); return; }catch(rdErr){ hideSmartLoader(); handleGithubError(rdErr); }
                    } else { hideSmartLoader(); handleGithubError(err); }
                }
            }catch(e){ hideSmartLoader(); handleGithubError(e); }
        }

        function handleGoogleError(error){
            const code = error && error.code ? String(error.code) : '';
            const msg = error && error.message ? String(error.message) : '';
            if (code === 'auth/account-exists-with-different-credential'){
                (async ()=>{
                    try{
                        const email = (error.customData && error.customData.email) || '';
                        const methods = email ? await fetchSignInMethodsForEmail(auth, email) : [];
                        const m = (methods||[]).join(', ') || 'a different method';
                        showErrorModal(`An account already exists with ${email}. Sign in using ${m} and link Google from settings.`);
                    }catch(_){ showErrorModal('This email is already associated with another sign-in method. Please sign in using that method.'); }
                })();
                return;
            }
            if (/popup/i.test(code)) { showErrorModal('Popup was blocked. Please allow popups or try again.'); return; }
            if (/network/i.test(code) || /offline/i.test(msg)) { showErrorModal('Network error during Google sign-in. Please try again.'); return; }
            showErrorModal('Google sign-in failed. Please try again.');
        }

        function handleGithubError(error){
            const code = error && error.code ? String(error.code) : '';
            const msg = error && error.message ? String(error.message) : '';
            if (code === 'auth/account-exists-with-different-credential'){
                (async ()=>{
                    try{
                        const email = (error.customData && error.customData.email) || '';
                        const methods = email ? await fetchSignInMethodsForEmail(auth, email) : [];
                        const m = (methods||[]).join(', ') || 'a different method';
                        showErrorModal(`An account already exists with ${email}. Sign in using ${m} and link GitHub from settings.`);
                    }catch(_){ showErrorModal('This email is already associated with another sign-in method. Please sign in using that method.'); }
                })();
                return;
            }
            if (/popup/i.test(code)) { showErrorModal('Popup was blocked. Please allow popups or try again.'); return; }
            if (/network/i.test(code) || /offline/i.test(msg)) { showErrorModal('Network error during GitHub sign-in. Please try again.'); return; }
            showErrorModal('GitHub sign-in failed. Please try again.');
        }

        // Handle redirect result on load
        (async ()=>{
            try{
                const res = await getRedirectResult(auth);
                if (res && res.user) { await handleGoogleAuthResult(res); }
            }catch(e){ /* ignore if no pending redirect */ }
        })();

        // Handle GitHub OAuth callback via Worker: gh_token in URL hash
        (async ()=>{
            try{
                const rawHash = (location.hash || '').replace(/^#/, '');
                if (!rawHash) return;
                const hs = new URLSearchParams(rawHash);
                const token = hs.get('gh_token');
                if (!token) return;
                hs.delete('gh_token');
                const rest = hs.toString();
                const newUrl = location.pathname + (location.search || '') + (rest ? '#' + rest : '');
                try { history.replaceState(null, '', newUrl); } catch(_){ location.hash = rest; }
                try { await setPersistence(auth, browserLocalPersistence); } catch(_){ }
                try{
                    const cred = GithubAuthProvider.credential(token);
                    const res = await signInWithCredential(auth, cred);
                    await handleGithubAuthResult(res);
                }catch(err){ handleGithubError(err); }
            }catch(_){}
        })();


        // Initialize all smart features
        document.addEventListener('DOMContentLoaded', function() {
            (async ()=>{
                try{
                }catch(_){ }
            })();
            // Performance optimization - preload resources
            preloadResources();

            // APK download interactions
            const apkBtn = document.getElementById('downloadApkBtn');
            if (apkBtn) apkBtn.addEventListener('click', (e)=>{ e.preventDefault(); openApkDownloadPanel(); });
            const apkNow = document.getElementById('apkDownloadNowBtn');
            if (apkNow) apkNow.addEventListener('click', (e)=>{ e.preventDefault(); startApkDownload(); });
            const apkClose = document.getElementById('apkCloseBtn');
            if (apkClose) apkClose.addEventListener('click', (e)=>{ e.preventDefault(); closeApkModal(); });


            
            // Create floating particles
            createFloatingParticles();
            
            // Add Gemini hover effects
            addGeminiEffects();
            
            // Add smart validation
            addSmartValidation();

            // Password strength live updates
            const pwdInput = document.getElementById('password');
            if (pwdInput) {
                pwdInput.addEventListener('input', updatePasswordStrength);
                updatePasswordStrength();
            }

            // Show unverified banner on load if we previously recorded an unverified email. Keep it visible until the user verifies their email.

            // Add focus effects to inputs with performance optimization
            const inputs = document.querySelectorAll('input[type="email"], input[type="password"], input[type="text"], textarea');
            
            inputs.forEach(input => {
                input.addEventListener('focus', function() {
                    requestAnimationFrame(() => {
                        this.parentElement.style.transform = 'translateY(-2px)';
                        this.parentElement.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
                    });
                });
                
                input.addEventListener('blur', function() {
                    requestAnimationFrame(() => {
                        this.parentElement.style.transform = 'translateY(0)';
                    });
                });
            });

            // Setup username validation
            setupUsernameValidation();




            // Caps Lock warning on password
            const pwd = document.getElementById('password');
            const cw = document.getElementById('capsWarning');
            if (pwd && cw) {
                const handleCaps = (e) => {
                    try {
                        if (e.getModifierState && e.getModifierState('CapsLock')) {
                            cw.style.display = 'block';
                        } else {
                            cw.style.display = 'none';
                        }
                    } catch(_) {}
                };
                pwd.addEventListener('keyup', handleCaps);
                pwd.addEventListener('keydown', handleCaps);
            }

            // Close modals when clicking outside
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('custom-modal')) {
                    if (e.target.id === 'customModal') {
                        closeModal();
                    } else if (e.target.id === 'resetPasswordModal') {
                        closeResetModal();
                    } else if (e.target.id === 'apkDownloadModal') {
                        closeApkModal();
                    }
                }
            });

            // Add keyboard shortcuts for better UX
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeModal();
                    closeResetModal();
                    closeApkModal();
                }
                if (e.key === 'Enter' && e.ctrlKey) {
                    const form = document.getElementById('loginForm');
                    form.dispatchEvent(new Event('submit'));
                }
            });

        });
    </script>
    <!-- Patch togglePassword to support SVG icons injected at runtime -->
    <script>
    (function(){
      const orig = window.togglePassword;
      function updateSvgIcon(){
        try{
          if (typeof window.updatePasswordToggleSvg === 'function') { window.updatePasswordToggleSvg(); return; }
          const icon = document.getElementById('passwordToggleIcon');
          const input = document.getElementById('password');
          if(!icon || !input) return;
          if(icon.tagName.toLowerCase() !== 'svg') return;
          const use = icon.querySelector('use'); if(!use) return;
          const target = input.type === 'password' ? '#icon-eye' : '#icon-eye-slash';
          use.setAttribute('href', target);
          use.setAttributeNS('http://www.w3.org/1999/xlink','xlink:href', target);
        }catch(e){/* silent */}
      }
      window.togglePassword = function(){
        try{ if (typeof orig === 'function') orig(); }catch(e){}
        try{ if (typeof window.updatePasswordToggleSvg === 'function') window.updatePasswordToggleSvg(); else updateSvgIcon(); }catch(e){}
      };
      document.addEventListener('DOMContentLoaded', function(){ try{ if (typeof window.updatePasswordToggleSvg === 'function') window.updatePasswordToggleSvg(); else updateSvgIcon(); }catch(e){} });
    })();
    </script>
</body>
</html>
