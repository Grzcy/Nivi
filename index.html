
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Nuvia - Home</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* Basic styles from wallet.html */
        :root {
            --pink: #ff2e92;
            --blue: #00d5ff;
            --yellow: #ffc107;
            --white: #fff;
            --text-light: rgba(255, 255, 255, .7);
            --card-background: linear-gradient(145deg, rgba(255, 255, 255, .03), rgba(255, 255, 255, .01));
            --border-light: rgba(255, 255, 255, .05);
            --radius: 20px;
        }
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #1a1a2e;
            color: var(--white);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .jcoin-balance-card {
            background: var(--card-background);
            border: 1px solid var(--border-light);
            border-radius: var(--radius);
            padding: 2rem;
            width: 100%;
            max-width: 800px;
            cursor: pointer;
            text-align: center;
        }
        .jcoin-balance-card h2 {
            margin-top: 0;
        }
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .modal-content {
            background: #2a2a4a;
            border-radius: var(--radius);
            padding: 2rem;
            width: 90%;
            max-width: 450px;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .modal-content h3 { margin: 0; }
        .button-group { display: flex; justify-content: flex-end; gap: 0.8rem; }
        .modal-button { padding: 10px 20px; border: none; border-radius: 15px; cursor: pointer; }
        .confirm-button { background: var(--pink); color: var(--white); }
        .cancel-button { background: #444; color: var(--white); }
        .input-group { display: flex; flex-direction: column; gap: 8px; }
        .input-group label { font-weight: 600; }
        .input-group input { padding: 10px; border-radius: 8px; border: 1px solid var(--border-light); background: #333; color: var(--white); }

        /* Pink and yellow background for the payment panel */
        #paymentPanel .modal-content {
            background: linear-gradient(135deg, var(--pink), var(--yellow));
        }
    </style>
</head>
<body>
    <!-- JCoin Balance Display -->
    <div id="jcoinBalanceCard" class="jcoin-balance-card">
        <h2>JCoin Balance</h2>
        <p>JCoins: <span id="walletChipAmount">0</span></p>
        <p>Naira Equivalent: ₦<span id="jcoinRateSpan">0.00</span></p>
        <small>(Click to manage wallet)</small>
    </div>

    <!-- Wallet Locked Modal -->
    <div id="walletLockedModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="walletLockedTitle" style="display:none;">
        <div class="modal-content">
            <h3 id="walletLockedTitle"><i class="fas fa-unlock-alt"></i> Unlock Your Wallet & Access Premium Features!</h3>
            <p style="color:var(--text-light); line-height: 1.6;">Your wallet is currently locked, limiting your access to exclusive features. For a <strong>one-time fee of ₦5000</strong>, you can <strong>permanently unlock</strong> your wallet and enjoy the full Nuvia experience, including premium content, special rewards, and unlimited transactions. A developer will activate your wallet as soon as your payment is confirmed.</p>
            <div class="button-group" style="display:flex;gap:10px;justify-content:flex-end;">
                <button id="closeWalletLockedBtn" class="modal-button cancel-button">Maybe Later</button>
                <button id="walletPayBtn" class="modal-button confirm-button">Unlock Now for ₦5000</button>
            </div>
        </div>
    </div>

    <!-- Payment Panel -->
    <div id="paymentPanel" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="paymentPanelTitle" style="display:none;">
        <div class="modal-content">
            <h3 id="paymentPanelTitle">Unlock Wallet Payment</h3>
            <p>Please enter your payment details. The developer will be notified to unlock your wallet after submission.</p>
            <div class="input-group">
                <label for="paymentName">Full Name</label>
                <input type="text" id="paymentName" placeholder="Enter your full name">
            </div>
            <div class="input-group">
                <label for="paymentEmail">Email</label>
                <input type="email" id="paymentEmail" placeholder="Enter your email">
            </div>
            <div class="input-group">
                <label for="paymentProof">Payment Proof (Screenshot)</label>
                <input type="file" id="paymentProof" accept="image/*">
            </div>
            <div class="button-group">
                <button id="cancelPaymentBtn" class="modal-button cancel-button">Cancel</button>
                <button id="submitPaymentBtn" class="modal-button confirm-button">Submit Payment</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDz-8N0totzvMCvonF9pKj9RsoH3J8xL0w",
            authDomain: "jchat-1.firebaseapp.com",
            databaseURL: "https://jchat-1-default-rtdb.firebaseio.com",
            projectId: "jchat-1",
            storageBucket: "jchat-1.firebasestorage.app",
            messagingSenderId: "328479683167",
            appId: "1:328479683167:web:276c0b7e8ea44dd2d6a1ea",
            measurementId: "G-S6Z9GG0R9P"
        };
        const appId = 'default-app-id';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const walletPayBtn = document.getElementById('walletPayBtn');
        const paymentPanel = document.getElementById('paymentPanel');
        const cancelPaymentBtn = document.getElementById('cancelPaymentBtn');
        const submitPaymentBtn = document.getElementById('submitPaymentBtn');
        const closeWalletLockedBtn = document.getElementById('closeWalletLockedBtn');
        const walletLockedModal = document.getElementById('walletLockedModal');
        const jcoinBalanceCard = document.getElementById('jcoinBalanceCard');

        // These elements are now in the HTML
        const jcoinRateSpan = document.getElementById('jcoinRateSpan');
        const walletChipAmount = document.getElementById('walletChipAmount');

        let currentSystemSettings = {};
        const SYSTEM_SETTINGS_DOC_REF = doc(db, "artifacts", appId, "public", "data", "settings", "system_settings");

        async function fetchSystemSettings() {
            try {
                const docSnap = await getDoc(SYSTEM_SETTINGS_DOC_REF);
                if (docSnap.exists()) {
                    currentSystemSettings = docSnap.data();
                } else {
                    // Default settings if not found
                    currentSystemSettings = { jcoinNairaRate: 0.0005 };
                }
            } catch (error) {
                console.error("Error fetching system settings:", error);
                currentSystemSettings = { jcoinNairaRate: 0.0005 }; // Fallback
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                await fetchSystemSettings();
                const userProfileDocRef = doc(db, "artifacts", appId, "users", user.uid, "profiles", "user_profile");
                
                try {
                    const docSnap = await getDoc(userProfileDocRef);
                    if (docSnap.exists()) {
                        const userData = docSnap.data();
                        const jCoins = userData.jCoins || 0;
                        const walletUnlocked = userData.walletUnlocked || false;

                        walletChipAmount.textContent = jCoins;
                        jcoinRateSpan.textContent = (jCoins * (currentSystemSettings.jcoinNairaRate || 0)).toFixed(4);

                        // If wallet is locked, clicking the card should show the modal
                        if (!walletUnlocked) {
                             jcoinBalanceCard.addEventListener('click', () => {
                                walletLockedModal.style.display = 'flex';
                            });
                        } else {
                            // Optional: handle case where wallet is already unlocked
                            jcoinBalanceCard.title = "Your wallet is unlocked.";
                            jcoinBalanceCard.style.cursor = "default";
                        }
                    } else {
                         walletChipAmount.textContent = 0;
                         jcoinRateSpan.textContent = (0).toFixed(4);
                         // Wallet is effectively locked if profile doesn't exist
                         jcoinBalanceCard.addEventListener('click', () => {
                            walletLockedModal.style.display = 'flex';
                        });
                    }
                } catch (error) {
                    console.error("Error fetching user profile:", error);
                    walletChipAmount.textContent = 'Error';
                    jcoinRateSpan.textContent = 'Error';
                }

            } else {
                // Handle signed out state
                walletChipAmount.textContent = 'N/A';
                jcoinRateSpan.textContent = 'N/A';
                // Redirect to login or show a message
                window.location.href = 'login.html';
            }
        });
        
        // --- Modal Logic ---
        walletPayBtn.addEventListener('click', () => {
            walletLockedModal.style.display = 'none';
            paymentPanel.style.display = 'flex';
        });

        cancelPaymentBtn.addEventListener('click', () => {
            paymentPanel.style.display = 'none';
        });

        closeWalletLockedBtn.addEventListener('click', () => {
            walletLockedModal.style.display = 'none';
        });

        submitPaymentBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (user) {
                const paymentName = document.getElementById('paymentName').value;
                const paymentEmail = document.getElementById('paymentEmail').value;
                const paymentProof = document.getElementById('paymentProof').files[0];

                if (paymentName && paymentEmail && paymentProof) {
                    // NOTE: This is a placeholder for file upload.
                    // In a real application, you would upload the file to a storage service
                    // and get the URL. For now, we'll use a sample URL as the original code did.
                    alert("Submitting your request... Please note file upload is a placeholder.");
                    
                    const paymentProofUrl = 'https://res.cloudinary.com/demo/image/upload/sample.jpg';

                    try {
                        await addDoc(collection(db, "artifacts", appId, "wallet_unlock_requests"), {
                            userId: user.uid,
                            username: user.displayName || 'N/A',
                            email: paymentEmail,
                            name: paymentName,
                            paymentProof: paymentProofUrl,
                            amountNaira: 5000,
                            timestamp: serverTimestamp(),
                            status: 'pending'
                        });
                        paymentPanel.style.display = 'none';
                        alert("Your request has been submitted. The developer will review it shortly.");
                    } catch (error) {
                        console.error("Error submitting wallet unlock request: ", error);
                        alert("There was an error submitting your request. Please try again.");
                    }
                } else {
                    alert("Please fill in all fields and upload a payment proof.");
                }
            }
        });
    </script>
</body>
</html>
