
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Nuvia - Home</title>
    <style>
        /* Pink and yellow background for the payment panel */
        #paymentPanel {
            background: linear-gradient(135deg, var(--pink), var(--yellow));
        }
    </style>
</head>
<body>
    <!-- Wallet Locked Modal -->
    <div id="walletLockedModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="walletLockedTitle" style="display:none;">
        <div class="modal-content">
            <h3 id="walletLockedTitle"><i class="fas fa-lock"></i> Wallet Locked</h3>
            <p style="color:var(--text-light);">Your wallet is locked. Pay ₦5000 to request unlock. A developer will unlock it after confirming your payment.</p>
            <div class="button-group" style="display:flex;gap:10px;justify-content:flex-end;">
                <button id="closeWalletLockedBtn" class="modal-button cancel-button">Close</button>
                <button id="walletPayBtn" class="modal-button confirm-button">Pay ₦5000</button>
            </div>
        </div>
    </div>

    <!-- Payment Panel -->
    <div id="paymentPanel" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="paymentPanelTitle" style="display:none;">
        <div class="modal-content">
            <h3 id="paymentPanelTitle">Unlock Wallet Payment</h3>
            <p>Please enter your payment details. The developer will be notified to unlock your wallet after submission.</p>
            <div class="input-group">
                <label for="paymentName">Full Name</label>
                <input type="text" id="paymentName" placeholder="Enter your full name">
            </div>
            <div class="input-group">
                <label for="paymentEmail">Email</label>
                <input type="email" id="paymentEmail" placeholder="Enter your email">
            </div>
            <div class="input-group">
                <label for="paymentProof">Payment Proof (Screenshot)</label>
                <input type="file" id="paymentProof" accept="image/*">
            </div>
            <div class="button-group">
                <button id="cancelPaymentBtn" class="modal-button cancel-button">Cancel</button>
                <button id="submitPaymentBtn" class="modal-button confirm-button">Submit Payment</button>
            </div>
        </div>
    </div>

    <!-- Sidebar Navigation -->
    <aside id="sidebarNav" class="sidebar-hidden" role="navigation" aria-label="Main Navigation">
        <div class="sidebar-links">
            <a href="/wallet.html" class="sidebar-nav-item">
                <i class="fas fa-wallet"></i>
                <span>Wallet</span>
            </a>
        </div>
    </aside>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDz-8N0totzvMCvonF9pKj9RsoH3J8xL0w",
            authDomain: "jchat-1.firebaseapp.com",
            databaseURL: "https://jchat-1-default-rtdb.firebaseio.com",
            projectId: "jchat-1",
            storageBucket: "jchat-1.firebasestorage.app",
            messagingSenderId: "328479683167",
            appId: "1:328479683167:web:276c0b7e8ea44dd2d6a1ea",
            measurementId: "G-S6Z9GG0R9P"
        };
        const appId = 'default-app-id';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const walletPayBtn = document.getElementById('walletPayBtn');
        const paymentPanel = document.getElementById('paymentPanel');
        const cancelPaymentBtn = document.getElementById('cancelPaymentBtn');
        const submitPaymentBtn = document.getElementById('submitPaymentBtn');
        const closeWalletLockedBtn = document.getElementById('closeWalletLockedBtn');
        const walletLockedModal = document.getElementById('walletLockedModal');
        const jcoinRateSpan = document.getElementById('jcoinRate');
        const walletChipAmount = document.getElementById('walletChipAmount');

        let currentSystemSettings = {};

        const SYSTEM_SETTINGS_DOC_REF = doc(db, "artifacts", appId, "public", "data", "settings", "system_settings");

        async function fetchSystemSettings() {
            const docSnap = await getDoc(SYSTEM_SETTINGS_DOC_REF);
            if (docSnap.exists()) {
                currentSystemSettings = docSnap.data();
            } else {
                currentSystemSettings = {
                    jcoinNairaRate: 0.0005, 
                };
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                await fetchSystemSettings();
                const userProfileDocRef = doc(db, "artifacts", appId, "users", user.uid, "profiles", "user_profile");
                const docSnap = await getDoc(userProfileDocRef);
                if (docSnap.exists()) {
                    const jCoins = docSnap.data().jCoins || 0;
                    walletChipAmount.textContent = jCoins;
                    jcoinRateSpan.textContent = (jCoins * currentSystemSettings.jcoinNairaRate).toFixed(4);
                } else {
                     walletChipAmount.textContent = 0;
                    jcoinRateSpan.textContent = (0).toFixed(4);
                }

            }
        });

        walletPayBtn.addEventListener('click', () => {
            walletLockedModal.style.display = 'none';
            paymentPanel.style.display = 'flex';
        });

        cancelPaymentBtn.addEventListener('click', () => {
            paymentPanel.style.display = 'none';
        });

        closeWalletLockedBtn.addEventListener('click', () => {
            walletLockedModal.style.display = 'none';
        });

        submitPaymentBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (user) {
                const paymentName = document.getElementById('paymentName').value;
                const paymentEmail = document.getElementById('paymentEmail').value;
                const paymentProof = document.getElementById('paymentProof').files[0];

                if (paymentName && paymentEmail && paymentProof) {
                    // Simulate file upload and get URL
                    const paymentProofUrl = 'https://res.cloudinary.com/demo/image/upload/sample.jpg';

                    const unlockRequest = {
                        userId: user.uid,
                        username: user.displayName,
                        email: paymentEmail,
                        name: paymentName,
                        paymentProof: paymentProofUrl,
                        amountNaira: 5000,
                        timestamp: serverTimestamp(),
                        status: 'pending'
                    };

                    try {
                        await addDoc(collection(db, "artifacts", appId, "wallet_unlock_requests"), unlockRequest);
                        paymentPanel.style.display = 'none';
                        alert("Your request has been submitted. The developer will review it shortly.");
                    } catch (error) {
                        console.error("Error submitting wallet unlock request: ", error);
                        alert("There was an error submitting your request. Please try again.");
                    }
                } else {
                    alert("Please fill in all fields and upload a payment proof.");
                }
            }
        });
    </script>
</body>
</html>
