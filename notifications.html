<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nuvia — Notifications (Social Feed)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <style>
    *,*::before,*::after{box-sizing:border-box}
    :root{--bg:#0f172a;--card:rgba(255,255,255,0.03);--accent:#00d5ff;--accent2:#ff2e92;--muted:#94a3b8;--radius:14px}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(135deg,var(--bg),#1a1a2e);color:#e6eef8}
    header{position:sticky;top:0;background:linear-gradient(135deg,rgba(8,10,20,.9),rgba(10,10,20,.75));backdrop-filter:blur(8px);border-bottom:1px solid rgba(255,255,255,0.04);z-index:50}
    .header-wrap{max-width:1200px;margin:0 auto;padding:12px 18px;display:flex;align-items:center;gap:12px}
    .logo{font-family:Poppins, sans-serif;font-weight:800;background-image:linear-gradient(90deg,var(--accent),var(--accent2));-webkit-background-clip:text;background-clip:text;color:transparent;font-size:1.2rem}
    .toolbar-actions{margin-left:auto;display:flex;gap:8px;align-items:center}
    .btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:10px;color:inherit;cursor:pointer}
    main{max-width:980px;margin:18px auto;padding:0 12px}

    /* Tabs + search */
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:14px}
    .tabs{display:flex;gap:8px;overflow:auto}
    .tab{padding:8px 12px;border-radius:999px;background:transparent;border:1px solid rgba(255,255,255,0.03);cursor:pointer;color:var(--muted)}
    .tab.active{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#091022;box-shadow:0 8px 30px rgba(0,0,0,0.6)}
    .search{flex:1;display:flex;align-items:center;background:var(--card);padding:8px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
    .search input{flex:1;background:transparent;border:0;color:inherit;outline:none;padding:6px}

    /* Feed style: grouped threads (compact like IG/Twitter) */
    .feed{display:flex;flex-direction:column;gap:12px}
    .thread{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);border-radius:12px;padding:10px;display:flex;gap:12px;align-items:flex-start;transition:transform .18s ease,box-shadow .18s ease}
    .thread:hover{transform:translateY(-6px);box-shadow:0 12px 40px rgba(0,0,0,0.6)}
    .thread.unread{box-shadow:0 0 0 3px rgba(0,213,255,0.06) inset}
    .avatar-col{flex:0 0 56px}
    .avatar{width:56px;height:56px;border-radius:50%;overflow:hidden;border:2px solid rgba(255,255,255,0.04);object-fit:cover}
    .content{flex:1;min-width:0}
    .thread-header{display:flex;align-items:center;gap:8px}
    .actor-name{font-weight:700}
    .thread-meta{margin-left:auto;display:flex;gap:8px;align-items:center;color:var(--muted);font-size:.85rem}
    .priority-badge{background:linear-gradient(90deg,var(--accent),var(--accent2));padding:4px 8px;border-radius:999px;color:#061020;font-weight:800;font-size:.75rem}

    .thread-body{display:flex;align-items:flex-start;gap:12px;margin-top:8px}
    .message{color:var(--muted);font-size:.95rem;line-height:1.25;overflow:hidden;text-overflow:ellipsis}
    .media-thumb{width:72px;height:72px;border-radius:8px;flex:0 0 72px;object-fit:cover;border:1px solid rgba(255,255,255,0.03)}

    .thread-actions{display:flex;gap:8px;margin-top:10px}
    .action-btn{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:6px 10px;border-radius:999px;cursor:pointer;color:var(--muted)}
    .action-btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#071022;border:none}

    .expanded-list{margin-top:10px;display:none;flex-direction:column;gap:6px}
    .thread.expanded .expanded-list{display:flex}
    .item-small{display:flex;gap:8px;align-items:flex-start;padding:8px;border-radius:10px;background:rgba(0,0,0,0.05);border:1px solid rgba(255,255,255,0.01)}
    .item-small .avatar{width:40px;height:40px}
    .item-small .meta{font-size:.85rem;color:var(--muted)}

    /* Snooze / muted state */
    .muted-note{font-size:.82rem;color:var(--muted);margin-top:8px}

    /* Empty */
    .empty{border:1px solid rgba(255,255,255,0.03);border-radius:12px;padding:28px;text-align:center;color:var(--muted);background:var(--card)}

    /* Toast */
    .toast{position:fixed;right:16px;bottom:16px;z-index:90;padding:12px 14px;border-radius:12px;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#04111a;font-weight:700;box-shadow:0 8px 30px rgba(0,0,0,0.6)}

    /* responsive */
    @media (max-width:600px){.avatar{width:48px;height:48px}.avatar-col{flex:0 0 48px}.media-thumb{width:56px;height:56px}}
  </style>
</head>
<body>
  <header>
    <div class="header-wrap">
      <a class="logo" href="/">Nuvia</a>
      <div class="toolbar-actions">
        <button class="btn" onclick="window.history.back()"><i class="fa-solid fa-arrow-left"></i></button>
        <button class="btn" id="openPrefs"><i class="fa-solid fa-bell-slash"></i></button>
      </div>
    </div>
  </header>

  <main>
    <div class="controls">
      <div class="tabs" role="tablist" aria-label="Notification categories">
        <button class="tab active" data-tab="all">All</button>
        <button class="tab" data-tab="mentions">Mentions</button>
        <button class="tab" data-tab="messages">Messages</button>
        <button class="tab" data-tab="likes">Likes</button>
        <button class="tab" data-tab="follows">Follows</button>
        <button class="tab" data-tab="system">System</button>
      </div>
      <div class="search" role="search">
        <i class="fa-solid fa-magnifying-glass" style="margin-right:8px"></i>
        <input id="searchInput" placeholder="Search notifications, people or posts" aria-label="Search notifications" />
      </div>
    </div>

    <div id="feed" class="feed" aria-live="polite"></div>

    <div id="emptyState" class="empty" style="display:none">
      <div style="font-weight:700;font-size:1.05rem;">You're all caught up</div>
      <div style="margin-top:8px;color:var(--muted)">We’ll show new activity here. Try adjusting filters or preferences for more results.</div>
    </div>

    <div style="height:40px"></div>
  </main>

  <div id="toast" class="toast" style="display:none"></div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.8.0/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.8.0/firebase-auth.js';
    import { getFirestore, collection, query, orderBy, limit, onSnapshot, doc, updateDoc, deleteDoc, addDoc, getDoc, runTransaction, serverTimestamp } from 'https://www.gstatic.com/firebasejs/11.8.0/firebase-firestore.js';
    import { getCloudinaryImageUrl } from './assets/js/avatar-utils.js';

    const firebaseConfig = typeof window.__firebase_config !== 'undefined' ? JSON.parse(window.__firebase_config) : {
      apiKey: "AIzaSyDz-8N0totzvMCvonF9pKj9RsoH3J8xL0w",
      authDomain: "jchat-1.firebaseapp.com",
      projectId: "jchat-1"
    };
    const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    (function(){
      const feedEl = document.getElementById('feed');
      const emptyEl = document.getElementById('emptyState');
      const toastEl = document.getElementById('toast');
      const tabs = Array.from(document.querySelectorAll('.tab'));
      const searchInput = document.getElementById('searchInput');

      let currentTab = 'all';
      let currentUser = null;
      let items = [];
      let unsubscribe = null;
      let prefs = loadPrefs();

      function loadPrefs(){ try{ return Object.assign({dnd:false,sound:true,muted:[]}, JSON.parse(localStorage.getItem('nuvia_notification_prefs')||'{}')); }catch(e){ return {dnd:false,sound:true,muted:[]}; } }
      function savePrefs(){ localStorage.setItem('nuvia_notification_prefs', JSON.stringify(prefs)); }

      tabs.forEach(t=>t.addEventListener('click',()=>{ tabs.forEach(x=>x.classList.toggle('active',x===t)); currentTab = t.dataset.tab; render(); }));
      searchInput.addEventListener('input', debounce(()=>render(),220));

      onAuthStateChanged(auth, async (u)=>{
        currentUser = u || null;
        if(unsubscribe){ try{ unsubscribe(); }catch(e){} unsubscribe=null; }
        if(!currentUser) return loadCachedAndRender();
        const col = collection(db,'artifacts', appId, 'users', currentUser.uid, 'notifications');
        const q = query(col, orderBy('timestamp','desc'), limit(400));
        unsubscribe = onSnapshot(q, snap=>{
          const arr = [];
          snap.forEach(s=>{ arr.push(map(s.id, s.data())); });
          items = arr; cacheItems(); render();
        }, err=>{ console.warn('notifications subscribe error', err); loadCachedAndRender(); });
      });

      function loadCachedAndRender(){ try{ const raw = localStorage.getItem('nuvia_notifications_cache'); if(raw){ items = JSON.parse(raw).map(c=>({...c, createdAt:new Date(c.createdAt)})); } }catch(e){} render(); }
      function cacheItems(){ try{ localStorage.setItem('nuvia_notifications_cache', JSON.stringify(items.map(i=>({...i, createdAt: i.createdAt.getTime()})))); }catch(e){} }

      function map(id, n){ const ts = n.timestamp && typeof n.timestamp.toDate==='function' ? n.timestamp.toDate() : (n.timestamp? new Date(n.timestamp) : new Date()); return {
        id, threadId: n.threadId || n.postId || (n.targetUrl? n.targetUrl : id), type: n.type || 'system', actor:{name: n.senderUsername || 'System', profilePicId: n.senderProfilePhoto || n.senderProfilePicId || null}, text: n.message || '', createdAt: ts, unread: n.read===false || !n.read, meta: n.meta || {}, mediaUrl: n.mediaUrl || null, raw: n
      } }

      function render(){
        const q = (searchInput.value||'').toLowerCase().trim();
        let filtered = items.slice();
        if(currentTab!=='all') filtered = filtered.filter(i=>i.type===currentTab);
        if(q) filtered = filtered.filter(i=>`${i.text} ${i.actor.name}`.toLowerCase().includes(q));
        filtered = filtered.filter(i=> !prefs.muted.includes(i.threadId) );

        const threads = groupThreads(filtered);
        // apply priority sort
        threads.sort((a,b)=>scoreThread(b)-scoreThread(a));

        feedEl.innerHTML='';
        if(threads.length===0){ emptyEl.style.display='block'; return; } else { emptyEl.style.display='none'; }

        const frag = document.createDocumentFragment();
        threads.forEach(t=>frag.appendChild(renderThread(t)));
        feedEl.appendChild(frag);
      }

      function groupThreads(list){
        const m = new Map();
        for(const it of list){ const k = it.threadId || it.id; if(!m.has(k)) m.set(k, {id:k, items:[], last:it}); m.get(k).items.push(it); if(!m.get(k).last || it.createdAt>m.get(k).last.createdAt) m.get(k).last = it; }
        return Array.from(m.values()).map(v=>({...v, count:v.items.length, unreadCount: v.items.filter(x=>x.unread).length}));
      }

      function scoreThread(t){
        // simple heuristic: unread > mentions/messages > recency > size
        const last = t.last;
        let s = (t.unreadCount||0) * 200;
        const typePriority = {'mentions':150,'message':140,'messages':140,'comments':80,'follows':60,'likes':30,'system':10};
        s += (typePriority[last.type]||20);
        const age = (Date.now()-last.createdAt.getTime())/1000; // seconds
        s += Math.max(0, 100 - Math.min(100, age/60));
        s += Math.min(50, t.count*6);
        return s;
      }

      function renderThread(t){
        const li = document.createElement('div'); li.className = `thread ${t.unreadCount? 'unread':''}`;
        const avatarCol = document.createElement('div'); avatarCol.className='avatar-col';
        const img = document.createElement('img'); img.className='avatar'; img.alt = t.last.actor.name + ' avatar';
        if(t.last.actor.profilePicId){ img.src = getCloudinaryImageUrl(t.last.actor.profilePicId, 'w_120,h_120,c_fill,g_face'); }
        else { img.src = `https://placehold.co/120x120/CCCCCC/000000?text=${encodeURIComponent((t.last.actor.name||'U').charAt(0))}` }
        avatarCol.appendChild(img);

        const content = document.createElement('div'); content.className='content';
        const head = document.createElement('div'); head.className='thread-header';
        const name = document.createElement('div'); name.innerHTML = `<span class="actor-name">${escape(t.last.actor.name)}</span> <span style="color:var(--muted);margin-left:6px">${escape(truncateText(t.last.text||'',80))}</span>`;
        head.appendChild(name);
        const meta = document.createElement('div'); meta.className='thread-meta';
        if(t.unreadCount>0) meta.innerHTML = `<div class="priority-badge">${t.unreadCount} new</div>`;
        const time = document.createElement('div'); time.textContent = timeAgo(t.last.createdAt); meta.appendChild(time);
        head.appendChild(meta);

        const body = document.createElement('div'); body.className='thread-body';
        const msg = document.createElement('div'); msg.className='message'; msg.textContent = t.last.text || defaultTextFor(t.last.type, t.last.actor.name);
        body.appendChild(msg);
        if(t.last.mediaUrl){ const thumb = document.createElement('img'); thumb.className='media-thumb'; thumb.src = t.last.mediaUrl; body.appendChild(thumb); }
        content.appendChild(head); content.appendChild(body);

        const actions = document.createElement('div'); actions.className='thread-actions';
        const openBtn = document.createElement('button'); openBtn.className='action-btn primary'; openBtn.textContent = 'Open'; openBtn.addEventListener('click',()=>openThread(t));
        const replyBtn = document.createElement('button'); replyBtn.className='action-btn'; replyBtn.innerHTML = '<i class="fa-solid fa-reply"></i> Reply'; replyBtn.addEventListener('click',()=>openThread(t,'reply'));
        const moreBtn = document.createElement('button'); moreBtn.className='action-btn'; moreBtn.innerHTML = '<i class="fa-solid fa-ellipsis"></i>'; moreBtn.addEventListener('click',(e)=>openThreadMenu(e,t));
        actions.appendChild(openBtn); actions.appendChild(replyBtn); actions.appendChild(moreBtn);
        content.appendChild(actions);

        const expanded = document.createElement('div'); expanded.className='expanded-list';
        t.items.slice(0,6).forEach(it=>{ const r = document.createElement('div'); r.className='item-small'; r.innerHTML = `<img class="avatar" src="${it.actor.profilePicId? getCloudinaryImageUrl(it.actor.profilePicId,'w_80,h_80,c_fill,g_face') : 'https://placehold.co/40x40/CCCCCC/000000?text='+encodeURIComponent((it.actor.name||'U').charAt(0))}" alt=""> <div style="min-width:0"><div style="font-weight:700">${escape(it.actor.name)}</div><div class="meta">${escape(truncateText(it.text,120))} · ${timeAgo(it.createdAt)}</div></div>`; expanded.appendChild(r); });
        content.appendChild(expanded);

        li.appendChild(avatarCol); li.appendChild(content);

        li.addEventListener('click',(e)=>{ if(e.target.closest('.action-btn')|| e.target.tagName==='BUTTON') return; li.classList.toggle('expanded'); });

        return li;
      }

      function openThread(t,mode){ if(mode==='reply'){ showToast('Opening reply composer'); } else { if(t.last && t.last.raw && t.last.raw.targetUrl) window.location.href = t.last.raw.targetUrl; else showToast('Opening thread'); } markThreadRead(t); }
      async function markThreadRead(t){ t.items.forEach(it=>it.unread=false); render(); if(!currentUser) return; for(const it of t.items){ try{ await updateDoc(doc(db,'artifacts',appId,'users',currentUser.uid,'notifications', it.id), { read:true }); }catch(e){} } cacheItems(); }

      function openThreadMenu(e,t){ e.stopPropagation(); const menu = document.createElement('div'); menu.style.position='absolute'; menu.style.right='20px'; menu.style.top=(e.clientY)+'px'; menu.style.background='var(--card)'; menu.style.padding='8px'; menu.style.border='1px solid rgba(255,255,255,0.04)'; menu.style.borderRadius='8px'; menu.innerHTML = `<div style="padding:6px;cursor:pointer">Mute thread</div><div style="padding:6px;cursor:pointer">Snooze 1h</div><div style="padding:6px;cursor:pointer;color:var(--muted)">Delete all</div>`;
        document.body.appendChild(menu);
        const cleanup = ()=>{ try{ menu.remove(); document.removeEventListener('click',cleanup); }catch(_){} };
        menu.children[0].addEventListener('click',()=>{ prefs.muted.push(t.id); savePrefs(); cleanup(); render(); showToast('Thread muted'); });
        menu.children[1].addEventListener('click',()=>{ cleanup(); showToast('Snoozed for 1 hour'); });
        menu.children[2].addEventListener('click', async ()=>{ cleanup(); if(!currentUser) return showToast('Sign in to delete'); for(const it of t.items){ try{ await deleteDoc(doc(db,'artifacts',appId,'users',currentUser.uid,'notifications', it.id)); }catch(e){} } showToast('Deleted thread'); });
      }

      function groupBy(k, arr){ return arr.reduce((s,i)=>{ (s[i[k]] = s[i[k]]||[]).push(i); return s; },{}); }

      function truncateText(s,n){ if(!s) return ''; return s.length>n? s.slice(0,n-1)+'…': s; }
      function escape(s){ return String(s||'').replace(/[&<>\"]/g,ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[ch])); }

      function timeAgo(d){ const s=(Date.now()-new Date(d).getTime())/1000; if(s<60) return Math.floor(s)+'s'; const m=s/60; if(m<60) return Math.floor(m)+'m'; const h=m/60; if(h<24) return Math.floor(h)+'h'; const dd=h/24; if(dd<7) return Math.floor(dd)+'d'; const mo=dd/30; if(mo<12) return Math.floor(mo)+'mo'; return Math.floor(dd/365)+'y'; }

      function defaultTextFor(type,name){ if(type==='likes') return `${name} liked your post`; if(type==='comments') return `${name} commented on your post`; if(type==='mentions') return `${name} mentioned you`; if(type==='follows') return `${name} started following you`; return 'System notification'; }

      function showToast(msg){ toastEl.textContent = msg; toastEl.style.display='block'; setTimeout(()=>{ toastEl.style.display='none'; },2200); try{ if(prefs.sound && !prefs.dnd){ Tone.start(); new Tone.Synth().toDestination().triggerAttackRelease('C6','8n'); } }catch(e){} }

      function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); } }

      // initial load
      try{ const raw = localStorage.getItem('nuvia_notifications_cache'); if(raw) items = JSON.parse(raw).map(i=>({...i, createdAt:new Date(i.createdAt)})); }catch(e){}
      render();

    })();
  </script>
</body>
</html>
