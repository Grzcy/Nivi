<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Nuvia - Fun & Earn Arcade</title>
  <link rel="canonical" href="https://nuvia.app/earn.html">
  <meta name="theme-color" content="#1a1a2e">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">
  <style>
    :root {
      --pink: #ff2e92;
      --blue: #00d5ff;
      --glass-black: rgba(10, 10, 10, .75);
      --glass-blue: rgba(0, 213, 255, .15);
      --radius: 20px;
      --transition: .3s ease;
      --white: #fff;
      --text-light: rgba(255, 255, 255, .7);
      --background-main: rgba(10, 10, 10, .75);
      --background-gradient-1: #00d5ff;
      --background-gradient-2: #ff2e92;
      --card-background: linear-gradient(145deg, rgba(255, 255, 255, .03), rgba(255, 255, 255, .01));
      --header-background: linear-gradient(135deg, rgba(10, 10, 10, .85), rgba(10, 10, 10, .75));
      --border-light: rgba(255, 255, 255, .05);
      --input-background: rgba(255, 255, 255, 0.05);
      --button-background: linear-gradient(90deg, var(--blue), var(--pink));
      --button-shadow: 0 4px 15px var(--blue), 0 4px 15px var(--pink);
      --background-color-primary: #1a1a2e;
      --background-color-secondary: #0f0f1f;
      --text-color-primary: #e0e0e0;
      --text-color-secondary: #b0b0d0;
    }
    *, *::before, *::after { box-sizing: border-box; }
    body { margin:0; font-family:'Inter', sans-serif; color: var(--white); background: radial-gradient(circle at top left, var(--background-gradient-1), transparent 100px), radial-gradient(circle at bottom right, var(--background-gradient-2), transparent 150px), linear-gradient(135deg, var(--background-color-primary), var(--background-color-secondary)); background-attachment: fixed; }
    header { background: var(--header-background); border-bottom: 1px solid var(--border-light); padding: 10px 0; position: sticky; top: 0; z-index: 10; }
    .header-content-wrapper { display:flex; align-items:center; justify-content:space-between; max-width:1200px; margin:0 auto; padding:0 20px; }
    .logo { font-family:'Poppins', sans-serif; font-weight:800; font-size:1.6rem; background-image: linear-gradient(90deg, var(--blue), var(--pink)); -webkit-background-clip: text; background-clip:text; color: transparent; text-decoration:none; }
    .home-chips-row { display:flex; gap:12px; align-items:center; }
    .chip { display:flex; gap:12px; align-items:center; min-width:180px; background: linear-gradient(180deg, rgba(19,20,40,0.9), rgba(19,20,40,0.8)); color:#fff !important; border-radius: 14px; padding: 12px 14px; border: 1px solid rgba(255,255,255,0.04); box-shadow: 0 8px 24px rgba(0,0,0,0.35); text-decoration:none; }
    .chip i { color: rgba(255,255,255,0.9); }
    .chip-text { display:flex; flex-direction:column; gap:6px; color:#fff !important; }
    #walletChipAmount { font-weight:800; font-size:1.05rem; color:#fff !important; }
    #jcoinRate { color:#fff !important; font-weight:700; }
    main { max-width:1200px; margin: 18px auto; padding: 0 20px 40px; }
    .noncash-banner { background: var(--card-background); border:1px solid var(--border-light); border-radius: 16px; padding: 12px 14px; color: var(--text-color-primary); display:flex; align-items:center; gap:10px; margin-bottom: 16px; }
    .noncash-banner i { color: var(--pink); }
    .grid { display:grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 14px; }
    @media (max-width: 1024px){ .grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    @media (max-width: 640px){ .grid{ grid-template-columns: 1fr; } }
    .engage-card { background: var(--card-background); border:1px solid var(--glass-blue); border-radius: 15px; padding: 12px; }
    .engage-title { font-weight:800; margin: 2px 0 8px; }
    .spin-button, .primary-btn, .ghost-btn { background: var(--button-background); color:#fff; border:none; border-radius:10px; padding:8px 12px; cursor:pointer; box-shadow: var(--button-shadow); font-weight:700; }
    .ghost-btn { background: transparent; border:1px solid var(--border-light); box-shadow:none; color: var(--white); }
    .muted { color: var(--text-light); font-size: .92rem; }
    .row { display:flex; align-items:center; justify-content:space-between; gap: 10px; }
    .quests-list { display:flex; flex-direction:column; gap:8px; }
    .quest-item { display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .quest-progress { flex:1; height:8px; background:rgba(255,255,255,0.1); border-radius:6px; overflow:hidden; margin:0 8px; }
    .quest-progress > div { height:100%; background: var(--blue); }
    .tile-actions { display:flex; gap:10px; flex-wrap:wrap; }
    .action-link { display:inline-flex; align-items:center; gap:8px; text-decoration:none; font-weight:700; color:#fff; background: var(--button-background); border-radius:10px; padding:8px 12px; }
    .action-link.ghost { background: transparent; border:1px solid var(--border-light); }
    .earnings-footer { text-align:center; color: var(--text-light); margin-top: 16px; }
    .section-title { font-weight:800; font-size:1.2rem; margin: 16px 0 8px; }
    .hidden { display:none !important; }
    .align-start { align-items:flex-start; }
    .mt-4 { margin-top:4px; }
    .mt-8 { margin-top:8px; }
    .justify-end { justify-content:flex-end; }
    .modal-backdrop { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; backdrop-filter: blur(4px); background: rgba(0,0,0,0.35); z-index:1000; }
    .modal-card { width:min(520px, 92vw); }
    .quiz-options { display:grid; gap:8px; }
    .quiz-option { display:flex; align-items:center; gap:8px; cursor:pointer; }
  </style>
</head>
<body>
  <header>
    <div class="header-content-wrapper">
      <a class="logo" href="/index.html">Nuvia</a>
      <div class="home-chips-row">
        <a href="/wallet.html" id="walletChipLink" class="chip wallet-chip" aria-label="Open Wallet">
          <i class="fas fa-wallet"></i>
          <div class="chip-text">
            <div><span id="walletChipAmount">0</span> JCoins</div>
            <div class="chip-sub">Rate: ₦<span id="jcoinRate">0</span>/J</div>
          </div>
        </a>
      </div>
    </div>
  </header>
  <main>
    <div class="noncash-banner" role="note" aria-live="polite">
      <i class="fa-solid fa-heart" aria-hidden="true"></i>
      <div><strong>JCoin is not money.</strong> It can never be converted to real money. Earn for fun, and spend in groups on boosts, tickets, stickers, frames, and more.</div>
    </div>

    <h1 class="section-title">Fun & Earn Arcade</h1>
    <div class="grid" id="earnTiles">
      <div class="engage-card">
        <div class="engage-title">Daily Check‑in</div>
        <div class="row">
          <button id="checkInButton" class="primary-btn"><i class="fa-solid fa-calendar-check"></i> Check‑in</button>
          <div>
            <div id="checkInStatus" class="muted">Claim once per day.</div>
            <div id="streakLabel" class="muted mt-4">Streak: 0 days</div>
          </div>
        </div>
      </div>
      <div class="engage-card">
        <div class="engage-title">Daily Spin</div>
        <div class="row">
          <button class="spin-button" id="spinNowButton"><i class="fas fa-sync"></i> Spin Now</button>
          <div id="spinStatus" class="muted"></div>
        </div>
      </div>
      <div class="engage-card">
        <div class="engage-title">Weekly Quests</div>
        <div class="quests-list" id="questsList"></div>
      </div>
      <div class="engage-card">
        <div class="engage-title">Daily Trivia</div>
        <p class="muted">Answer 3 quick questions. Score 2+ to earn JCoins.</p>
        <div class="row">
          <button id="startQuizButton" class="primary-btn"><i class="fa-solid fa-circle-question"></i> Start Quiz</button>
          <div id="quizStatus" class="muted"></div>
        </div>
      </div>
      <div class="engage-card">
        <div class="engage-title">Scripture Memory</div>
        <div class="row align-start">
          <div style="flex:1;">
            <div id="memoryVerse" class="muted">Tap “Show Verse” to begin.</div>
            <div class="tile-actions mt-8">
              <button id="showVerseButton" class="ghost-btn"><i class="fa-solid fa-book-open"></i> Show Verse</button>
              <button id="markMemorizedButton" class="primary-btn"><i class="fa-solid fa-check-double"></i> Mark Memorized</button>
            </div>
          </div>
        </div>
      </div>
      <div class="engage-card">
        <div class="engage-title">Share Inspiration</div>
        <p class="muted">Post today’s quote or your custom message.</p>
        <div class="tile-actions">
          <a class="action-link" href="/index.html#inspiration"><i class="fa-solid fa-share"></i> Share / Post</a>
          <a class="action-link ghost" href="/index.html#inspiration"><i class="fa-solid fa-sliders"></i> Customize</a>
        </div>
      </div>
      <div class="engage-card">
        <div class="engage-title">Create a Post</div>
        <p class="muted">Write, add media or polls. Quality posts help your streaks and quests.</p>
        <div class="tile-actions">
          <a class="action-link" href="/index.html#postCreationSection"><i class="fa-solid fa-paper-plane"></i> Create Post</a>
        </div>
      </div>
      <div class="engage-card">
        <div class="engage-title">Bible/Quran Trivia</div>
        <p class="muted">Play short quizzes with friends and groups.</p>
        <div class="tile-actions">
          <a class="action-link" href="/bible.html"><i class="fa-solid fa-book-bible"></i> Bible Quiz</a>
          <a class="action-link ghost" href="/quran.html"><i class="fa-solid fa-moon"></i> Quran Quiz</a>
        </div>
      </div>
      <div class="engage-card">
        <div class="engage-title">Invite Friends</div>
        <p class="muted">Grow your circle. More friends, more fun.</p>
        <div class="tile-actions">
          <a class="action-link" href="/find_friends.html"><i class="fa-solid fa-user-plus"></i> Find Friends</a>
          <a class="action-link ghost" href="/friends.html"><i class="fa-solid fa-users"></i> Friends</a>
          <button id="copyInviteLinkButton" class="primary-btn"><i class="fa-solid fa-link"></i> Copy Invite Link</button>
        </div>
        <div id="inviteStatus" class="muted mt-8"></div>
      </div>
      <div class="engage-card">
        <div class="engage-title">Group Challenges</div>
        <p class="muted">Join group events and spend JCoins on boosts.</p>
        <div class="tile-actions">
          <a class="action-link" href="/groups.html"><i class="fa-solid fa-people-group"></i> Explore Groups</a>
          <a class="action-link ghost" href="/leaders_admin.html"><i class="fa-solid fa-ranking-star"></i> Leaderboards</a>
        </div>
      </div>
      <div class="engage-card">
        <div class="engage-title">Themes & Frames</div>
        <p class="muted">Spend JCoins on profile frames and premium looks.</p>
        <div class="tile-actions">
          <a class="action-link" href="/premium_themes.html"><i class="fa-solid fa-wand-magic-sparkles"></i> Themes</a>
          <a class="action-link ghost" href="/profile.html"><i class="fa-solid fa-id-badge"></i> My Profile</a>
        </div>
      </div>
      <div class="engage-card">
        <div class="engage-title">Scripture Reading</div>
        <p class="muted">Read a passage and reflect.</p>
        <div class="row">
          <button id="markReadButton" class="primary-btn"><i class="fa-solid fa-book"></i> Mark Read Today</button>
          <div id="readStatus" class="muted"></div>
        </div>
      </div>
      <div class="engage-card">
        <div class="engage-title">Reaction Rush</div>
        <p class="muted">10‑second tap challenge. Higher score, higher rewards.</p>
        <div class="row">
          <button id="playRushButton" class="primary-btn"><i class="fa-solid fa-bolt"></i> Play 10s Rush</button>
          <div id="rushStatus" class="muted"></div>
        </div>
      </div>
      <div class="engage-card">
        <div class="engage-title">Weekly Streak Bonus</div>
        <p class="muted">Maintain 7‑day check‑in streak to claim weekly bonus.</p>
        <div class="row">
          <button id="claimWeeklyStreakButton" class="primary-btn"><i class="fa-solid fa-calendar-week"></i> Claim Weekly</button>
          <div id="weeklyStreakStatus" class="muted"></div>
        </div>
      </div>

      <div class="engage-card">
        <div class="engage-title">Hard Quiz (5 Q)</div>
        <p class="muted">Score 4+ correct for rewards. One attempt per day.</p>
        <div class="row">
          <button id="startHardQuizButton" class="primary-btn"><i class="fa-solid fa-brain"></i> Start Hard Quiz</button>
          <div id="hardQuizStatus" class="muted"></div>
        </div>
      </div>

      <div class="engage-card">
        <div class="engage-title">Focus Timer</div>
        <p class="muted">Stay focused for 2 minutes without leaving or minimizing.</p>
        <div class="row">
          <button id="startFocusButton" class="primary-btn"><i class="fa-solid fa-hourglass"></i> Start 2‑min Focus</button>
          <div id="focusStatus" class="muted"></div>
        </div>
      </div>

      <div class="engage-card">
        <div class="engage-title">Typing Challenge</div>
        <p class="muted">Type the passage with 95%+ accuracy in 60s.</p>
        <div class="row">
          <button id="startTypingButton" class="primary-btn"><i class="fa-solid fa-keyboard"></i> Begin</button>
          <div id="typingStatus" class="muted"></div>
        </div>
      </div>
    </div>

    <div class="earnings-footer">
      View balances and history in <a href="/wallet.html" style="color:var(--blue); font-weight:800; text-decoration:none;">Wallet</a>.
    </div>
    <h2 class="section-title">Recent Earnings</h2>
    <div class="engage-card" id="earningsCard">
      <div id="earningsList" class="quests-list"></div>
    </div>
  </main>

  <div id="toast" class="hidden" style="position:fixed; bottom:16px; left:50%; transform:translateX(-50%); background:var(--card-background); border:1px solid var(--border-light); color:var(--white); padding:10px 12px; border-radius:10px; box-shadow:0 8px 24px rgba(0,0,0,0.35); z-index:9999;"></div>

  <div id="quizModal" class="hidden modal-backdrop">
    <div class="engage-card modal-card">
      <div class="engage-title">Daily Trivia</div>
      <div id="quizContent" class="muted"></div>
      <div class="tile-actions mt-8 justify-end">
        <button id="quizNextButton" class="primary-btn"><i class="fa-solid fa-arrow-right"></i> Next</button>
        <button id="quizCloseButton" class="ghost-btn"><i class="fa-solid fa-xmark"></i> Close</button>
      </div>
    </div>
  </div>
  <div id="rushModal" class="hidden modal-backdrop">
    <div class="engage-card modal-card">
      <div class="engage-title">Reaction Rush</div>
      <div id="rushContent" class="muted"></div>
      <div class="tile-actions mt-8 justify-end">
        <button id="rushStartButton" class="primary-btn"><i class="fa-solid fa-play"></i> Start</button>
        <button id="rushCloseButton" class="ghost-btn"><i class="fa-solid fa-xmark"></i> Close</button>
      </div>
    </div>
  </div>
  <div id="hardQuizModal" class="hidden modal-backdrop">
    <div class="engage-card modal-card">
      <div class="engage-title">Hard Quiz</div>
      <div id="hardQuizContent" class="muted"></div>
      <div class="tile-actions mt-8 justify-end">
        <button id="hardQuizNextButton" class="primary-btn"><i class="fa-solid fa-arrow-right"></i> Next</button>
        <button id="hardQuizCloseButton" class="ghost-btn"><i class="fa-solid fa-xmark"></i> Close</button>
      </div>
    </div>
  </div>
  <div id="focusModal" class="hidden modal-backdrop">
    <div class="engage-card modal-card">
      <div class="engage-title">Focus Timer</div>
      <div id="focusContent" class="muted"></div>
      <div class="tile-actions mt-8 justify-end">
        <button id="focusCloseButton" class="ghost-btn"><i class="fa-solid fa-xmark"></i> Close</button>
      </div>
    </div>
  </div>
  <div id="typingModal" class="hidden modal-backdrop">
    <div class="engage-card modal-card">
      <div class="engage-title">Typing Challenge</div>
      <div id="typingContent" class="muted"></div>
      <div class="tile-actions mt-8 justify-end">
        <button id="typingSubmitButton" class="primary-btn"><i class="fa-solid fa-paper-plane"></i> Submit</button>
        <button id="typingCloseButton" class="ghost-btn"><i class="fa-solid fa-xmark"></i> Close</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-auth.js";
    import { initializeFirestore, doc, getDoc, setDoc, updateDoc, runTransaction, serverTimestamp, collection, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-firestore.js";

    const firebaseConfig = typeof window.__firebase_config !== 'undefined' ? JSON.parse(window.__firebase_config) : {
      apiKey: "AIzaSyDz-8N0totzvMCvonF9pKj9RsoH3J8xL0w",
      authDomain: "jchat-1.firebaseapp.com",
      databaseURL: "https://jchat-1-default-rtdb.firebaseio.com",
      projectId: "jchat-1",
      storageBucket: "jchat-1.firebasestorage.app",
      messagingSenderId: "328479683167",
      appId: "1:328479683167:web:demo"
    };
    const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';

    const app = initializeApp(firebaseConfig);
    const db = initializeFirestore(app, {});
    const auth = getAuth(app);

    const walletChipAmount = document.getElementById('walletChipAmount');
    const jcoinRateSpan = document.getElementById('jcoinRate');
    const checkInButton = document.getElementById('checkInButton');
    const checkInStatus = document.getElementById('checkInStatus');
    const spinNowButton = document.getElementById('spinNowButton');
    const spinStatus = document.getElementById('spinStatus');
    const questsList = document.getElementById('questsList');
    const streakLabel = document.getElementById('streakLabel');
    const startQuizButton = document.getElementById('startQuizButton');
    const quizStatus = document.getElementById('quizStatus');
    const quizModal = document.getElementById('quizModal');
    const quizContent = document.getElementById('quizContent');
    const quizNextButton = document.getElementById('quizNextButton');
    const quizCloseButton = document.getElementById('quizCloseButton');
    const showVerseButton = document.getElementById('showVerseButton');
    const markMemorizedButton = document.getElementById('markMemorizedButton');
    const memoryVerseEl = document.getElementById('memoryVerse');
    const earningsList = document.getElementById('earningsList');
    const copyInviteLinkButton = document.getElementById('copyInviteLinkButton');
    const inviteStatus = document.getElementById('inviteStatus');
    const markReadButton = document.getElementById('markReadButton');
    const readStatus = document.getElementById('readStatus');
    const playRushButton = document.getElementById('playRushButton');
    const rushStatus = document.getElementById('rushStatus');
    const rushModal = document.getElementById('rushModal');
    const rushContent = document.getElementById('rushContent');
    const rushStartButton = document.getElementById('rushStartButton');
    const rushCloseButton = document.getElementById('rushCloseButton');
    const claimWeeklyStreakButton = document.getElementById('claimWeeklyStreakButton');
    const weeklyStreakStatus = document.getElementById('weeklyStreakStatus');

    // New DOM refs for challenging activities
    const startHardQuizButton = document.getElementById('startHardQuizButton');
    const hardQuizStatus = document.getElementById('hardQuizStatus');
    const hardQuizModal = document.getElementById('hardQuizModal');
    const hardQuizContent = document.getElementById('hardQuizContent');
    const hardQuizNextButton = document.getElementById('hardQuizNextButton');
    const hardQuizCloseButton = document.getElementById('hardQuizCloseButton');

    const startFocusButton = document.getElementById('startFocusButton');
    const focusStatus = document.getElementById('focusStatus');
    const focusModal = document.getElementById('focusModal');
    const focusContent = document.getElementById('focusContent');
    const focusCloseButton = document.getElementById('focusCloseButton');

    const startTypingButton = document.getElementById('startTypingButton');
    const typingStatus = document.getElementById('typingStatus');
    const typingModal = document.getElementById('typingModal');
    const typingContent = document.getElementById('typingContent');
    const typingSubmitButton = document.getElementById('typingSubmitButton');
    const typingCloseButton = document.getElementById('typingCloseButton');

    let currentUser = null;
    let currentUserProfileData = null;
    let quizIndex = 0;
    let quizCorrect = 0;
    let rushClicks = 0;
    let rushTimer = null;
    // Hard quiz state
    let hardQuizIndex = 0;
    let hardQuizCorrect = 0;
    // Focus timer state
    let focusTimer = null;
    let focusRemaining = 0;
    let focusFailed = false;
    // Typing challenge state
    let typingStartAt = 0;
    let typingTarget = '';

    const quizQuestions = [
      { q: 'Which book comes first?', a: ['Genesis','Exodus','Leviticus','Numbers'], c: 0 },
      { q: 'How many surahs are in the Quran?', a: ['100','102','112','114'], c: 3 },
      { q: 'Which is a gospel writer?', a: ['Paul','David','Luke','Moses'], c: 2 }
    ];
    const hardQuizQuestions = [
      { q: 'Longest chapter in the Bible?', a: ['Psalm 117','Psalm 119','Psalm 23','Psalm 1'], c: 1 },
      { q: 'How many books in the Bible?', a: ['60','66','72','64'], c: 1 },
      { q: 'First revealed word in Quran?', a: ['Iqra','Bismillah','Allahu','Alif'], c: 0 },
      { q: 'Who built the Kaaba with Ibrahim?', a: ['Musa','Ismail','Isa','Yusuf'], c: 1 },
      { q: 'Gospel also called?', a: ['Torah','Zabur','Injil','Hadith'], c: 2 }
    ];
    const verses = [
      '“The Lord is my shepherd; I shall not want.” — Psalm 23:1',
      '“Indeed, with hardship [will be] ease.” — Quran 94:6',
      '“Be still, and know that I am God.” — Psalm 46:10',
      '“And whoever relies upon Allah — then He is sufficient for him.” — Quran 65:3'
    ];

    function showToast(msg){ const t = document.getElementById('toast'); if(!t) return; t.textContent = msg; t.classList.remove('hidden'); clearTimeout(t._h); t._h = setTimeout(()=> t.classList.add('hidden'), 2200); }

    async function loadProfileAndWallet(uid){
      try {
        const profileRef = doc(db, 'artifacts', appId, 'users', uid, 'profiles', 'user_profile');
        const snap = await getDoc(profileRef);
        if (snap.exists()) {
          currentUserProfileData = snap.data();
          const j = Number(currentUserProfileData?.jCoins || 0);
          if (walletChipAmount) walletChipAmount.textContent = String(j);
          const computedRate = (j * 0.005).toFixed(3);
          if (jcoinRateSpan) jcoinRateSpan.textContent = computedRate;
        }
      } catch(e){ console.error(e); }
    }

    function fmtDateUTC(d){ const y=d.getUTCFullYear(); const m=String(d.getUTCMonth()+1).padStart(2,'0'); const dd=String(d.getUTCDate()).padStart(2,'0'); return `${y}-${m}-${dd}`; }

    async function awardJCoins(amount, reason, meta={}){
      if (!currentUser) return false;
      const profileRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profiles', 'user_profile');
      const logRef = doc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'earnings'));
      try{
        await runTransaction(db, async (trx)=>{
          const ps = await trx.get(profileRef);
          const cur = ps.exists()? (ps.data().jCoins||0):0;
          if (!ps.exists()) trx.set(profileRef, { jCoins: 0 }, { merge: true });
          trx.update(profileRef, { jCoins: cur + amount, lifetimeEarned: (ps.data()?.lifetimeEarned||0) + amount, updatedAt: serverTimestamp() });
        });
        await setDoc(logRef, { type: reason, amount, ts: serverTimestamp(), ...meta });
        await loadProfileAndWallet(currentUser.uid);
        return true;
      }catch(e){ console.error(e); return false; }
    }

    async function awardGas(amount, reason, meta={}){
      if (!currentUser) return false;
      const profileRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profiles', 'user_profile');
      const xpLogRef = doc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'xp_logs'));
      try{
        await runTransaction(db, async (trx)=>{
          const ps = await trx.get(profileRef);
          const curGas = ps.exists()? (ps.data().gas||0):0;
          const totalGas = ps.exists()? (ps.data().totalGasEarned||0):0;
          if (!ps.exists()) trx.set(profileRef, { gas: 0, totalGasEarned: 0 }, { merge: true });
          trx.update(profileRef, { gas: curGas + amount, totalGasEarned: totalGas + amount, updatedAt: serverTimestamp() });
        });
        await setDoc(xpLogRef, { type: reason, amount, ts: serverTimestamp(), ...meta });
        return true;
      }catch(e){ console.error(e); return false; }
    }

    async function loadEarningsHistory(){
      if (!currentUser || !earningsList) return;
      earningsList.innerHTML = '';
      try{
        const qy = query(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'earnings'), orderBy('ts','desc'));
        const snap = await getDocs(qy);
        if (snap.empty){ earningsList.innerHTML = '<div class="muted">No earnings yet.</div>'; return; }
        snap.docs.slice(0,10).forEach(d=>{
          const it = d.data();
          const row = document.createElement('div');
          row.className = 'quest-item';
          const amt = typeof it.amount==='number' ? `+${it.amount} J` : '';
          const when = it.ts?.toDate ? it.ts.toDate() : new Date();
          row.innerHTML = `<span>${it.type||'Earning'}</span><span class="muted">${when.toLocaleString()}</span><span style="font-weight:800;">${amt}</span>`;
          earningsList.appendChild(row);
        });
      }catch(e){ console.error(e); }
    }

    function renderQuests(){
      if (!questsList) return;
      questsList.innerHTML = '';
      const weekQuests = [
        { id:'q1', title:'React 10 times', target:10, progress:0 },
        { id:'q2', title:'Comment 5 times', target:5, progress:0 },
        { id:'q3', title:'Create 2 posts', target:2, progress:0 }
      ];
      weekQuests.forEach(q=>{
        const pct = Math.min(100, Math.round((q.progress/q.target)*100));
        const row = document.createElement('div');
        row.className = 'quest-item';
        row.innerHTML = `<span>${q.title}</span><div class="quest-progress"><div style="width:${pct}%"></div></div><span>${q.progress}/${q.target}</span>`;
        questsList.appendChild(row);
      });
    }

    async function refreshStreakUI(){
      if (!currentUser || !streakLabel) return;
      try{
        const ref = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'engagement', 'daily_checkin');
        const snap = await getDoc(ref);
        if (snap.exists()){
          const data = snap.data();
          const sc = data.streakCount || 0;
          streakLabel.textContent = `Streak: ${sc} day${sc===1?'':'s'}`;
        }
      }catch(e){ console.error(e); }
    }

    async function handleCheckIn(){
      if (!currentUser) { showToast('Login to check‑in.'); return; }
      const ref = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'engagement', 'daily_checkin');
      const snap = await getDoc(ref);
      const now = new Date();
      const todayStr = fmtDateUTC(now);
      let prevStr = null; let streak = 0; let lastDate = null;
      if (snap.exists()) {
        const data = snap.data();
        lastDate = data.lastAt?.toDate() || null;
        prevStr = data.lastDateStr || null;
        if (lastDate) {
          const since = now - lastDate;
          if (since < 24*60*60*1000) {
            const hrs = Math.ceil((24*60*60*1000 - since)/3600000);
            if (checkInStatus) checkInStatus.textContent = `Come back in ~${hrs}h.`;
            return;
          }
        }
        streak = data.streakCount || 0;
      }
      try {
        const yesterday = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()-1));
        const yStr = fmtDateUTC(yesterday);
        const newStreak = prevStr === yStr ? (streak+1) : 1;
        const ok = await awardJCoins(10, 'daily_checkin');
        if (!ok) throw new Error('award failed');
        await setDoc(ref, { lastAt: serverTimestamp(), lastDateStr: todayStr, streakCount: newStreak }, { merge: true });
        if (checkInStatus) checkInStatus.textContent = `Checked‑in! +10 JCoins`;
        if (streakLabel) streakLabel.textContent = `Streak: ${newStreak} day${newStreak===1?'':'s'}`;
      } catch(e){ console.error(e); showToast('Check‑in failed.'); }
    }

    async function handleSpin(){
      if (!currentUser) { showToast('Login to spin.'); return; }
      const spinRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'engagement', 'daily_spin');
      const snap = await getDoc(spinRef);
      const now = new Date();
      if (snap.exists()) {
        const last = snap.data().lastSpinAt?.toDate();
        if (last) {
          const since = now - last;
          if (since < 24*60*60*1000) {
            const hrs = Math.ceil((24*60*60*1000 - since)/3600000);
            if (spinStatus) spinStatus.textContent = `Come back in ~${hrs}h.`;
            return;
          }
        }
      }
      const rewards = [ {j:5, w:40}, {j:10, w:30}, {j:20, w:20}, {j:50, w:8}, {j:100, w:2} ];
      const totalW = rewards.reduce((a,b)=>a+b.w,0);
      let r = Math.random()*totalW, pick = rewards[0];
      for (const it of rewards) { if (r < it.w) { pick = it; break; } r -= it.w; }
      try {
        const ok = await awardJCoins(pick.j, 'daily_spin', { prize: pick.j });
        if (!ok) throw new Error('award failed');
        await setDoc(spinRef, { lastSpinAt: serverTimestamp() }, { merge: true });
        if (spinStatus) spinStatus.textContent = `You won ${pick.j} JCoins!`;
      } catch(e){ console.error(e); showToast('Spin failed.'); }
    }

    function openQuiz(){ if (quizModal) quizModal.classList.remove('hidden'); renderQuizStep(); }
    function closeQuiz(){ if (quizModal) quizModal.classList.add('hidden'); }
    function renderQuizStep(){
      if (!quizContent) return;
      const q = quizQuestions[quizIndex];
      let html = `<div style="font-weight:800; margin-bottom:8px;">Q${quizIndex+1}/3: ${q.q}</div>`;
      html += '<div class="quiz-options">';
      q.a.forEach((opt, i)=>{
        html += `<label class="quiz-option">
          <input type="radio" name="quizOpt" value="${i}"> <span>${opt}</span>
        </label>`;
      });
      html += '</div>';
      quizContent.innerHTML = html;
    }

    async function nextQuizStep(){
      const sel = quizContent.querySelector('input[name="quizOpt"]:checked');
      if (!sel) { showToast('Choose an answer'); return; }
      const val = Number(sel.value);
      if (val === quizQuestions[quizIndex].c) quizCorrect++;
      quizIndex++;
      if (quizIndex >= quizQuestions.length){
        closeQuiz();
        // gate daily
        if (!currentUser) { showToast('Login to play.'); return; }
        const ref = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'engagement', 'daily_quiz');
        const snap = await getDoc(ref);
        const now = new Date();
        if (snap.exists()){
          const last = snap.data().lastAt?.toDate();
          if (last && (now - last) < 24*60*60*1000){ quizStatus.textContent = 'Come back tomorrow.'; return; }
        }
        const passed = quizCorrect >= 2;
        if (passed){
          const ok = await awardJCoins(15, 'daily_quiz', { correct: quizCorrect });
          if (ok){ quizStatus.textContent = `Great! +15 JCoins (Score ${quizCorrect}/3)`; await setDoc(ref, { lastAt: serverTimestamp() }, { merge: true }); }
          else { showToast('Could not award.'); }
        } else {
          quizStatus.textContent = `Score ${quizCorrect}/3. Try again tomorrow.`;
          await setDoc(ref, { lastAt: serverTimestamp() }, { merge: true });
        }
        quizIndex = 0; quizCorrect = 0;
        await loadEarningsHistory();
        return;
      }
      renderQuizStep();
    }

    function showRandomVerse(){
      const v = verses[Math.floor(Math.random()*verses.length)];
      if (memoryVerseEl) memoryVerseEl.textContent = v;
    }

    async function copyInviteLink(){
      if (!currentUser){ showToast('Login first.'); return; }
      const link = `${location.origin}/index.html?ref=${currentUser.uid}`;
      try{ await navigator.clipboard.writeText(link); }catch(e){ console.error(e); }
      const todayStr = fmtDateUTC(new Date());
      const ref = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'engagement', 'daily_invite');
      const snap = await getDoc(ref);
      let count = 0; let lastDateStr = null;
      if (snap.exists()){ count = snap.data().count||0; lastDateStr = snap.data().dateStr||null; }
      if (lastDateStr === todayStr && count >= 3){ if (inviteStatus) inviteStatus.textContent = 'Daily limit reached.'; return; }
      const newCount = (lastDateStr === todayStr ? count : 0) + 1;
      const ok = await awardJCoins(2, 'invite_share');
      if (ok){ await setDoc(ref, { dateStr: todayStr, count: newCount, lastAt: serverTimestamp() }, { merge: true }); if (inviteStatus) inviteStatus.textContent = `Shared! ${newCount}/3 today (+2 JCoins)`; }
      await loadEarningsHistory();
    }

    async function markMemorized(){
      if (!currentUser) { showToast('Login first.'); return; }
      const ref = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'engagement', 'daily_memory');
      const snap = await getDoc(ref);
      const now = new Date();
      if (snap.exists()){
        const last = snap.data().lastAt?.toDate();
        if (last && (now - last) < 24*60*60*1000){ showToast('Come back tomorrow.'); return; }
      }
      const ok = await awardJCoins(10, 'daily_memory');
      if (ok){ await setDoc(ref, { lastAt: serverTimestamp() }, { merge: true }); showToast('Nice! +10 JCoins'); }
      await loadEarningsHistory();
    }

    function openRush(){ if (rushModal) rushModal.classList.remove('hidden'); rushContent.innerHTML = '<div class="muted">Tap Start, then tap as fast as you can!</div>'; }
    function closeRush(){ if (rushModal) rushModal.classList.add('hidden'); stopRush(); }
    function stopRush(){ if (rushTimer){ clearTimeout(rushTimer); rushTimer=null; } document.removeEventListener('click', rushTapHandler, true); }
    function rushTapHandler(e){ if (!rushTimer) return; if (e.target && e.target.id === 'rushTapButton'){ rushClicks++; const c = document.getElementById('rushCount'); if (c) c.textContent = String(rushClicks); } }

    async function startRush(){
      if (!currentUser){ showToast('Login first.'); return; }
      // daily gate
      const ref = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'engagement', 'daily_rush');
      const snap = await getDoc(ref);
      const now = new Date();
      if (snap.exists()){
        const last = snap.data().lastAt?.toDate();
        if (last && (now - last) < 24*60*60*1000){ rushStatus.textContent = 'Come back tomorrow.'; return; }
      }
      rushClicks = 0;
      rushContent.innerHTML = '<div style="font-weight:800;">10s Rush</div><div class="muted">Taps: <span id="rushCount">0</span></div><div class="tile-actions mt-8"><button id="rushTapButton" class="primary-btn"><i class="fa-solid fa-hand-pointer"></i> Tap!</button></div>';
      document.addEventListener('click', rushTapHandler, true);
      if (rushTimer) clearTimeout(rushTimer);
      rushTimer = setTimeout(async ()=>{
        stopRush();
        closeRush();
        let reward = 5; if (rushClicks >= 30) reward = 20; else if (rushClicks >= 15) reward = 10;
        const ok = await awardJCoins(reward, 'daily_rush', { clicks: rushClicks });
        if (ok){ rushStatus.textContent = `Score ${rushClicks}. +${reward} JCoins`; await setDoc(ref, { lastAt: serverTimestamp() }, { merge: true }); }
        await loadEarningsHistory();
      }, 10000);
    }

    async function markReadToday(){
      if (!currentUser){ showToast('Login first.'); return; }
      const ref = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'engagement', 'daily_read');
      const snap = await getDoc(ref);
      const now = new Date();
      if (snap.exists()){
        const last = snap.data().lastAt?.toDate();
        if (last && (now - last) < 24*60*60*1000){ if (readStatus) readStatus.textContent = 'Already marked today.'; return; }
      }
      const ok = await awardJCoins(5, 'daily_read');
      if (ok){ await setDoc(ref, { lastAt: serverTimestamp() }, { merge: true }); if (readStatus) readStatus.textContent = 'Nice! +5 JCoins'; }
      await loadEarningsHistory();
    }

    function getISOWeek(d){ const date=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate())); const dayNum=(date.getUTCDay()||7); date.setUTCDate(date.getUTCDate()+4-dayNum); const yearStart=new Date(Date.UTC(date.getUTCFullYear(),0,1)); const weekNo=Math.ceil((((date-yearStart)/86400000)+1)/7); return `${date.getUTCFullYear()}-W${String(weekNo).padStart(2,'0')}`; }

    async function claimWeeklyStreak(){
      if (!currentUser){ showToast('Login first.'); return; }
      const weekStr = getISOWeek(new Date());
      const bonusRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'engagement', 'weekly_streak_bonus');
      const bonusSnap = await getDoc(bonusRef);
      if (bonusSnap.exists() && bonusSnap.data().lastWeekStr === weekStr){ weeklyStreakStatus.textContent = 'Already claimed this week.'; return; }
      // need streak >= 7
      const checkinRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'engagement', 'daily_checkin');
      const cs = await getDoc(checkinRef);
      const streak = cs.exists()? (cs.data().streakCount||0) : 0;
      if (streak < 7){ weeklyStreakStatus.textContent = 'Keep streak 7+ to claim.'; return; }
      const ok = await awardJCoins(20, 'weekly_streak_bonus', { week: weekStr, streak });
      if (ok){ await setDoc(bonusRef, { lastWeekStr: weekStr, lastAt: serverTimestamp() }, { merge: true }); weeklyStreakStatus.textContent = 'Weekly bonus claimed! +20 JCoins'; }
      await loadEarningsHistory();
    }

    onAuthStateChanged(auth, async (user)=>{
      currentUser = user || null;
      if (currentUser) {
        await loadProfileAndWallet(currentUser.uid);
        await refreshStreakUI();
        await loadEarningsHistory();
      } else {
        if (walletChipAmount) walletChipAmount.textContent = '0';
        if (jcoinRateSpan) jcoinRateSpan.textContent = '0';
        if (streakLabel) streakLabel.textContent = 'Streak: 0 days';
        if (earningsList) earningsList.innerHTML = '<div class="muted">Log in to see earnings history.</div>';
      }
      renderQuests();
    });

    if (checkInButton) checkInButton.addEventListener('click', handleCheckIn);
    if (spinNowButton) spinNowButton.addEventListener('click', handleSpin);
    if (startQuizButton) startQuizButton.addEventListener('click', ()=>{ quizIndex=0; quizCorrect=0; openQuiz(); });
    if (quizNextButton) quizNextButton.addEventListener('click', nextQuizStep);
    if (quizCloseButton) quizCloseButton.addEventListener('click', closeQuiz);
    if (showVerseButton) showVerseButton.addEventListener('click', showRandomVerse);
    if (markMemorizedButton) markMemorizedButton.addEventListener('click', markMemorized);
    if (copyInviteLinkButton) copyInviteLinkButton.addEventListener('click', copyInviteLink);
    if (markReadButton) markReadButton.addEventListener('click', markReadToday);
    if (playRushButton) playRushButton.addEventListener('click', openRush);
    if (rushStartButton) rushStartButton.addEventListener('click', startRush);
    if (rushCloseButton) rushCloseButton.addEventListener('click', closeRush);
    if (claimWeeklyStreakButton) claimWeeklyStreakButton.addEventListener('click', claimWeeklyStreak);
  </script>
</body>
</html>
