<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Photo Editor · Nuvia</title>
  <style>
    :root{
      /* Fallbacks keep look consistent when theme variables are absent */
      --background-main: #0b0d17;
      --card-background: #121321;
      --header-background: #0f111a;
      --white: #ffffff;
      --text-light: rgba(255,255,255,0.8);
      --border-light: rgba(255,255,255,0.12);
      --blue: #00d5ff;
      --pink: #ff2e92;
      --theme-gold: #ffd700;
      --button-background: linear-gradient(90deg, var(--blue), var(--pink));
      --radius: 12px;
    }
    html, body { height: 100%; }
    body{ margin:0; background: var(--background-main, #0b0d17); color: var(--white, #fff); font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    .app-header{ position: sticky; top:0; z-index: 3; display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 16px; background: var(--header-background, #0f111a); border-bottom: 1px solid var(--border-light, rgba(255,255,255,0.12)); }
    .title{ font-family:'Poppins',sans-serif; font-weight:800; letter-spacing:-.02em; background-image: linear-gradient(90deg, var(--pink), var(--blue)); background-clip:text; -webkit-background-clip:text; color: transparent; }
    .toolbar{ display:flex; align-items:center; gap:10px; }
    .btn{ background: var(--button-background, linear-gradient(90deg, #00d5ff, #ff2e92)); color: var(--white, #fff); border:none; border-radius:10px; padding:8px 12px; font-weight:700; cursor:pointer; box-shadow: 0 6px 20px rgba(0,0,0,0.25); }
    .btn.secondary{ background: rgba(255,255,255,0.08); border: 1px solid var(--border-light, rgba(255,255,255,0.12)); }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }
    .file-input{ position: relative; overflow:hidden; display:inline-block; }
    .file-input input{ position:absolute; inset:0; opacity:0; cursor:pointer; }

    .editor-wrap{ display:grid; grid-template-columns: 1fr 320px; align-items:stretch; gap:0; height: calc(100% - 58px); }
    .canvas-pane{ display:flex; align-items:center; justify-content:center; background: rgba(255,255,255,0.03); border-right: 1px solid var(--border-light, rgba(255,255,255,0.12)); }
    .controls-pane{ padding:14px; overflow:auto; }
    .canvas-box{ padding:16px; }
    canvas{ max-width: calc(92vw - 340px); max-height: 80vh; background: rgba(0,0,0,0.2); border: 1px solid var(--border-light, rgba(255,255,255,0.12)); border-radius: 10px; display:block; }

    /* Smart Preview */
    .mini-preview-group { margin-top: 6px; }
    #miniCvs { width: 100%; height: auto; display: block; max-width: 100%; aspect-ratio: 1 / 1; background: rgba(0,0,0,0.2); border: 1px solid var(--border-light, rgba(255,255,255,0.12)); border-radius: 10px; }

    .group{ margin:10px 0; }
    .group label{ display:flex; justify-content:space-between; align-items:center; gap:10px; color: var(--white, #fff); font-size:.9rem; margin-bottom:6px; }
    .group input[type=range], .group select{ width:100%; }
    .divider{ height:1px; background: var(--border-light, rgba(255,255,255,0.12)); margin:12px 0; }

    .actions{ display:flex; justify-content:space-between; gap:10px; padding-top:6px; }

    .drop-hint{ text-align:center; color: var(--text-light, rgba(255,255,255,0.8)); font-size:.9rem; margin-top:8px; }

    @media (max-width: 920px){
      .editor-wrap{ grid-template-columns: 1fr; }
      .canvas-pane{ border-right:none; border-bottom: 1px solid var(--border-light, rgba(255,255,255,0.12)); }
      canvas{ max-width: 94vw; }
    }
  </style>
</head>
<body>
  <header class="app-header" role="banner">
    <div class="title">Photo Editor</div>
    <div class="toolbar">
      <label class="btn file-input" aria-label="Open Image">
        <input id="openFile" type="file" accept="image/*" />
        Open Image
      </label>
      <button id="downloadBtn" class="btn secondary" disabled aria-label="Download Edited Image">Download</button>
      <button id="postBtn" class="btn" disabled aria-label="Post">Post</button>
      <button id="closeBtn" class="btn secondary" aria-label="Close">Close</button>
    </div>
  </header>

  <main class="editor-wrap" role="main">
    <section class="canvas-pane">
      <div class="canvas-box">
        <canvas id="cvs" width="800" height="800" aria-label="Photo preview"></canvas>
        <div class="drop-hint" id="dropHint">Drag & drop an image, paste from clipboard, or use Open Image.</div>
      </div>
    </section>
    <aside class="controls-pane" aria-label="Editor Controls">
      <div class="group mini-preview-group"><label>Smart Preview</label>
        <canvas id="miniCvs" width="200" height="200" aria-label="Smart image preview"></canvas>
      </div>
      <div class="group"><label>Aspect Ratio
        <select id="ctlAspect">
          <option value="original">Original</option>
          <option value="1:1">1:1 Square</option>
          <option value="4:5">4:5 Portrait</option>
          <option value="16:9">16:9 Landscape</option>
          <option value="9:16">9:16 Story</option>
        </select></label>
      </div>
      <div class="group"><label><span>Zoom</span><span id="valZoom">1.00x</span></label><input id="ctlZoom" type="range" min="1" max="3" step="0.01" value="1"></div>
      <div class="group"><label><span>Offset X</span><span id="valOffX">0</span></label><input id="ctlOffX" type="range" min="-1" max="1" step="0.01" value="0"></div>
      <div class="group"><label><span>Offset Y</span><span id="valOffY">0</span></label><input id="ctlOffY" type="range" min="-1" max="1" step="0.01" value="0"></div>
      <div class="group"><label><span>Rotate</span><span id="valRot">0°</span></label><input id="ctlRot" type="range" min="-45" max="45" step="1" value="0"></div>
      <div class="divider"></div>
      <div class="group"><label><span>Brightness</span><span id="valBright">100%</span></label><input id="ctlBright" type="range" min="50" max="200" step="1" value="100"></div>
      <div class="group"><label><span>Contrast</span><span id="valContrast">100%</span></label><input id="ctlContrast" type="range" min="50" max="200" step="1" value="100"></div>
      <div class="group"><label><span>Saturation</span><span id="valSat">100%</span></label><input id="ctlSat" type="range" min="0" max="200" step="1" value="100"></div>
      <div class="group"><label><span>Hue</span><span id="valHue">0°</span></label><input id="ctlHue" type="range" min="-180" max="180" step="1" value="0"></div>
      <div class="group"><label><span>Sepia</span><span id="valSepia">0%</span></label><input id="ctlSepia" type="range" min="0" max="100" step="1" value="0"></div>
      <div class="group"><label><span>Grayscale</span><span id="valGray">0%</span></label><input id="ctlGray" type="range" min="0" max="100" step="1" value="0"></div>
      <div class="group"><label><span>Blur</span><span id="valBlur">0px</span></label><input id="ctlBlur" type="range" min="0" max="8" step="0.25" value="0"></div>
      <div class="group"><label>Frame
        <select id="ctlFrame">
          <option value="none">None</option>
          <option value="soft">Soft Border</option>
          <option value="neon">Neon Glow</option>
          <option value="vignette">Vignette</option>
        </select></label>
      </div>
      <div class="divider"></div>
      <div class="group">
        <label>Smart Tools</label>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="autoEnhanceBtn" class="btn secondary" type="button">Auto Enhance</button>
          <button id="smartCenterBtn" class="btn secondary" type="button">Smart Center</button>
          <button id="flipHBtn" class="btn secondary" type="button">Flip H</button>
          <button id="flipVBtn" class="btn secondary" type="button">Flip V</button>
        </div>
      </div>
      <div class="group"><label><span>Sharpen</span><span id="valSharp">0</span></label><input id="ctlSharp" type="range" min="0" max="1" step="0.05" value="0"></div>
      <div class="group">
        <label style="display:flex;align-items:center;gap:8px"><input id="ctlBgEnable" type="checkbox"> Remove Background</label>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px">
          <button id="bgPickBtn" class="btn secondary" type="button">Pick Color</button>
          <label style="display:flex;align-items:center;gap:8px"><span>Tolerance</span><input id="ctlBgTol" type="range" min="0" max="100" step="1" value="20"><span id="valBgTol">20</span></label>
        </div>
      </div>
      <div class="actions">
        <button id="resetBtn" class="btn secondary" aria-label="Reset">Reset</button>
        <div style="display:flex;gap:8px">
          <button id="useOriginalBtn" class="btn secondary" aria-label="Use Original">Use Original</button>
          <button id="applyBtn" class="btn" aria-label="Apply">Apply</button>
        </div>
      </div>
    </aside>
  </main>

  <script>
  (function(){
    let cvs = document.getElementById('cvs');
    let ctx = cvs.getContext('2d');
    const mini = document.getElementById('miniCvs');
    const miniCtx = mini.getContext('2d');
    let img = null; let originalDataUrl = null; let contextName = 'standalone';
    const s = { aspect:'original', zoom:1, offX:0, offY:0, rot:0, bright:100, contrast:100, sat:100, hue:0, sepia:0, gray:0, blur:0, frame:'none', mime:'image/jpeg', flipX:false, flipY:false, sharp:0, bg:{enabled:false, tol:20, key:null, picking:false} };

    function $(id){ return document.getElementById(id); }
    function cssVar(name){ try{ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }catch(_){ return ''; } }

    function setDefaults(){ s.aspect='original'; s.zoom=1; s.offX=0; s.offY=0; s.rot=0; s.bright=100; s.contrast=100; s.sat=100; s.hue=0; s.sepia=0; s.gray=0; s.blur=0; s.frame='none'; s.flipX=false; s.flipY=false; s.sharp=0; s.bg={enabled:false, tol:20, key:null, picking:false};
      $('ctlAspect').value='original'; $('ctlZoom').value=1; $('ctlOffX').value=0; $('ctlOffY').value=0; $('ctlRot').value=0; $('ctlBright').value=100; $('ctlContrast').value=100; $('ctlSat').value=100; $('ctlHue').value=0; $('ctlSepia').value=0; $('ctlGray').value=0; $('ctlBlur').value=0;
      $('valZoom').textContent='1.00x'; $('valOffX').textContent='0'; $('valOffY').textContent='0'; $('valRot').textContent='0°'; $('valBright').textContent='100%'; $('valContrast').textContent='100%'; $('valSat').textContent='100%'; $('valHue').textContent='0°'; $('valSepia').textContent='0%'; $('valGray').textContent='0%'; $('valBlur').textContent='0px'; $('ctlFrame').value='none';
      const sh=$('ctlSharp'), vsh=$('valSharp'); if(sh&&vsh){ sh.value=0; vsh.textContent='0'; }
      const be=$('ctlBgEnable'), bt=$('ctlBgTol'), vbt=$('valBgTol'); if(be&&bt&&vbt){ be.checked=false; bt.value=20; vbt.textContent='20'; }
    }

    function getAspect(aspect, iw, ih){ if(aspect==='1:1') return [1,1]; if(aspect==='4:5') return [4,5]; if(aspect==='16:9') return [16,9]; if(aspect==='9:16') return [9,16]; return [iw,ih]; }

    function setCanvasSize(){ const wrap = cvs.parentElement; const maxW = Math.min(1000, wrap.clientWidth-4); const maxH = Math.min(800, window.innerHeight*0.8);
      const [aw,ah] = getAspect(s.aspect, img?img.naturalWidth:1, img?img.naturalHeight:1);
      let w = maxW, h = w*ah/aw; if(h>maxH){ h = maxH; w = h*aw/ah; }
      cvs.width = Math.max(200, Math.floor(w)); cvs.height = Math.max(200, Math.floor(h));
    }

    function render(){ if(!img){ miniCtx.clearRect(0,0,mini.width,mini.height); return; } setCanvasSize(); const w=cvs.width, h=cvs.height; ctx.clearRect(0,0,w,h);
      const iw=img.naturalWidth, ih=img.naturalHeight; const [aw,ah] = getAspect(s.aspect, iw, ih);
      const scaleBase = Math.max(w/iw, h/ih); const scale = scaleBase * s.zoom; const drawW = iw*scale, drawH=ih*scale;
      const cx = w/2 + s.offX*(drawW-w)/2; const cy = h/2 + s.offY*(drawH-h)/2;
      ctx.save(); ctx.translate(w/2,h/2); ctx.scale(s.flipX?-1:1, s.flipY?-1:1); ctx.rotate(s.rot*Math.PI/180); ctx.translate(-w/2,-h/2);
      ctx.filter = `brightness(${s.bright}%) contrast(${s.contrast}%) saturate(${s.sat}%) hue-rotate(${s.hue}deg) sepia(${s.sepia}%) grayscale(${s.gray}%) blur(${s.blur}px)`;
      const dx = cx - drawW/2, dy = cy - drawH/2; ctx.drawImage(img, dx, dy, drawW, drawH);
      ctx.filter = 'none';
      ctx.restore();
      if(s.sharp>0 || (s.bg && s.bg.enabled && s.bg.key)){
        try{
          const id = ctx.getImageData(0,0,w,h); const d=id.data; const out = new Uint8ClampedArray(d); const a = Math.min(1, Math.max(0, s.sharp||0));
          const thr = (s.bg && s.bg.enabled && s.bg.tol!=null) ? Math.pow((s.bg.tol/100)*255, 2) : -1;
          const key = (s.bg && s.bg.key) ? s.bg.key : null;
          if(a>0){ const w4=w*4; for(let y=1;y<h-1;y++){ for(let x=1;x<w-1;x++){ const i=(y*w+x)*4;
              let r=0,g=0,b=0; const nn=[-w-1,-w,-w+1,-1,0,1,w-1,w,w+1]; const kc=[-1,-1,-1,-1,1+8,-1,-1,-1,-1];
              for(let k=0;k<9;k++){ const j=(i + nn[k]*4); r += d[j]*kc[k]; g += d[j+1]*kc[k]; b += d[j+2]*kc[k]; }
              out[i]   = Math.max(0, Math.min(255, d[i]   + a*(r - d[i])));
              out[i+1] = Math.max(0, Math.min(255, d[i+1] + a*(g - d[i+1])));
              out[i+2] = Math.max(0, Math.min(255, d[i+2] + a*(b - d[i+2])));
          }} }
          if(key && thr>=0){ for(let i=0;i<d.length;i+=4){ const dr=d[i]-key.r, dg=d[i+1]-key.g, db=d[i+2]-key.b; if((dr*dr+dg*dg+db*db)<=thr){ out[i+3]=0; } }
            if(s.bg.enabled) s.mime='image/png';
          }
          id.data.set(out); ctx.putImageData(id,0,0);
        }catch(_){ }
      }
      if(s.frame==='soft'){
        ctx.strokeStyle = 'rgba(255,255,255,0.6)'; ctx.lineWidth = Math.max(6, Math.floor(Math.min(w,h)*0.02)); ctx.strokeRect(ctx.lineWidth/2, ctx.lineWidth/2, w-ctx.lineWidth, h-ctx.lineWidth);
      } else if(s.frame==='neon'){
        const g = ctx.createLinearGradient(0,0,w,0); g.addColorStop(0, cssVar('--blue')||'#00d5ff'); g.addColorStop(1, cssVar('--pink')||'#ff2e92');
        ctx.strokeStyle = g; ctx.shadowColor = 'rgba(255,255,255,0.35)'; ctx.shadowBlur = 16; ctx.lineWidth = Math.max(8, Math.floor(Math.min(w,h)*0.025)); ctx.strokeRect(ctx.lineWidth/2, ctx.lineWidth/2, w-ctx.lineWidth, h-ctx.lineWidth); ctx.shadowBlur = 0;
      } else if(s.frame==='vignette'){
        const rg = ctx.createRadialGradient(w/2,h/2, Math.min(w,h)*0.4, w/2,h/2, Math.max(w,h)*0.7); rg.addColorStop(0,'rgba(0,0,0,0)'); rg.addColorStop(1,'rgba(0,0,0,0.35)'); ctx.fillStyle = rg; ctx.fillRect(0,0,w,h);
      }
      renderMini();
    }

    function renderMini(){ if(!img){ miniCtx.clearRect(0,0,mini.width,mini.height); return; }
      const mw = mini.width, mh = mini.height; miniCtx.clearRect(0,0,mw,mh);
      const iw=img.naturalWidth, ih=img.naturalHeight; const scaleBase = Math.max(mw/iw, mh/ih); const scale = scaleBase * s.zoom; const drawW = iw*scale, drawH=ih*scale;
      const cx = mw/2 + s.offX*(drawW-mw)/2; const cy = mh/2 + s.offY*(drawH-mh)/2;
      miniCtx.save(); miniCtx.translate(mw/2,mh/2); miniCtx.scale(s.flipX?-1:1, s.flipY?-1:1); miniCtx.rotate(s.rot*Math.PI/180); miniCtx.translate(-mw/2,-mh/2);
      miniCtx.filter = `brightness(${s.bright}%) contrast(${s.contrast}%) saturate(${s.sat}%) hue-rotate(${s.hue}deg) sepia(${s.sepia}%) grayscale(${s.gray}%) blur(${Math.min(s.blur,2)}px)`;
      const dx = cx - drawW/2, dy = cy - drawH/2; miniCtx.drawImage(img, dx, dy, drawW, drawH);
      miniCtx.filter = 'none';
      miniCtx.restore();
      if(s.frame==='soft'){
        miniCtx.strokeStyle = 'rgba(255,255,255,0.5)'; miniCtx.lineWidth = 4; miniCtx.strokeRect(2,2,mw-4,mh-4);
      } else if(s.frame==='neon'){
        const g = miniCtx.createLinearGradient(0,0,mw,0); g.addColorStop(0, cssVar('--blue')||'#00d5ff'); g.addColorStop(1, cssVar('--pink')||'#ff2e92');
        miniCtx.strokeStyle = g; miniCtx.shadowColor = 'rgba(255,255,255,0.25)'; miniCtx.shadowBlur = 8; miniCtx.lineWidth = 5; miniCtx.strokeRect(3,3,mw-6,mh-6); miniCtx.shadowBlur = 0;
      } else if(s.frame==='vignette'){
        const rg = miniCtx.createRadialGradient(mw/2,mh/2, mw*0.35, mw/2,mh/2, mw*0.7); rg.addColorStop(0,'rgba(0,0,0,0)'); rg.addColorStop(1,'rgba(0,0,0,0.25)'); miniCtx.fillStyle = rg; miniCtx.fillRect(0,0,mw,mh);
      }
    }

    function openDataUrl(dataUrl, name){ const i = new Image(); i.onload = ()=>{ img = i; originalDataUrl = dataUrl; $('downloadBtn').disabled = false; const pb=$('postBtn'); if(pb) pb.disabled=false; render(); }; i.src = dataUrl; if(name && /\.png$/i.test(name)) s.mime='image/png'; else s.mime='image/jpeg'; }

    function openFile(file){ if(!file) return; const reader = new FileReader(); reader.onload = ()=> openDataUrl(reader.result, file.name); reader.readAsDataURL(file); }

    function exportBlob(){ return new Promise((resolve,reject)=>{ try{ cvs.toBlob((blob)=>{ if(!blob){ reject(new Error('Export failed')); return; } const f = new File([blob], 'edited.' + (s.mime==='image/png'?'png':'jpg'), { type: s.mime }); resolve(f); }, s.mime==='image/png'?'image/png':'image/jpeg', s.mime==='image/png'?1:0.92); }catch(e){ reject(e); } }); }

    function sendToOpener(dataUrl, file){ try{ const msg = { type:'nuvia-photo-done', mime: file.type, name: file.name, dataUrl }; if(window.opener){ window.opener.postMessage(msg, '*'); } if(window.parent && window.parent!==window){ window.parent.postMessage(msg, '*'); } if(window.opener && typeof window.opener.nuviaPhotoEditorCallback==='function'){ window.opener.nuviaPhotoEditorCallback(file, dataUrl); } }catch(_){} }

    // Controls
    $('ctlAspect').addEventListener('change', ()=>{ s.aspect = $('ctlAspect').value; render(); });
    $('ctlZoom').addEventListener('input', (e)=>{ s.zoom = parseFloat(e.target.value); $('valZoom').textContent = s.zoom.toFixed(2)+'x'; render(); });
    $('ctlOffX').addEventListener('input', (e)=>{ s.offX = parseFloat(e.target.value); $('valOffX').textContent = e.target.value; render(); });
    $('ctlOffY').addEventListener('input', (e)=>{ s.offY = parseFloat(e.target.value); $('valOffY').textContent = e.target.value; render(); });
    $('ctlRot').addEventListener('input', (e)=>{ s.rot = parseFloat(e.target.value); $('valRot').textContent = Math.round(s.rot)+'°'; render(); });
    $('ctlBright').addEventListener('input', (e)=>{ s.bright = parseInt(e.target.value,10); $('valBright').textContent = s.bright+'%'; render(); });
    $('ctlContrast').addEventListener('input', (e)=>{ s.contrast = parseInt(e.target.value,10); $('valContrast').textContent = s.contrast+'%'; render(); });
    $('ctlSat').addEventListener('input', (e)=>{ s.sat = parseInt(e.target.value,10); $('valSat').textContent = s.sat+'%'; render(); });
    $('ctlHue').addEventListener('input', (e)=>{ s.hue = parseInt(e.target.value,10); $('valHue').textContent = s.hue+'°'; render(); });
    $('ctlSepia').addEventListener('input', (e)=>{ s.sepia = parseInt(e.target.value,10); $('valSepia').textContent = s.sepia+'%'; render(); });
    $('ctlGray').addEventListener('input', (e)=>{ s.gray = parseInt(e.target.value,10); $('valGray').textContent = s.gray+'%'; render(); });
    $('ctlBlur').addEventListener('input', (e)=>{ s.blur = parseFloat(e.target.value); $('valBlur').textContent = s.blur.toFixed(2)+'px'; render(); });
    $('ctlFrame').addEventListener('change', ()=>{ s.frame = $('ctlFrame').value; render(); });
    $('ctlSharp').addEventListener('input', (e)=>{ s.sharp = parseFloat(e.target.value); $('valSharp').textContent = s.sharp.toFixed(2); render(); });
    $('ctlBgEnable').addEventListener('change', (e)=>{ s.bg.enabled = !!e.target.checked; if(s.bg.enabled) s.mime='image/png'; render(); });
    $('ctlBgTol').addEventListener('input', (e)=>{ s.bg.tol = parseInt(e.target.value,10); $('valBgTol').textContent = String(s.bg.tol); render(); });
    $('bgPickBtn').addEventListener('click', ()=>{ s.bg.picking = !s.bg.picking; document.body.style.cursor = s.bg.picking ? 'crosshair' : ''; });

    $('resetBtn').addEventListener('click', ()=>{ setDefaults(); render(); });
    $('useOriginalBtn').addEventListener('click', ()=>{ if(originalDataUrl){ openDataUrl(originalDataUrl); } });

    function autoEnhance(){ try{ if(!img) return; const off=document.createElement('canvas'); const ow=256, oh=Math.max(1, Math.round(256*img.naturalHeight/img.naturalWidth)); off.width=ow; off.height=oh; const ox=off.getContext('2d'); ox.drawImage(img,0,0,ow,oh); const id=ox.getImageData(0,0,ow,oh).data; let sum=0, sum2=0; for(let i=0;i<id.length;i+=4){ const y = 0.2126*id[i]+0.7152*id[i+1]+0.0722*id[i+2]; sum+=y; sum2+=y*y; } const n=id.length/4; const mean=sum/n; const variance=Math.max(1, sum2/n - mean*mean); const std=Math.sqrt(variance); const targetMean=128; const gain=Math.min(1.6, Math.max(0.8, 128/(std+64))); const bias=targetMean-mean*gain; s.bright = Math.max(60, Math.min(160, Math.round(100 + (bias/255)*100))); s.contrast = Math.max(80, Math.min(160, Math.round(100*gain))); s.sat = Math.min(150, Math.round(100 + (std/128)*30)); $('ctlBright').value=s.bright; $('ctlContrast').value=s.contrast; $('ctlSat').value=s.sat; $('valBright').textContent=s.bright+'%'; $('valContrast').textContent=s.contrast+'%'; $('valSat').textContent=s.sat+'%'; render(); }catch(_){ }}

    function smartCenter(){ try{ if(!img) return; const off=document.createElement('canvas'); const ow=192, oh=Math.max(1, Math.round(192*img.naturalHeight/img.naturalWidth)); off.width=ow; off.height=oh; const ox=off.getContext('2d'); ox.drawImage(img,0,0,ow,oh); const id=ox.getImageData(0,0,ow,oh); const d=id.data; const sobel=(x,y,c)=>{ const idx=(y*ow+x)*4+c; const gx = -d[idx-4-ow*4]-2*d[idx-ow*4]-d[idx+4-ow*4] + d[idx-4+ow*4]+2*d[idx+ow*4]+d[idx+4+ow*4]; const gy = -d[idx-4-ow*4]-2*d[idx-4]-d[idx-4+ow*4] + d[idx+4-ow*4]+2*d[idx+4]+d[idx+4+ow*4]; return Math.hypot(gx,gy); }; let sum=0,cx=0,cy=0; for(let y=1;y<oh-1;y++){ for(let x=1;x<ow-1;x++){ const e = sobel(x,y,0)+sobel(x,y,1)+sobel(x,y,2); sum+=e; cx+=e*x; cy+=e*y; } } if(sum>0){ cx/=sum; cy/=sum; const nx=cx/ow, ny=cy/oh; s.offX = Math.max(-1, Math.min(1, (nx-0.5)*2 )); s.offY = Math.max(-1, Math.min(1, (ny-0.5)*2 )); $('ctlOffX').value=s.offX; $('ctlOffY').value=s.offY; $('valOffX').textContent=s.offX.toFixed(2); $('valOffY').textContent=s.offY.toFixed(2); render(); } }catch(_){ }}

    $('autoEnhanceBtn').addEventListener('click', autoEnhance);
    $('smartCenterBtn').addEventListener('click', smartCenter);
    $('flipHBtn').addEventListener('click', ()=>{ s.flipX = !s.flipX; render(); });
    $('flipVBtn').addEventListener('click', ()=>{ s.flipY = !s.flipY; render(); });
    $('applyBtn').addEventListener('click', async ()=>{ try{ if(!img) return; const file = await exportBlob(); const dataUrl = cvs.toDataURL(s.mime==='image/png'?'image/png':'image/jpeg', s.mime==='image/png'?1:0.92); sendToOpener(dataUrl, file); }catch(e){ console.error('Apply failed', e); } });
    $('downloadBtn').addEventListener('click', async ()=>{ try{ if(!img) return; const dataUrl = cvs.toDataURL(s.mime==='image/png'?'image/png':'image/jpeg', s.mime==='image/png'?1:0.92); const a = document.createElement('a'); a.href = dataUrl; a.download = 'nuvia-edited.'+(s.mime==='image/png'?'png':'jpg'); document.body.appendChild(a); a.click(); a.remove(); }catch(e){} });

    $('postBtn').addEventListener('click', async ()=>{ try{ if(!img) return; const dataUrl = cvs.toDataURL(s.mime==='image/png'?'image/png':'image/jpeg', s.mime==='image/png'?1:0.92); try{ sessionStorage.setItem('photoEditor:resultDataUrl', dataUrl); const u = new URL(location.href); const ctx = u.searchParams.get('ctx') || sessionStorage.getItem('photoEditor:context') || 'composer'; sessionStorage.setItem('photoEditor:context', ctx); const ret = sessionStorage.getItem('photoEditor:return'); if(ret){ location.assign(ret); } else { history.back(); } }catch(_){}
    }catch(e){} });

    // Open/Close
    $('openFile').addEventListener('change', (e)=>{ const f = e.target.files && e.target.files[0]; if(f){ s.mime = (f.type && /png/i.test(f.type)) ? 'image/png' : 'image/jpeg'; openFile(f); } });
    $('closeBtn').addEventListener('click', ()=>{ try{ if(window.opener){ window.close(); } else { history.back(); } }catch(_){ window.close(); } });

    // DnD + clipboard
    document.addEventListener('dragover', (e)=>{ e.preventDefault(); });
    document.addEventListener('drop', (e)=>{ e.preventDefault(); const f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0]; if(f && /^image\//i.test(f.type)) openFile(f); });
    document.addEventListener('paste', (e)=>{ const items = e.clipboardData && e.clipboardData.items; if(!items) return; for(const it of items){ if(it.type && /^image\//i.test(it.type)){ const f = it.getAsFile(); if(f) openFile(f); break; } } });

    cvs.addEventListener('click', (ev)=>{ try{ if(!(s.bg && s.bg.picking)) return; const rect=cvs.getBoundingClientRect(); const x=Math.floor((ev.clientX-rect.left)/rect.width * cvs.width); const y=Math.floor((ev.clientY-rect.top)/rect.height * cvs.height); const id = ctx.getImageData(x,y,1,1).data; s.bg.key = { r:id[0], g:id[1], b:id[2] }; s.bg.picking=false; document.body.style.cursor=''; render(); }catch(_){ } });

    // Message API: parent can send dataUrl or Blob via postMessage
    window.addEventListener('message', (ev)=>{ try{ const d = ev.data || {}; if(d && d.type==='nuvia-photo-open'){
      if(d.dataUrl){ openDataUrl(d.dataUrl, d.name||'image.jpg'); }
      else if(d.blob){ const fr = new FileReader(); fr.onload = ()=> openDataUrl(fr.result, d.name||'image.jpg'); fr.readAsDataURL(d.blob); }
    } }catch(_){ } });

    // If a query param image is provided (?img=dataUrl) or via sessionStorage handoff
    try{ const u = new URL(location.href); const q = u.searchParams.get('img'); if(q){ openDataUrl(q, 'image.jpg'); }
      else { const d = sessionStorage.getItem('photoEditor:inputDataUrl'); if(d){ openDataUrl(d, 'image.jpg'); sessionStorage.removeItem('photoEditor:inputDataUrl'); } }
    }catch(_){ }

    // Initialize
    setDefaults();
  })();
  </script>
</body>
</html>
