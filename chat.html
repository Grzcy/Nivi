<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nuvia - Chat</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">

  <style>
    /* Reuse design tokens from other pages (kept small & consistent) */
    :root{--pink:#ff2e92;--blue:#00d5ff;--radius:20px;--border-light:rgba(255,255,255,0.06);--card-background:rgba(25,25,40,0.7);--header-background:linear-gradient(135deg,rgba(10,10,20,.85),rgba(10,10,20,.75));--white:#e0e0e0;--text-light:#a0a0a0;--accent-color:#00d5ff;--delete-button-color:#dc3545}
    html,body{height:100%;margin:0;font-family:'Inter',sans-serif;background:var(--card-background);color:var(--white);-webkit-font-smoothing:antialiased}
    header{background:var(--header-background);border-bottom:1px solid var(--border-light);padding:10px 0;position:fixed;top:0;left:0;width:100%;height:55px;display:flex;justify-content:center;z-index:10}
    .header-content-wrapper{width:100%;max-width:1200px;padding:0 20px;display:flex;align-items:center;justify-content:space-between}
    .logo{font-family:'Poppins',sans-serif;font-weight:800;background-image:linear-gradient(90deg,var(--blue),var(--pink));-webkit-background-clip:text;color:transparent;text-decoration:none}
    .user-profile-header{display:flex;align-items:center;gap:10px}
    .user-profile-header img{width:34px;height:34px;border-radius:50%;object-fit:cover;border:2px solid var(--accent-color)}

    main{padding-top:55px;display:flex;flex-direction:column;height:calc(100vh - 55px);width:100%;max-width:1000px;margin:12px auto;border-radius:var(--radius);overflow:hidden;background:var(--card-background);box-shadow:0 10px 30px rgba(0,0,0,0.5)}

    .chat-header{display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid var(--border-light);background:linear-gradient(135deg,rgba(255,255,255,0.02),transparent)}
    .chat-header .back-btn{background:none;border:none;color:var(--white);font-size:1.1rem;padding:8px;cursor:pointer}
    .chat-header .partner-avatar{width:44px;height:44px;border-radius:50%;object-fit:cover;border:2px solid var(--accent-color)}
    .chat-header .partner-name{font-family:'Poppins',sans-serif;font-weight:700;font-size:1.05rem}
    .chat-header .partner-status{color:var(--text-light);font-size:0.85rem}

    .chat-messages{flex:1;padding:12px 16px;overflow-y:auto;display:flex;flex-direction:column;gap:8px}
    .message-item{display:flex;align-items:flex-start;gap:8px;max-width:70%}
    .message-item.sent{margin-left:auto;flex-direction:row-reverse}
    .message-item .avatar{width:30px;height:30px;border-radius:50%;object-fit:cover;border:1px solid var(--accent-color)}
    .message-bubble{padding:8px 10px;border-radius:12px;background:rgba(255,255,255,0.06);color:var(--white);font-size:0.9rem;word-wrap:break-word}
    .message-item.sent .message-bubble{background:linear-gradient(90deg,var(--blue),var(--pink));color:#fff}
    .message-meta{font-size:0.7rem;color:var(--text-light);margin-top:4px}

    .chat-input-area{padding:10px;border-top:1px solid var(--border-light);display:flex;flex-direction:column;gap:8px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent)}
    .input-row{display:flex;gap:8px;align-items:center}
    .chat-input-area textarea{flex:1;padding:10px;border-radius:18px;border:1px solid var(--border-light);background:rgba(0,0,0,0.25);color:var(--white);outline:none;resize:none;min-height:40px;max-height:120px}
    .chat-input-area button.send-btn{width:44px;height:44px;border-radius:50%;border:none;background:linear-gradient(90deg,var(--blue),var(--pink));color:white;cursor:pointer;box-shadow:0 6px 20px rgba(0,213,255,0.12)}
    .attach-btn{width:44px;height:44px;border-radius:50%;border:1px solid var(--border-light);background:transparent;color:var(--text-light);cursor:pointer}

    #mediaPreviewContainer{display:flex;align-items:center;gap:8px;padding:6px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid var(--border-light);display:none}
    #mediaPreview{max-width:70px;max-height:70px;border-radius:6px;object-fit:cover}
    #removeMediaButton{background:none;border:none;color:var(--delete-button-color);cursor:pointer}

    /* small screens */
    @media (max-width:600px){.chat-header .partner-name{font-size:1rem}.message-item .avatar{width:24px;height:24px}.message-bubble{font-size:0.85rem}}
    .is-hidden{display:none}
    .hidden-input{display:none}
    .emoji-panel{width:100%;background:var(--input-background);border:1px solid var(--border-light);border-radius:8px;padding:6px;display:grid;grid-template-columns:repeat(12,minmax(0,1fr));gap:6px;max-height:160px;overflow:auto}
    @media (max-width:600px){.emoji-panel{grid-template-columns:repeat(8,minmax(0,1fr))}}
    .emoji-btn{background:transparent;border:1px solid var(--border-light);border-radius:8px;padding:6px;font-size:18px;cursor:pointer;color:var(--white)}
    .emoji-btn:hover{background:rgba(255,255,255,0.06)}
  </style>
</head>
<body class="theme-dark-mode">
  <header>
    <div class="header-content-wrapper">
      <a href="/index.html" class="logo">Nuvia</a>
      <div class="user-profile-header">
        <a id="profileLink" href="/profile.html"><img id="headerProfilePic" src="" alt="Profile" style="display:none"><i id="headerAvatarIcon" class="fas fa-user-circle" style="font-size:28px"></i><span id="headerDisplayName">Loading...</span></a>
      </div>
    </div>
  </header>

  <main>
    <div class="chat-header">
      <button id="backBtn" class="back-btn" aria-label="Back"><i class="fas fa-arrow-left"></i></button>
      <img id="partnerAvatar" class="partner-avatar" src="" alt="Partner">
      <div style="display:flex;flex-direction:column;">
        <div class="partner-name" id="partnerName">Loading...</div>
        <div class="partner-status" id="partnerStatus">Loading...</div>
      </div>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <button id="viewProfileBtn" class="attach-btn" title="View profile"><i class="fas fa-user"></i></button>
      </div>
    </div>

    <div class="chat-messages" id="chatMessages">
      <p class="messages-loading-text" id="messagesLoading">Loading messages...</p>
    </div>

    <div class="chat-input-area">
      <div id="mediaPreviewContainer">
        <img id="mediaPreview" src="" alt="preview">
        <span id="mediaFileName"></span>
        <button id="removeMediaButton" title="Remove media"><i class="fas fa-times-circle"></i></button>
      </div>

      <div class="input-row">
        <input type="file" id="mediaInput" accept="image/*,video/*" class="hidden-input">
        <button id="emojiButton" class="attach-btn" title="Emoji"><i class="fas fa-face-smile"></i></button>
        <button id="attachButton" class="attach-btn" title="Attach media"><i class="fas fa-paperclip"></i></button>
        <textarea id="messageInput" placeholder="Type your message..."></textarea>
        <button id="sendButton" class="send-btn" title="Send"><i class="fas fa-paper-plane"></i></button>
      </div>
      <div id="emojiPanel" class="emoji-panel is-hidden">
        <button class="emoji-btn" data-emoji="üòÄ">üòÄ</button>
        <button class="emoji-btn" data-emoji="üòÅ">üòÅ</button>
        <button class="emoji-btn" data-emoji="üòÇ">üòÇ</button>
        <button class="emoji-btn" data-emoji="üòä">üòä</button>
        <button class="emoji-btn" data-emoji="üòç">üòç</button>
        <button class="emoji-btn" data-emoji="ü•≥">ü•≥</button>
        <button class="emoji-btn" data-emoji="üòé">üòé</button>
        <button class="emoji-btn" data-emoji="üëç">üëç</button>
        <button class="emoji-btn" data-emoji="üî•">üî•</button>
        <button class="emoji-btn" data-emoji="üíØ">üíØ</button>
        <button class="emoji-btn" data-emoji="üôè">üôè</button>
        <button class="emoji-btn" data-emoji="üéâ">üéâ</button>
      </div>
    </div>
  </main>

  <div id="messageBox" style="display:none"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, doc, getDoc, query, orderBy, onSnapshot, addDoc, serverTimestamp, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getCloudinaryImageUrl, displayProfilePicture } from './assets/js/avatar-utils.js';

    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
      apiKey: "AIzaSyDz-8N0totzvMCvonF9pKj9RsoH3J8xL0w",
      authDomain: "jchat-1.firebaseapp.com",
      projectId: "jchat-1",
      storageBucket: "jchat-1.firebasestorage.app",
      messagingSenderId: "328479683167",
      appId: "1:328479683167:web:276c0b7e8ea44dd2d6a1ea"
    };
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    const cloudinaryConfig = { cloudName: 'dxld01rcp', uploadPreset: 'Storage_preset' };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOM
    const headerProfilePic = document.getElementById('headerProfilePic');
    const headerAvatarIcon = document.getElementById('headerAvatarIcon');
    const headerDisplayName = document.getElementById('headerDisplayName');
    const profileLink = document.getElementById('profileLink');

    const backBtn = document.getElementById('backBtn');
    const partnerAvatar = document.getElementById('partnerAvatar');
    const partnerNameEl = document.getElementById('partnerName');
    const partnerStatusEl = document.getElementById('partnerStatus');
    const viewProfileBtn = document.getElementById('viewProfileBtn');

    const chatMessages = document.getElementById('chatMessages');
    const messagesLoading = document.getElementById('messagesLoading');

    const mediaInput = document.getElementById('mediaInput');
    const attachButton = document.getElementById('attachButton');
    const mediaPreviewContainer = document.getElementById('mediaPreviewContainer');
    const mediaPreview = document.getElementById('mediaPreview');
    const mediaFileName = document.getElementById('mediaFileName');
    const removeMediaButton = document.getElementById('removeMediaButton');
    const emojiButton = document.getElementById('emojiButton');
    const emojiPanel = document.getElementById('emojiPanel');

    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');

    let currentUser = null;
    let partnerId = null;
    let partnerProfile = null;
    let chatId = null;
    let unsubscribeMessages = null;
    let selectedMediaFile = null;
    let typingUnsub = null;
    let typingTimer = null;

    function chatIdFor(u1,u2){ return [u1,u2].sort().join('_'); }

    function showMessage(text,type='info',duration=3000){ const mb=document.getElementById('messageBox'); if(!mb) return; mb.textContent=text; mb.style.display='block'; mb.className=type; setTimeout(()=>{ mb.style.display='none'; },duration); }

    function formatTime(ts){ try{ const d = ts && ts.toDate ? ts.toDate() : (ts? new Date(ts): new Date()); return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }catch(e){ return ''; } }

    function clearMessages(){ chatMessages.innerHTML=''; }

    function renderMessage(m){
      if(!m || !m.senderId) return;
      const isSent = currentUser && m.senderId === currentUser.uid;
      const item = document.createElement('div');
      item.className = 'message-item ' + (isSent? 'sent':'received');

      const avatarWrap = document.createElement('div');
      avatarWrap.className = 'avatar';
      const avatarImg = document.createElement('img');
      avatarImg.className = 'avatar';
      avatarImg.alt = 'avatar';
      avatarImg.loading = 'lazy';
      avatarImg.decoding = 'async';
      avatarImg.style.width='30px'; avatarImg.style.height='30px'; avatarImg.style.borderRadius='50%';
      if(isSent){ if(currentUser?.photoURL){ avatarImg.src = currentUser.photoURL; } else { avatarImg.src = `https://placehold.co/40x40/CCCCCC/000000?text=${encodeURIComponent((currentUser?.displayName||'U').charAt(0))}`; } }
      else { if(partnerProfile?.profilePicId){ avatarImg.src = getCloudinaryImageUrl(partnerProfile.profilePicId,'w_60,h_60,c_fill,g_face,r_max'); } else { avatarImg.src = `https://placehold.co/40x40/CCCCCC/000000?text=${encodeURIComponent((partnerProfile?.username||'U').charAt(0))}`; } }

      const contentWrap = document.createElement('div'); contentWrap.className='message-content';
      const bubble = document.createElement('div'); bubble.className='message-bubble';

      if(m.type === 'file' || m.type === 'audio'){
        // media
        const lower = (m.fileUrl||'').toLowerCase();
        if(m.fileUrl && /\.(png|jpe?g|gif|webp)$/i.test(lower)){
          const img = document.createElement('img'); img.src = m.fileUrl; img.className='message-media image'; img.style.maxWidth='220px'; img.style.borderRadius='8px'; img.alt='image'; bubble.appendChild(img);
        } else if(m.fileUrl && /\.(mp4|webm|ogg)$/i.test(lower)){
          const v = document.createElement('video'); v.src = m.fileUrl; v.controls = true; v.style.maxWidth='260px'; v.style.borderRadius='8px'; v.className='message-media video'; bubble.appendChild(v);
        } else if(m.fileUrl && (m.type==='audio' || /\.(mp3|wav|m4a|aac)$/i.test(lower))){
          const a = document.createElement('audio'); a.src = m.fileUrl; a.controls = true; bubble.appendChild(a);
        } else if(m.text){ const p=document.createElement('div'); p.textContent = m.text; bubble.appendChild(p); }
      } else {
        const p = document.createElement('div'); p.textContent = m.text || ''; bubble.appendChild(p);
      }

      const meta = document.createElement('div'); meta.className='message-meta'; meta.textContent = (formatTime(m.timestamp) + (isSent ? (m.seenAt ? ' ‚úì‚úì' : ' ‚úì') : ''));
      contentWrap.appendChild(bubble); contentWrap.appendChild(meta);

      item.appendChild(avatarImg);
      item.appendChild(contentWrap);

      chatMessages.appendChild(item);
    }

    async function ensureChatDoc(chatId, partnerId){ try{ const chatDocRef = doc(db,'artifacts',appId,'public','data','chats',chatId); const snap = await getDoc(chatDocRef); if(!snap.exists()){ await setDoc(chatDocRef, { participants:[currentUser.uid, partnerId], createdAt: serverTimestamp(), lastMessageAt: serverTimestamp() }, { merge:true }); } return true; }catch(e){ console.error('ensureChatDoc failed',e); return false; } }

    async function startListening(){
      if(!currentUser || !partnerId) return;
      chatId = chatIdFor(currentUser.uid, partnerId);
      const messagesRef = collection(db,'artifacts',appId,'public','data','chats',chatId,'messages');
      const q = query(messagesRef, orderBy('timestamp','asc'));

      // Typing listener for partner
      try{
        if(typingUnsub) typingUnsub();
        const partnerTypingRef = doc(db,'artifacts',appId,'public','data','chats',chatId,'typing', partnerId);
        typingUnsub = onSnapshot(partnerTypingRef, (snap)=>{
          const d = snap.data();
          if(d && d.typing && (Date.now() - (d.ts||0) < 5000)){
            partnerStatusEl.textContent = 'Typing...';
          }else{
            const last = partnerProfile && (partnerProfile.lastActive?.toDate ? partnerProfile.lastActive.toDate() : (partnerProfile.lastActive? new Date(partnerProfile.lastActive): null));
            partnerStatusEl.textContent = (partnerProfile && partnerProfile.online) ? 'Online' : (last ? ('Last seen ' + last.toLocaleString()) : 'Offline');
          }
        }, ()=>{});
      }catch(_){ }

      if(unsubscribeMessages) unsubscribeMessages();
      unsubscribeMessages = onSnapshot(q, async (snap)=>{
        clearMessages();
        const docs = snap.docs.map(s=>({ id: s.id, ...s.data() }));
        if(docs.length===0){ messagesLoading.textContent='No messages yet. Say hello!'; }
        else { messagesLoading.style.display='none'; }

        for(const d of docs){
          try{
            if(d.receiverId === currentUser.uid && !d.seenAt){
              const mref = doc(db,'artifacts',appId,'public','data','chats',chatId,'messages', d.id);
              await updateDoc(mref, { seenAt: serverTimestamp() });
            }
          }catch(_){ }
        }

        docs.forEach(d=> renderMessage(d));
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }, (err)=>{ console.error('messages listener',err); showMessage('Failed to load messages','error',4000); });
    }

    attachButton.addEventListener('click', ()=> mediaInput.click());
    mediaInput.addEventListener('change',(e)=>{
      const f = e.target.files && e.target.files[0]; if(!f) return; selectedMediaFile = f; mediaFileName.textContent = f.name; mediaPreview.src = URL.createObjectURL(f); mediaPreviewContainer.style.display='flex';
    });
    removeMediaButton.addEventListener('click', ()=>{ selectedMediaFile = null; mediaInput.value=''; mediaPreview.src=''; mediaPreviewContainer.style.display='none'; mediaFileName.textContent=''; });

    // Typing state
    function handleTypingEvent(){ try{ setTyping(true); clearTimeout(typingTimer); typingTimer = setTimeout(()=> setTyping(false), 1500); }catch(_){}}
    async function setTyping(active){ try{ if(!currentUser || !chatId) return; const myTypingRef = doc(db,'artifacts',appId,'public','data','chats',chatId,'typing', currentUser.uid); await setDoc(myTypingRef, { typing: !!active, ts: Date.now() }, { merge: true }); }catch(_){}}
    messageInput.addEventListener('input', handleTypingEvent);
    window.addEventListener('beforeunload', ()=>{ try{ setTyping(false); }catch(_){ } });

    // Emoji picker
    if(emojiButton){ emojiButton.addEventListener('click', ()=>{ if(emojiPanel) emojiPanel.classList.toggle('is-hidden'); }); }
    if(emojiPanel){ emojiPanel.addEventListener('click', (e)=>{ const btn = e.target.closest('.emoji-btn'); if(!btn) return; const emoji = btn.getAttribute('data-emoji')||''; const start = messageInput.selectionStart||messageInput.value.length; const end = messageInput.selectionEnd||messageInput.value.length; messageInput.value = messageInput.value.slice(0,start) + emoji + messageInput.value.slice(end); messageInput.focus(); handleTypingEvent(); }); }

    backBtn.addEventListener('click', ()=>{ window.history.back(); });
    viewProfileBtn.addEventListener('click', ()=>{ if(partnerId) window.location.href = `/profile.html?userId=${partnerId}`; });

    async function uploadToCloudinary(file){ try{ const fd = new FormData(); fd.append('file', file); fd.append('upload_preset', cloudinaryConfig.uploadPreset); const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/auto/upload`, { method:'POST', body:fd }); const data = await res.json(); if(data && (data.secure_url || data.url)) return { url: data.secure_url || data.url, raw: data }; return null; }catch(e){ console.error('upload failed',e); return null; } }

    sendButton.addEventListener('click', async ()=>{
      if(!currentUser) { showMessage('Please sign in to send messages','warning'); return; }
      const text = (messageInput.value||'').trim(); if(!text && !selectedMediaFile) return; sendButton.disabled = true;
      try{
        await ensureChatDoc(chatIdFor(currentUser.uid, partnerId), partnerId);
        const messagesRef = collection(db,'artifacts',appId,'public','data','chats',chatIdFor(currentUser.uid, partnerId),'messages');
        if(selectedMediaFile){ const up = await uploadToCloudinary(selectedMediaFile); if(!up){ showMessage('Failed to upload media','error'); sendButton.disabled=false; return; } const type = selectedMediaFile.type.startsWith('image/')? 'file' : (selectedMediaFile.type.startsWith('video/')? 'file' : 'audio'); await addDoc(messagesRef, { text: text||'', senderId: currentUser.uid, receiverId: partnerId, timestamp: serverTimestamp(), status: 'sent', chatId: chatIdFor(currentUser.uid, partnerId), type, fileUrl: up.url, fileName: selectedMediaFile.name }); selectedMediaFile = null; mediaPreviewContainer.style.display='none'; mediaInput.value=''; }
        else { await addDoc(messagesRef, { text, senderId: currentUser.uid, receiverId: partnerId, timestamp: serverTimestamp(), status: 'sent', chatId: chatIdFor(currentUser.uid, partnerId), type: 'text' }); }
        messageInput.value='';
      }catch(e){ console.error('send failed',e); showMessage('Failed to send message','error'); }
      sendButton.disabled=false;
    });

    // Init
    function getParam(name){ const sp=new URLSearchParams(window.location.search); return sp.get(name); }
    partnerId = getParam('partnerId');

    onAuthStateChanged(auth, async (user)=>{
      currentUser = user;
      if(user){
        // header profile
        try{ const privateProfileRef = doc(db,'artifacts',appId,'users',user.uid,'profiles','user_profile'); const snap = await getDoc(privateProfileRef); let pdata = snap.exists()? snap.data() : { username: user.displayName || 'User', profilePicId: user.photoURL || null };
          displayProfilePicture(headerProfilePic, headerAvatarIcon, pdata.profilePicId, (pdata.username||'U').charAt(0), 'w_70,h_70,c_fill,g_face,r_max'); headerDisplayName.textContent = pdata.username || user.displayName || 'User'; profileLink.href = `/profile.html?userId=${user.uid}`;
        }catch(e){ console.warn('failed header profile',e); }

        if(!partnerId){ showMessage('No partner specified','error',4000); return; }

        // load partner profile
        try{
          const partnerRef = doc(db,'artifacts',appId,'public','data','users',partnerId);
          const psnap = await getDoc(partnerRef);
          partnerProfile = psnap.exists()? psnap.data() : { username: 'Unknown', profilePicId: null };
          partnerNameEl.textContent = partnerProfile.username || 'User';
          displayProfilePicture(partnerAvatar, null, partnerProfile.profilePicId, (partnerProfile.username||'U').charAt(0), 'w_120,h_120,c_fill,g_face,r_max');
          partnerStatusEl.textContent = partnerProfile.visibility?.lastOnline === false ? 'Offline' : 'Available';
        }catch(e){ console.error('load partner',e); }

        await ensureChatDoc(chatIdFor(currentUser.uid, partnerId), partnerId);
        startListening();
      } else {
        // not signed in - redirect to login
        console.log('no user, redirect to login');
        setTimeout(()=> window.location.href = '/login.html', 800);
      }
    });
  </script>
</body>
</html>
